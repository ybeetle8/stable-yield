# 推荐人质押要求配置 - 使用说明

## 功能概述

新增了一个灵活的推荐人质押要求配置功能，允许管理员动态调整是否要求推荐人必须质押才能被绑定。

### 核心特性

1. **全局开关**：`requireReferrerStaked`（默认 `true`）
   - `true`：推荐人必须持有 > 1 sSYI（严格模式）
   - `false`：推荐人无需质押（宽松模式）

2. **规则快照继承**：用户绑定时的规则永久生效
   - 宽松模式绑定的用户，获得永久豁免权
   - 严格模式绑定的用户，必须保持质押才能推荐他人

---

## 合约修改内容

### 1. 新增状态变量

**文件**：`contracts/SYI-Staking/abstract/StakingBase.sol`

```solidity
// 当前系统配置
bool public requireReferrerStaked;

// 用户绑定时的规则快照
mapping(address => bool) private _userReferralRequirementSnapshot;
```

### 2. 新增管理员函数

```solidity
function setRequireReferrerStaked(bool _required) external onlyOwner
```

**参数**：
- `_required`：`true` = 严格模式，`false` = 宽松模式

**事件**：
```solidity
event ReferrerStakeRequirementUpdated(
    bool oldValue,
    bool newValue,
    uint256 timestamp
);
```

### 3. 修改的核心逻辑

**文件**：`contracts/SYI-Staking/abstract/StakingBase.sol:467-498`

- `lockReferral()` 函数现在调用内部函数 `_validateReferrer()`
- 绑定成功后记录快照：`_userReferralRequirementSnapshot[user] = requireReferrerStaked`

---

## 使用指南

### 管理员操作

#### 1. 查询当前配置

```javascript
const requireStaked = await staking.requireReferrerStaked();
console.log("当前配置:", requireStaked); // true or false
```

#### 2. 切换为宽松模式（允许未质押推荐）

```javascript
// 需要使用 owner 账户调用
const tx = await staking.setRequireReferrerStaked(false);
await tx.wait();
console.log("已切换为宽松模式");
```

#### 3. 切换为严格模式（要求推荐人质押）

```javascript
const tx = await staking.setRequireReferrerStaked(true);
await tx.wait();
console.log("已切换为严格模式");
```

#### 4. 监听配置变更事件

```javascript
staking.on("ReferrerStakeRequirementUpdated", (oldValue, newValue, timestamp) => {
    console.log(`配置变更: ${oldValue} -> ${newValue}`);
    console.log(`时间戳: ${timestamp}`);
});
```

---

## 测试说明

### 运行测试脚本

```bash
# 确保已部署 SYI 系统
npx hardhat run scripts/deploySYI.js --network localhost

# 运行测试
npx hardhat run scripts/testReferrerStakeRequirement.js --network localhost
```

### 测试内容

脚本 `scripts/testReferrerStakeRequirement.js` 包含以下测试场景：

1. ✅ 查询初始配置（应为 `true`）
2. ✅ 管理员切换为宽松模式
3. ✅ 宽松模式下，未质押用户可以被绑定
4. ✅ 用户绑定未质押的推荐人（成功）
5. ✅ 切换回严格模式
6. ✅ 严格模式下，早期绑定的用户仍可推荐（继承豁免权）
7. ✅ 非管理员尝试修改配置（失败）

### 预期输出示例

```
🧪 开始测试推荐人质押要求配置功能...

测试 1: 查询初始配置
✅ 初始配置 requireReferrerStaked: true

测试 2: 管理员切换配置为宽松模式
✅ 事件 ReferrerStakeRequirementUpdated 已发出:
   oldValue: true
   newValue: false

测试 3: 宽松模式下，未质押的 user1 可以被绑定
✅ user1 绑定成功！

测试 4: user2 绑定未质押的 user1
✅ user2 绑定 user1 成功！

测试 5: 切换回严格模式
✅ 当前配置 requireReferrerStaked: true

测试 6: 严格模式下，user3 仍可绑定 user1（继承豁免权）
✅ user3 绑定 user1 成功！
   原因: user1 在宽松模式下绑定，获得永久豁免权

测试 7: 非管理员尝试修改配置
✅ 非管理员修改配置失败（符合预期）
```

---

## 业务场景示例

### 场景 1：项目启动初期

**目标**：快速扩张用户，降低推荐门槛

```javascript
// 设置为宽松模式
await staking.setRequireReferrerStaked(false);

// 此时，任何用户都可以成为推荐人，无需质押
// 用户 A 绑定 rootAddress
// 用户 B 绑定用户 A（即使 A 未质押）
```

### 场景 2：稳定运营期

**目标**：提高推荐门槛，确保推荐人有真实投入

```javascript
// 切换为严格模式
await staking.setRequireReferrerStaked(true);

// 此时，新推荐人必须质押 > 1 SYI
// 但在场景 1 中已绑定的用户 A，仍然可以继续推荐（豁免权）
```

### 场景 3：特殊活动期

**目标**：短期内放松限制，活动结束后恢复

```javascript
// 活动开始：切换为宽松模式
await staking.setRequireReferrerStaked(false);

// ... 活动进行中 ...

// 活动结束：恢复严格模式
await staking.setRequireReferrerStaked(true);
```

---

## 重要注意事项

### 1. 规则不可篡改性

⚠️ 用户绑定时的规则快照是永久的，无法修改。

**示例**：
- 用户在宽松模式下绑定 → 永久获得豁免权
- 用户在严格模式下绑定 → 永久受质押要求约束

### 2. 豁免权传递

✅ 在宽松模式下绑定的用户，其推荐能力不受后续规则变更影响。

**示例**：
```
宽松模式: user1 绑定 rootAddress（user1 未质押）
严格模式: user2 仍可绑定 user1（继承豁免权）
严格模式: user3 仍可绑定 user2（继承豁免权）
```

### 3. rootAddress 特殊处理

🔒 `rootAddress` 永远不受质押要求限制。

### 4. 权限控制

🛡️ 只有合约 `owner` 可以调用 `setRequireReferrerStaked()`。

### 5. Gas 成本

⚠️ 每次 `lockReferral()` 额外消耗约 20,000 gas（保存快照）。

---

## 前端集成建议

### 1. 显示当前规则

```javascript
const requireStaked = await staking.requireReferrerStaked();

if (requireStaked) {
    showMessage("推荐人必须质押 > 1 SYI 才能被绑定");
} else {
    showMessage("推荐人无需质押即可被绑定");
}
```

### 2. 验证推荐人资格（前置检查）

```javascript
async function canBeReferrer(address) {
    const requireStaked = await staking.requireReferrerStaked();

    if (!requireStaked) {
        return { valid: true };
    }

    const balance = await staking.balanceOf(address);
    const hasLocked = await staking.isBindReferral(address);

    if (balance > ethers.parseEther("1")) {
        return { valid: true };
    }

    // 检查是否有豁免权
    if (hasLocked) {
        // 需要合约提供查询接口（可选实现）
        // const snapshot = await staking.getUserReferralRequirement(address);
        // return { valid: !snapshot.wasRequired };

        // 简化方案：直接尝试绑定，让合约判断
        return { valid: true, warning: "推荐人质押较低，请确认" };
    }

    return {
        valid: false,
        error: "推荐人需要质押 > 1 SYI"
    };
}
```

### 3. 监听配置变更

```javascript
// 实时更新 UI 显示
staking.on("ReferrerStakeRequirementUpdated", (oldValue, newValue) => {
    updateReferralRuleDisplay(newValue);
    showNotification(`推荐规则已更新: ${newValue ? "严格模式" : "宽松模式"}`);
});
```

---

## 部署检查清单

在部署到主网之前，请确认：

- [ ] 合约编译无错误
- [ ] 测试脚本全部通过
- [ ] 初始配置为 `true`（严格模式）
- [ ] `onlyOwner` 权限正确配置
- [ ] 事件日志正常发出
- [ ] 前端已适配新功能
- [ ] 已通过安全审计
- [ ] 已准备公告说明规则变更机制

---

## 常见问题（FAQ）

### Q1: 修改配置会影响已绑定的推荐关系吗？

**A**: 不会。已绑定的关系保持不变，只影响未来的新绑定。

### Q2: 宽松模式下绑定的用户，在严格模式下还能推荐吗？

**A**: 可以。他们获得永久豁免权。

### Q3: 如果推荐人在严格模式下绑定，后来解除质押怎么办？

**A**: 他们将无法再被新用户绑定（因为不满足质押要求）。

### Q4: 可以查询用户绑定时的规则快照吗？

**A**: 当前版本未提供公开查询接口，但可以通过合约内部映射实现（见方案文档）。

### Q5: rootAddress 会受限制吗？

**A**: 不会。`rootAddress` 永远是合法推荐人。

---

## 技术支持

如有疑问，请参考：
- 详细技术方案：`notes/推荐人质押要求灵活配置方案.md`
- 测试脚本：`scripts/testReferrerStakeRequirement.js`
- 合约代码：`contracts/SYI-Staking/abstract/StakingBase.sol`

---

**文档版本**: v1.0
**更新日期**: 2025-10-20
**作者**: SYI Protocol Team
