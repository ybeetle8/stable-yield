# 推荐人质押要求配置 - 快速参考

## 🎯 一句话总结

管理员可动态配置是否要求推荐人必须质押，已绑定用户的规则永久生效。

---

## 📋 快速命令

### 查询当前配置

```javascript
const config = await staking.requireReferrerStaked();
// true = 严格模式（推荐人需质押 > 1 SYI）
// false = 宽松模式（推荐人无需质押）
```

### 切换模式（仅 owner）

```javascript
// 切换为宽松模式
await staking.setRequireReferrerStaked(false);

// 切换为严格模式
await staking.setRequireReferrerStaked(true);
```

---

## 🔑 核心逻辑

### 验证规则

```
if (推荐人 == rootAddress) {
    ✅ 永远允许
} else if (系统 == 宽松模式) {
    ✅ 允许（无需质押）
} else {
    // 系统 == 严格模式
    if (推荐人已绑定) {
        if (推荐人绑定时 == 宽松模式) {
            ✅ 允许（豁免权）
        } else {
            检查推荐人质押 > 1 SYI
        }
    } else {
        检查推荐人质押 > 1 SYI
    }
}
```

### 快照继承

- 用户绑定时，记录当前系统配置
- 该配置永久生效，不受后续变更影响
- 宽松模式绑定 → 永久豁免权
- 严格模式绑定 → 必须保持质押

---

## 🧪 测试

### 运行测试

```bash
# 核心逻辑测试（推荐）
npx hardhat run scripts/debugValidateReferrer.js --network localhost

# 权限测试
npx hardhat run scripts/testOwnerPermission.js --network localhost

# 完整测试（需全新部署）
npx hardhat run scripts/testReferrerStakeRequirement_v2.js --network localhost
```

### 测试账户

```javascript
accounts[0] = deployer (owner)
accounts[1] = feeRecipientWallet
accounts[2] = rootWallet (rootAddress)
accounts[3+] = 测试用户
```

---

## 💼 业务场景

| 阶段 | 配置 | 原因 |
|------|------|------|
| 启动期 | 宽松模式 | 快速扩张，降低门槛 |
| 稳定期 | 严格模式 | 提高质量，确保投入 |
| 活动期 | 临时宽松 | 特殊活动，提升参与 |

---

## ⚠️ 重要提示

1. **只有 owner 可以修改配置**
2. **已绑定用户不受新规则影响**
3. **宽松模式绑定的用户获得永久豁免**
4. **rootAddress 永远不受限制**
5. **测试需在全新部署上运行以获得完整结果**

---

## 📁 文件位置

| 文件 | 说明 |
|------|------|
| `contracts/SYI-Staking/abstract/StakingBase.sol` | 核心实现 |
| `scripts/debugValidateReferrer.js` | 核心逻辑测试 ✅ |
| `scripts/testOwnerPermission.js` | 权限测试 ✅ |
| `notes/推荐人质押要求灵活配置方案.md` | 详细方案 |
| `notes/推荐人质押要求配置-使用说明.md` | 使用指南 |
| `notes/推荐人质押要求配置-实施完成报告.md` | 完成报告 |

---

## 🔧 故障排查

### 问题：测试失败

**解决**：
1. 检查是否使用全新部署的合约
2. 确认测试账户未被占用
3. 重启测试网络后重新部署

### 问题：非 owner 修改配置成功

**检查**：
1. 确认测试代码中有 `await tx.wait()`
2. 确认使用正确的账户（deployer 是 owner）
3. 查看合约 owner：`await staking.owner()`

### 问题：豁免权不生效

**原因**：
- 用户在严格模式下绑定，且质押已归零

**解决**：
- 检查用户绑定时的快照（需添加查询接口）
- 或查看绑定时的事件日志

---

**版本**: v1.0
**日期**: 2025-10-20
