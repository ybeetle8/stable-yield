# è´¨æŠ¼ç³»ç»Ÿå…¨å±€ä¾›åº”é‡ç®¡ç†

## æ¦‚è¿°

æœ¬æ–‡æ¡£è¯´æ˜ SYI è´¨æŠ¼åˆçº¦ä¸­å…³äºå…¨å±€è´¨æŠ¼æ€»æ•°ï¼ˆtotalSupplyï¼‰çš„æ§åˆ¶æœºåˆ¶å’Œç®¡ç†åŠŸèƒ½ã€‚

---

## ä¸€ã€å…¨å±€è´¨æŠ¼æ€»æ•°è¿½è¸ª

### 1.1 æ ¸å¿ƒå˜é‡ï¼š`totalSupply`

**ä½ç½®**ï¼š`StakingBase.sol:105`

```solidity
uint256 public totalSupply;
```

**è¯´æ˜**ï¼š
- è®°å½•æ‰€æœ‰ç”¨æˆ·è´¨æŠ¼çš„ sSYI ä»£å¸æ€»é‡
- ä¸å®é™…è´¨æŠ¼çš„ SYI ä»£å¸ 1:1 å¯¹åº”
- å…¬å¼€å¯è¯»ï¼Œä»»ä½•äººéƒ½å¯ä»¥æŸ¥è¯¢

### 1.2 ä¾›åº”é‡ä¿®æ”¹æœºåˆ¶

ä¾›åº”é‡é€šè¿‡ `_update` å†…éƒ¨å‡½æ•°ä¿®æ”¹ï¼ˆ`StakingBase.sol:1060-1076`ï¼‰ï¼š

```solidity
function _update(address from, address to, uint256 value) internal {
    if (from == address(0)) {
        // é“¸é€ ï¼šå¢åŠ ä¾›åº”é‡
        balances[to] += value;
        totalSupply += value;
        emit Transfer(address(0), to, value);
        return;
    }

    if (to == address(0)) {
        // é”€æ¯ï¼šå‡å°‘ä¾›åº”é‡
        balances[from] -= value;
        totalSupply -= value;
        emit Transfer(from, address(0), value);
        return;
    }

    revert("Transfers between users not supported");
}
```

**ç‰¹ç‚¹**ï¼š
- åªæ”¯æŒé“¸é€ ï¼ˆmintï¼‰å’Œé”€æ¯ï¼ˆburnï¼‰æ“ä½œ
- ä¸æ”¯æŒç”¨æˆ·ä¹‹é—´çš„è½¬è´¦
- ç¡®ä¿ sSYI ä»£å¸åªèƒ½é€šè¿‡è´¨æŠ¼äº§ç”Ÿï¼Œè§£é™¤è´¨æŠ¼æ—¶é”€æ¯

### 1.3 ä¾›åº”é‡å˜åŒ–çš„è§¦å‘ç‚¹

#### âœ… å¢åŠ ä¾›åº”é‡ï¼ˆè´¨æŠ¼æ—¶ï¼‰

**ä½ç½®**ï¼š`StakingBase.sol:1166`

```solidity
function _mintStakeRecord(...) private {
    // ... å…¶ä»–é€»è¾‘
    _update(address(0), sender, _amount);  // é“¸é€  sSYI
    // ...
}
```

**è§¦å‘æ¡ä»¶**ï¼š
- ç”¨æˆ·è°ƒç”¨ `stake()` å‡½æ•°æˆåŠŸè´¨æŠ¼ SYI
- åˆçº¦ä¸ºç”¨æˆ·é“¸é€ ç­‰é‡çš„ sSYI ä»£å¸
- totalSupply è‡ªåŠ¨å¢åŠ 

#### âœ… å‡å°‘ä¾›åº”é‡ï¼ˆè§£é™¤è´¨æŠ¼æ—¶ï¼‰

**ä½ç½®**ï¼š`StakingBase.sol:1194`

```solidity
function _burn(uint256 index) private returns (uint256 reward, uint256 amount) {
    // ... éªŒè¯é€»è¾‘
    _update(sender, address(0), amount);  // é”€æ¯ sSYI
    // ...
}
```

**è§¦å‘æ¡ä»¶**ï¼š
- ç”¨æˆ·è°ƒç”¨ `unstake()` å‡½æ•°è§£é™¤è´¨æŠ¼
- åˆçº¦é”€æ¯ç”¨æˆ·çš„ sSYI ä»£å¸
- totalSupply è‡ªåŠ¨å‡å°‘

---

## äºŒã€æ‰‹åŠ¨å¢åŠ ä¾›åº”é‡çš„åŠŸèƒ½

### 2.1 ç»“è®ºï¼šâŒ ä¸å­˜åœ¨

**åˆ†æç»“æœ**ï¼š
- **æ²¡æœ‰** `mint()` å‡½æ•°ä¾›ç®¡ç†å‘˜ç›´æ¥é“¸é€ ä»£å¸
- **æ²¡æœ‰** `increaseSupply()` æˆ–ç±»ä¼¼çš„ç®¡ç†å‘˜å‡½æ•°
- **æ²¡æœ‰** ä»»ä½•æ‰‹åŠ¨ä¿®æ”¹ `totalSupply` çš„åé—¨

### 2.2 è®¾è®¡åŸå› 

è¿™æ˜¯ä¸€ä¸ª **å®‰å…¨ä¸”åˆç†** çš„è®¾è®¡ï¼š

1. **1:1 å¯¹åº”åŸåˆ™**
   - sSYI ä»£å¸å¿…é¡»ä¸å®é™…è´¨æŠ¼çš„ SYI 1:1 å¯¹åº”
   - é˜²æ­¢å‡­ç©ºå¢å‘å¯¼è‡´çš„ä¼šè®¡é”™è¯¯

2. **é˜²æ­¢æ»¥ç”¨**
   - é¿å…ç®¡ç†å‘˜æ¶æ„å¢å‘ä»£å¸
   - ç¡®ä¿ä¾›åº”é‡å®Œå…¨ç”±ç”¨æˆ·è´¨æŠ¼è¡Œä¸ºå†³å®š

3. **é€æ˜æ€§**
   - ä¾›åº”é‡å˜åŒ–å®Œå…¨å¯è¿½æº¯
   - æ¯æ¬¡å¢å‡éƒ½ä¼šè§¦å‘ `Transfer` äº‹ä»¶

---

## ä¸‰ã€ä¾›åº”é‡ç›‘æ§ä¸é™åˆ¶æœºåˆ¶

### 3.1 å†å²ä¾›åº”é‡è®°å½•

**å˜é‡**ï¼š`t_supply`ï¼ˆ`StakingBase.sol:112`ï¼‰

```solidity
IStaking.RecordTT[] public t_supply;

struct RecordTT {
    uint40 stakeTime;    // æ—¶é—´æˆ³
    uint160 tamount;     // å½“æ—¶çš„ totalSupply
}
```

**ç”¨é€”**ï¼š
- è®°å½•æ¯æ¬¡è´¨æŠ¼æ—¶çš„ä¾›åº”é‡å¿«ç…§
- ç”¨äºè®¡ç®—ç½‘ç»œæµå…¥é€Ÿåº¦

### 3.2 ç½‘ç»œæµå…¥é€Ÿåº¦è®¡ç®—

**å‡½æ•°**ï¼š`getRecentNetworkInflow()`ï¼ˆ`StakingBase.sol:992-1017`ï¼‰

```solidity
function getRecentNetworkInflow() public view returns (uint256 recentInflow) {
    uint256 cutoffTime = block.timestamp - NETWORK_CHECK_INTERVAL;  // 1åˆ†é’Ÿå‰
    // ... è®¡ç®—æœ€è¿‘1åˆ†é’Ÿçš„æµå…¥é‡
    return totalSupply - previousTotalSupply;
}
```

**ä½œç”¨**ï¼š
- ç»Ÿè®¡æœ€è¿‘ 1 åˆ†é’Ÿå†…çš„å‡€æµå…¥é‡
- ç”¨äºåŠ¨æ€è°ƒæ•´è´¨æŠ¼é™é¢

### 3.3 è´¨æŠ¼é™é¢æ§åˆ¶

**å‡½æ•°**ï¼š`maxStakeAmount()`ï¼ˆ`StakingBase.sol:1019-1030`ï¼‰

```solidity
function maxStakeAmount() public view returns (uint256 maxAmount) {
    uint256 recentInflow = getRecentNetworkInflow();
    uint112 poolReserveUsdt = SYI.getUSDTReserve();
    uint256 onePercentOfPool = poolReserveUsdt / 100;

    if (recentInflow > onePercentOfPool) {
        return 0;  // æµå…¥è¿‡å¿«æ—¶æš‚åœè´¨æŠ¼
    } else {
        uint256 availableCapacity = onePercentOfPool - recentInflow;
        return _min256(availableCapacity, MAX_STAKE_LIMIT);  // æœ€å¤š1000 SYI
    }
}
```

**é€»è¾‘**ï¼š
1. è®¡ç®—æµåŠ¨æ€§æ±  USDT å‚¨å¤‡çš„ 1%
2. å¦‚æœæœ€è¿‘æµå…¥ > 1% å‚¨å¤‡ï¼Œåˆ™æš‚åœè´¨æŠ¼
3. å¦åˆ™é™åˆ¶å•æ¬¡è´¨æŠ¼ä¸è¶…è¿‡ `min(å‰©ä½™å®¹é‡, 1000 SYI)`

**ç›®çš„**ï¼š
- é˜²æ­¢çŸ­æ—¶é—´å†…å¤§é‡è´¨æŠ¼å†²å‡»ä»·æ ¼
- ä¿æŠ¤æµåŠ¨æ€§æ± ç¨³å®šæ€§

### 3.4 ç”¨æˆ·æ€»è´¨æŠ¼é™é¢

**å¸¸é‡**ï¼š`MAX_USER_TOTAL_STAKE`ï¼ˆ`StakingBase.sol:61`ï¼‰

```solidity
uint256 internal constant MAX_USER_TOTAL_STAKE = 10000 ether;  // å•ç”¨æˆ·ç´¯è®¡é™é¢
```

**éªŒè¯**ï¼š`_validateStakeParameters()`ï¼ˆ`StakingBase.sol:1478-1489`ï¼‰

```solidity
function _validateStakeParameters(uint160 _amount, uint8 _stakeIndex) private view {
    uint256 userCurrentTotal = principalBalance(msg.sender);
    if (userCurrentTotal + _amount > MAX_USER_TOTAL_STAKE) {
        revert ExceedsUserTotalStakeLimit();
    }
}
```

**é™åˆ¶**ï¼š
- å•ä¸ªç”¨æˆ·ç´¯è®¡è´¨æŠ¼ä¸è¶…è¿‡ 10,000 SYI
- å¤šæ¬¡è´¨æŠ¼ç´¯è®¡è®¡ç®—

---

## å››ã€ç®¡ç†å‘˜æƒé™

### 4.1 ç´§æ€¥æå–åŠŸèƒ½

**å‡½æ•°**ï¼š`emergencyWithdrawSYI` / `emergencyWithdrawUSDT`ï¼ˆ`StakingBase.sol:1724-1736`ï¼‰

```solidity
function emergencyWithdrawSYI(address to, uint256 _amount) external onlyOwner {
    SYI.transfer(to, _amount);
}

function emergencyWithdrawUSDT(address to, uint256 _amount) external onlyOwner {
    IERC20(USDT).transfer(to, _amount);
}
```

**æ³¨æ„**ï¼š
- âš ï¸ è¿™äº›å‡½æ•°åªèƒ½æå–ä»£å¸ä½™é¢
- âš ï¸ **ä¸ä¼šä¿®æ”¹** `totalSupply` æˆ–ç”¨æˆ·çš„è´¨æŠ¼è®°å½•
- ç”¨äºç´§æ€¥æƒ…å†µä¸‹è½¬ç§»åˆçº¦ä¸­çš„å‰©ä½™ä»£å¸

### 4.2 è®¾ç½® SYI ä»£å¸åœ°å€

**å‡½æ•°**ï¼š`setSYI()`ï¼ˆ`StakingBase.sol:1717-1722`ï¼‰

```solidity
function setSYI(address _syi) external onlyOwner {
    require(_syi != address(0), "SYI address cannot be zero");
    SYI = ISYI(_syi);
    SYI.approve(address(ROUTER), type(uint256).max);
    emit SYIContractSet(_syi);
}
```

**ç”¨é€”**ï¼š
- åˆå§‹åŒ–æˆ–æ›´æ–° SYI ä»£å¸åˆçº¦åœ°å€
- ä¸å½±å“ä¾›åº”é‡

---

## äº”ã€æ€»ç»“

### 5.1 æ ¸å¿ƒå‘ç°

| åŠŸèƒ½ | æ˜¯å¦å­˜åœ¨ | è¯´æ˜ |
|------|---------|------|
| è¿½è¸ªå…¨å±€è´¨æŠ¼æ€»æ•° | âœ… æ˜¯ | `totalSupply` å˜é‡ |
| æ‰‹åŠ¨å¢åŠ ä¾›åº”é‡ | âŒ å¦ | ä»…é€šè¿‡æ­£å¸¸è´¨æŠ¼å¢åŠ  |
| æ‰‹åŠ¨å‡å°‘ä¾›åº”é‡ | âŒ å¦ | ä»…é€šè¿‡è§£é™¤è´¨æŠ¼å‡å°‘ |
| ä¾›åº”é‡å†å²è®°å½• | âœ… æ˜¯ | `t_supply` æ•°ç»„ |
| æµå…¥é€Ÿåº¦ç›‘æ§ | âœ… æ˜¯ | `getRecentNetworkInflow()` |
| åŠ¨æ€è´¨æŠ¼é™é¢ | âœ… æ˜¯ | `maxStakeAmount()` |
| ç”¨æˆ·ç´¯è®¡é™é¢ | âœ… æ˜¯ | `MAX_USER_TOTAL_STAKE` (10,000) |

### 5.2 å®‰å…¨æ€§è¯„ä¼°

**ä¼˜ç‚¹**ï¼š
- âœ… ä¾›åº”é‡å®Œå…¨ç”±ç”¨æˆ·è¡Œä¸ºå†³å®šï¼Œæ— æ³•äººä¸ºæ“æ§
- âœ… sSYI ä¸ SYI ä¸¥æ ¼ 1:1 å¯¹åº”
- âœ… å¤šå±‚é™é¢æœºåˆ¶é˜²æ­¢æ¶æ„è¡Œä¸º
- âœ… å†å²è®°å½•å¯è¿½æº¯

**æ½œåœ¨é£é™©**ï¼š
- âš ï¸ `emergencyWithdrawSYI` å¯èƒ½ç ´åä¾›åº”å¹³è¡¡ï¼ˆå¦‚æœæ»¥ç”¨ï¼‰
- âš ï¸ ä½†ä¸ä¼šå½±å“ `totalSupply` çš„å‡†ç¡®æ€§

### 5.3 ä¸ OLA ç³»ç»Ÿçš„å¯¹æ¯”

ä¸åŸ OLA è´¨æŠ¼ç³»ç»Ÿçš„ä¸»è¦åŒºåˆ«ï¼š

| ç‰¹æ€§ | OLA Staking | SYI Staking |
|------|-------------|-------------|
| ä¹°å–ç¨ | âœ… 3% | âŒ æ—  |
| ç›ˆåˆ©ç¨ | âœ… 25% | âŒ æ—  |
| LPè´¨æŠ¼ | âœ… æœ‰ | âŒ ç§»é™¤ |
| éšæ—¶æå–æ”¶ç›Š | âŒ åˆ°æœŸæå– | âœ… æ”¯æŒ `withdrawInterest()` |
| æ‰‹åŠ¨å¢å‘ | âŒ æ—  | âŒ æ—  |
| é»‘ç™½åå• | âœ… æœ‰ | âŒ ç§»é™¤ï¼ˆå‡†å¤‡ä¸Šäº¤æ˜“æ‰€ï¼‰|

---

## å…­ã€ç›¸å…³ä»£ç ä½ç½®

| åŠŸèƒ½ | æ–‡ä»¶ | è¡Œå· |
|------|------|------|
| totalSupply å®šä¹‰ | StakingBase.sol | 105 |
| _update å‡½æ•° | StakingBase.sol | 1060-1076 |
| è´¨æŠ¼é“¸é€  | StakingBase.sol | 1166 |
| è§£é™¤è´¨æŠ¼é”€æ¯ | StakingBase.sol | 1194 |
| å†å²è®°å½• | StakingBase.sol | 112, 1144-1147 |
| æµå…¥é€Ÿåº¦è®¡ç®— | StakingBase.sol | 992-1017 |
| è´¨æŠ¼é™é¢ | StakingBase.sol | 1019-1030 |
| ç´§æ€¥æå– | StakingBase.sol | 1724-1736 |

---

## ä¸ƒã€æŸ¥è¯¢ä¾›åº”é‡çš„æ–¹æ³•

### 7.1 é“¾ä¸ŠæŸ¥è¯¢

```javascript
// ä½¿ç”¨ ethers.js
const staking = await ethers.getContractAt("Staking", stakingAddress);

// æŸ¥è¯¢å½“å‰æ€»ä¾›åº”é‡
const totalSupply = await staking.totalSupply();
console.log("Total sSYI Supply:", ethers.formatEther(totalSupply));

// æŸ¥è¯¢æœ€è¿‘æµå…¥é‡
const recentInflow = await staking.getRecentNetworkInflow();
console.log("Recent Inflow (1min):", ethers.formatEther(recentInflow));

// æŸ¥è¯¢å½“å‰è´¨æŠ¼é™é¢
const maxStake = await staking.maxStakeAmount();
console.log("Max Stake Amount:", ethers.formatEther(maxStake));
```

### 7.2 æŸ¥è¯¢ç”¨æˆ·ä½™é¢

```javascript
// æŸ¥è¯¢ç”¨æˆ·çš„ sSYI ä½™é¢ï¼ˆå½“å‰ä»·å€¼ï¼ŒåŒ…å«æ”¶ç›Šï¼‰
const balance = await staking.balanceOf(userAddress);
console.log("User Balance:", ethers.formatEther(balance));

// æŸ¥è¯¢ç”¨æˆ·çš„æœ¬é‡‘ï¼ˆä¸å«æ”¶ç›Šï¼‰
const principal = await staking.principalBalance(userAddress);
console.log("User Principal:", ethers.formatEther(principal));

// æŸ¥è¯¢ç”¨æˆ·çš„ç´¯è®¡æ”¶ç›Š
const interest = await staking.earnedInterest(userAddress);
console.log("User Interest:", ethers.formatEther(interest));
```

---

## å…«ã€å»ºè®®

### 8.1 ç›‘æ§å»ºè®®

å»ºè®®åœ¨å‰ç«¯æˆ–åå°ç›‘æ§ä»¥ä¸‹æŒ‡æ ‡ï¼š

1. **totalSupply è¶‹åŠ¿**ï¼šç›‘æ§ä¾›åº”é‡å¢é•¿é€Ÿåº¦
2. **recentInflow**ï¼šç›‘æ§çŸ­æœŸæµå…¥å¼‚å¸¸
3. **maxStakeAmount**ï¼šæé†’ç”¨æˆ·å½“å‰å¯è´¨æŠ¼é¢åº¦
4. **ç”¨æˆ·ä½™é¢åˆ†å¸ƒ**ï¼šç»Ÿè®¡å¤§æˆ·å’Œå°æˆ·æ¯”ä¾‹

### 8.2 é£é™©æç¤º

å¯¹äºç®¡ç†å‘˜ï¼š
- âš ï¸ è°¨æ…ä½¿ç”¨ `emergencyWithdrawSYI`
- âš ï¸ å¦‚æœæå–äº†è¿‡å¤š SYIï¼Œå¯èƒ½å¯¼è‡´ç”¨æˆ·æ— æ³•æ­£å¸¸è§£é™¤è´¨æŠ¼
- âš ï¸ å»ºè®®åªåœ¨ç´§æ€¥æƒ…å†µä¸‹ä½¿ç”¨ï¼Œå¹¶ç¡®ä¿ä¸å½±å“ç”¨æˆ·æƒç›Š

---

## ç»“è®º

**SYI è´¨æŠ¼ç³»ç»Ÿä¸æ”¯æŒæ‰‹åŠ¨å¢åŠ å…¨å±€ä¾›åº”é‡**ï¼Œè¿™æ˜¯ä¸€ä¸ªå®‰å…¨ä¸”åˆç†çš„è®¾è®¡ã€‚æ‰€æœ‰ä¾›åº”é‡å˜åŒ–éƒ½å¿…é¡»é€šè¿‡æ­£å¸¸çš„è´¨æŠ¼/è§£é™¤è´¨æŠ¼æµç¨‹ï¼Œç¡®ä¿äº†ç³»ç»Ÿçš„é€æ˜æ€§å’Œå¯ä¿¡åº¦ã€‚

---

## é™„å½•ï¼šå…¨å±€è´¨æŠ¼æ€»é‡æ§åˆ¶æœºåˆ¶ç®€æ˜è¯´æ˜

### âœ… æ˜¯çš„ï¼ŒæŒ‰æ¯åˆ†é’Ÿè®¡ç®—ï¼

**æ§åˆ¶åŸç†**ï¼š

```
æ¯æ¬¡ç”¨æˆ·è´¨æŠ¼å‰ï¼Œç³»ç»Ÿä¼šæ£€æŸ¥ï¼š

1ï¸âƒ£ æŸ¥è¯¢ SYI/USDT æµåŠ¨æ€§æ± çš„ USDT å‚¨å¤‡é‡
2ï¸âƒ£ è®¡ç®— 1% ä½œä¸ºå®‰å…¨é˜ˆå€¼
3ï¸âƒ£ ç»Ÿè®¡æœ€è¿‘ 1 åˆ†é’Ÿå†…çš„è´¨æŠ¼æµå…¥é‡
4ï¸âƒ£ åˆ¤æ–­ï¼š
   - å¦‚æœ æµå…¥é‡ > 1% å‚¨å¤‡  â†’  æš‚åœè´¨æŠ¼ï¼ˆè¿”å› 0ï¼‰
   - å¦åˆ™  â†’  å…è®¸è´¨æŠ¼ï¼Œä½†é™åˆ¶å•æ¬¡ä¸è¶…è¿‡ min(å‰©ä½™å®¹é‡, 1000 SYI)
```

### ğŸ¯ å…·ä½“ä¾‹å­

å‡è®¾å½“å‰æµåŠ¨æ€§æ± æœ‰ **100,000 USDT**ï¼š

| æœ€è¿‘1åˆ†é’Ÿæµå…¥ | 1%é˜ˆå€¼ | æ˜¯å¦å…è®¸è´¨æŠ¼ | å•æ¬¡æœ€å¤§é¢åº¦ |
|-------------|-------|------------|------------|
| 0 SYI | 1,000 USDT | âœ… å…è®¸ | 1,000 SYI |
| 500 SYI | 1,000 USDT | âœ… å…è®¸ | 500 SYI (å‰©ä½™å®¹é‡) |
| 1,000 SYI | 1,000 USDT | âœ… å…è®¸ | 1,000 SYI (è¾¹ç•Œå€¼) |
| 1,200 SYI | 1,000 USDT | âŒ **æš‚åœ** | 0 SYI (è¶…é™) |

### ğŸ“ å…³é”®ä»£ç 

**ä½ç½®**ï¼š`StakingBase.sol:1019-1030`

```solidity
function maxStakeAmount() public view returns (uint256 maxAmount) {
    uint256 recentInflow = getRecentNetworkInflow();  // æœ€è¿‘1åˆ†é’Ÿæµå…¥
    uint112 poolReserveUsdt = SYI.getUSDTReserve();   // æ± å­USDTå‚¨å¤‡
    uint256 onePercentOfPool = poolReserveUsdt / 100; // 1%é˜ˆå€¼

    if (recentInflow > onePercentOfPool) {
        return 0;  // âŒ æš‚åœè´¨æŠ¼
    } else {
        uint256 availableCapacity = onePercentOfPool - recentInflow;
        return _min256(availableCapacity, MAX_STAKE_LIMIT);  // æœ€å¤š1000 SYI
    }
}
```

### ğŸ­ è®¾è®¡ç›®çš„

1. **é˜²æ­¢ä»·æ ¼å†²å‡»**ï¼šé™åˆ¶çŸ­æ—¶é—´å†…å¤§é‡ä¹°å…¥ SYIï¼ˆè´¨æŠ¼æ—¶éœ€è¦ä¹° SYIï¼‰
2. **ä¿æŠ¤æµåŠ¨æ€§**ï¼šç¡®ä¿æ± å­æ·±åº¦ä¸è¢«å¿«é€Ÿæ¶ˆè€—
3. **åŠ¨æ€è°ƒæ•´**ï¼šæµå…¥é‡æ¯åˆ†é’Ÿæ›´æ–°ï¼Œå†·å´åè‡ªåŠ¨æ¢å¤

### âš ï¸ æ³¨æ„äº‹é¡¹

- æ—¶é—´çª—å£ï¼š**1 åˆ†é’Ÿ**ï¼ˆ`NETWORK_CHECK_INTERVAL = 1 minutes`ï¼‰
- å¦‚æœè¢«é™åˆ¶ï¼šç­‰å¾… 1 åˆ†é’Ÿåï¼Œé™é¢ä¼šè‡ªåŠ¨æ¢å¤
- å³ä½¿å…¨å±€æœ‰é™åˆ¶ï¼Œå•ç”¨æˆ·ç´¯è®¡ä»ä¸èƒ½è¶…è¿‡ **10,000 SYI**

---

## é™„å½•2ï¼šå‰ç«¯æ˜¾ç¤ºå•ç¬”é™é¢çš„å®Œæ•´é€»è¾‘

### ğŸ¨ å‰ç«¯éœ€è¦å±•ç¤ºçš„é™é¢

ç”¨æˆ·å•ç¬”è´¨æŠ¼é™é¢åº”è¯¥å–ä»¥ä¸‹**4ä¸ªå€¼çš„æœ€å°å€¼**ï¼š

```javascript
// 1ï¸âƒ£ å…¨å±€é™é¢ï¼ˆå·²è‡ªåŠ¨è€ƒè™‘1%é˜ˆå€¼å’Œ1åˆ†é’Ÿæµå…¥ï¼‰
const globalMaxAmount = await staking.maxStakeAmount();

// 2ï¸âƒ£ ç”¨æˆ·å‰©ä½™é¢åº¦ï¼ˆå•ç”¨æˆ·ç´¯è®¡ä¸Šé™10,000 SYIï¼‰
const userRemaining = await staking.getRemainingStakeCapacity(userAddress);

// 3ï¸âƒ£ ç”¨æˆ·é’±åŒ… USDT ä½™é¢
const usdtBalance = await usdt.balanceOf(userAddress);

// 4ï¸âƒ£ ç”¨æˆ·é’±åŒ… USDT æˆæƒé¢åº¦ï¼ˆç»™ Staking åˆçº¦ï¼‰
const usdtAllowance = await usdt.allowance(userAddress, stakingAddress);

// ğŸ¯ æœ€ç»ˆæ˜¾ç¤ºçš„å•ç¬”é™é¢
const finalMaxAmount = Math.min(
    globalMaxAmount,
    userRemaining,
    usdtBalance,
    usdtAllowance
);
```

### ğŸ“Š æ¨èçš„å‰ç«¯å±•ç¤ºæ–¹æ¡ˆ

**æ–¹æ¡ˆ1ï¼šç®€æ´ç‰ˆï¼ˆåªæ˜¾ç¤ºæœ€ç»ˆé™é¢ï¼‰**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å•ç¬”æœ€å¤§è´¨æŠ¼é¢                    â”‚
â”‚ 500 SYI                         â”‚
â”‚                                 â”‚
â”‚ [è¾“å…¥é‡‘é¢]  [æœ€å¤§]               â”‚
â”‚                                 â”‚
â”‚ [è´¨æŠ¼]                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ–¹æ¡ˆ2ï¼šè¯¦ç»†ç‰ˆï¼ˆæ˜¾ç¤ºé™åˆ¶åŸå› ï¼‰**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å•ç¬”æœ€å¤§è´¨æŠ¼é¢: 500 SYI                  â”‚
â”‚                                         â”‚
â”‚ é™åˆ¶è¯¦æƒ…ï¼š                               â”‚
â”‚ â€¢ å…¨å±€é™é¢: 500 SYI âš ï¸ (æœ€è¿‘æµå…¥è¾ƒå¤š)    â”‚
â”‚ â€¢ æ‚¨çš„å‰©ä½™é¢åº¦: 8,000 SYI âœ…             â”‚
â”‚ â€¢ é’±åŒ…ä½™é¢: 1,000 USDT âœ…                â”‚
â”‚                                         â”‚
â”‚ [è¾“å…¥é‡‘é¢]  [æœ€å¤§]                       â”‚
â”‚                                         â”‚
â”‚ [è´¨æŠ¼]                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ–¹æ¡ˆ3ï¼šåŠ¨æ€æç¤ºç‰ˆï¼ˆå½“é™é¢å˜åŒ–æ—¶æç¤ºï¼‰**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å•ç¬”æœ€å¤§è´¨æŠ¼é¢: 0 SYI âŒ                 â”‚
â”‚                                         â”‚
â”‚ âš ï¸ å½“å‰ç½‘ç»œè´¨æŠ¼æµå…¥è¿‡å¿«ï¼Œæš‚æ—¶é™åˆ¶è´¨æŠ¼      â”‚
â”‚ é¢„è®¡ 42 ç§’åæ¢å¤æ­£å¸¸                     â”‚
â”‚                                         â”‚
â”‚ [åˆ·æ–°é™é¢]                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ”„ å®æ—¶æ›´æ–°å»ºè®®

**æ¨èåšæ³•**ï¼š

1. **é¡µé¢åŠ è½½æ—¶**ï¼šç«‹å³æŸ¥è¯¢ä¸€æ¬¡é™é¢
2. **æ¯30ç§’**ï¼šè‡ªåŠ¨åˆ·æ–°é™é¢ï¼ˆå› ä¸º1åˆ†é’Ÿçª—å£ä¼šå˜åŒ–ï¼‰
3. **ç”¨æˆ·è¾“å…¥æ—¶**ï¼šå®æ—¶éªŒè¯è¾“å…¥æ˜¯å¦è¶…é™
4. **è´¨æŠ¼å‰**ï¼šå†æ¬¡éªŒè¯é™é¢ï¼ˆé˜²æ­¢ç”¨æˆ·è¾“å…¥åé™é¢å˜åŒ–ï¼‰

```javascript
// å®æ—¶æ›´æ–°é™é¢çš„ä¾‹å­
useEffect(() => {
    const updateLimits = async () => {
        const globalMax = await staking.maxStakeAmount();
        const userRemaining = await staking.getRemainingStakeCapacity(userAddress);
        const usdtBalance = await usdt.balanceOf(userAddress);

        setMaxAmount(Math.min(globalMax, userRemaining, usdtBalance));
    };

    // åˆå§‹åŠ è½½
    updateLimits();

    // æ¯30ç§’åˆ·æ–°
    const interval = setInterval(updateLimits, 30000);

    return () => clearInterval(interval);
}, [userAddress]);
```

### âš¡ é”™è¯¯å¤„ç†

å½“ç”¨æˆ·è´¨æŠ¼å¤±è´¥æ—¶ï¼Œæ ¹æ®é”™è¯¯ç±»å‹æ˜¾ç¤ºä¸åŒæç¤ºï¼š

| é”™è¯¯åŸå›  | åˆçº¦é”™è¯¯ | å‰ç«¯æç¤º |
|---------|---------|---------|
| è¶…è¿‡å…¨å±€é™é¢ | `ExceedsMaxStakeAmount` | "å½“å‰ç½‘ç»œæµå…¥è¾ƒå¤šï¼Œè¯·ç¨åå†è¯•æˆ–å‡å°‘é‡‘é¢" |
| è¶…è¿‡ç”¨æˆ·ç´¯è®¡é™é¢ | `ExceedsUserTotalStakeLimit` | "æ‚¨çš„ç´¯è®¡è´¨æŠ¼å·²è¾¾ä¸Šé™ 10,000 SYI" |
| æ— æ•ˆçš„æ¡£æœŸ | `InvalidStakeIndex` | "è¯·é€‰æ‹©æœ‰æ•ˆçš„è´¨æŠ¼æ¡£æœŸ" |
| æœªç»‘å®šæ¨èäºº | `MustBindReferral` | "è¯·å…ˆç»‘å®šæ¨èäºº" |

### ğŸ’¡ ç”¨æˆ·ä½“éªŒä¼˜åŒ–

**å½“é™é¢ä¸º0æ—¶**ï¼š

```javascript
if (maxAmount === 0) {
    // æŸ¥è¯¢æµåŠ¨æ€§æ± ä¿¡æ¯ï¼Œé¢„ä¼°æ¢å¤æ—¶é—´
    const recentInflow = await staking.getRecentNetworkInflow();
    const poolReserve = await syi.getUSDTReserve();
    const onePercent = poolReserve / 100n;

    if (recentInflow > onePercent) {
        showMessage({
            type: 'warning',
            title: 'æš‚æ—¶é™åˆ¶è´¨æŠ¼',
            message: 'æœ€è¿‘1åˆ†é’Ÿå†…è´¨æŠ¼æµå…¥è¾ƒå¤šï¼Œè¯·ç¨åå†è¯•',
            countdown: 60 // æ˜¾ç¤ºå€’è®¡æ—¶
        });
    }
}
```

**å½“ç”¨æˆ·å‰©ä½™é¢åº¦ä¸è¶³æ—¶**ï¼š

```javascript
if (userRemaining < 100) {
    showMessage({
        type: 'info',
        title: 'æç¤º',
        message: `æ‚¨çš„å‰©ä½™è´¨æŠ¼é¢åº¦ä»…ä¸º ${userRemaining} SYI`,
        action: 'æŸ¥çœ‹æˆ‘çš„è´¨æŠ¼è®°å½•'
    });
}
```

### ğŸ“‹ å®Œæ•´çš„å‰ç«¯æŸ¥è¯¢ä»£ç ç¤ºä¾‹

```javascript
async function getStakingLimits(userAddress) {
    // 1. æŸ¥è¯¢å…¨å±€é™é¢ï¼ˆåŒ…å«1%é˜ˆå€¼æ£€æŸ¥ï¼‰
    const globalMaxAmount = await staking.maxStakeAmount();
    const globalMaxAmountFormatted = ethers.formatEther(globalMaxAmount);

    // 2. æŸ¥è¯¢ç”¨æˆ·å‰©ä½™é¢åº¦
    const userRemaining = await staking.getRemainingStakeCapacity(userAddress);
    const userRemainingFormatted = ethers.formatEther(userRemaining);

    // 3. æŸ¥è¯¢ç”¨æˆ·USDTä½™é¢
    const usdtBalance = await usdt.balanceOf(userAddress);
    const usdtBalanceFormatted = ethers.formatEther(usdtBalance);

    // 4. æŸ¥è¯¢æˆæƒé¢åº¦
    const allowance = await usdt.allowance(userAddress, stakingAddress);
    const allowanceFormatted = ethers.formatEther(allowance);

    // 5. æŸ¥è¯¢è¯¦ç»†ä¿¡æ¯ï¼ˆç”¨äºå±•ç¤ºï¼‰
    const recentInflow = await staking.getRecentNetworkInflow();
    const totalSupply = await staking.totalSupply();

    // 6. è®¡ç®—æœ€ç»ˆé™é¢
    const finalMax = Math.min(
        parseFloat(globalMaxAmountFormatted),
        parseFloat(userRemainingFormatted),
        parseFloat(usdtBalanceFormatted),
        parseFloat(allowanceFormatted)
    );

    return {
        finalMaxAmount: finalMax,
        details: {
            global: parseFloat(globalMaxAmountFormatted),
            userRemaining: parseFloat(userRemainingFormatted),
            usdtBalance: parseFloat(usdtBalanceFormatted),
            allowance: parseFloat(allowanceFormatted)
        },
        networkInfo: {
            recentInflow: ethers.formatEther(recentInflow),
            totalSupply: ethers.formatEther(totalSupply)
        },
        limitingFactor: finalMax === parseFloat(globalMaxAmountFormatted)
            ? 'global'
            : finalMax === parseFloat(userRemainingFormatted)
            ? 'user_limit'
            : finalMax === parseFloat(usdtBalanceFormatted)
            ? 'balance'
            : 'allowance'
    };
}
```

### ğŸ¯ æ€»ç»“

**æ˜¯çš„ï¼Œå‰ç«¯æ˜¾ç¤ºå•ç¬”é™é¢æ—¶å¿…é¡»è€ƒè™‘1%é˜ˆå€¼ï¼**

âœ… **æ­£ç¡®åšæ³•**ï¼š
```javascript
const maxAmount = await staking.maxStakeAmount(); // å·²åŒ…å«1%é˜ˆå€¼æ£€æŸ¥
```

âŒ **é”™è¯¯åšæ³•**ï¼š
```javascript
const maxAmount = 1000; // å†™æ­»ä¸º1000 SYIï¼Œå¿½ç•¥åŠ¨æ€é™åˆ¶
```

**å…³é”®ç‚¹**ï¼š
- `maxStakeAmount()` å‡½æ•°å·²ç»è‡ªåŠ¨è®¡ç®—äº†1%é˜ˆå€¼ã€1åˆ†é’Ÿæµå…¥é‡
- å‰ç«¯åªéœ€è°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œä¸éœ€è¦è‡ªå·±é‡å¤è®¡ç®—
- ä½†éœ€è¦ç»“åˆç”¨æˆ·å‰©ä½™é¢åº¦ã€é’±åŒ…ä½™é¢ç­‰å…¶ä»–é™åˆ¶
- å»ºè®®æ¯30ç§’åˆ·æ–°ä¸€æ¬¡ï¼Œå› ä¸ºé™é¢ä¼šåŠ¨æ€å˜åŒ–
