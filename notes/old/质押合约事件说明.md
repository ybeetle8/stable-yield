# SYI-Staking 质押合约事件说明文档

## 概述

本文档详细说明 SYI-Staking 质押合约中所有事件的触发时机、参数含义和使用场景。

---

## 一、核心业务事件

### 1. Staked（质押成功）

**触发时机：** 用户成功质押 USDT 后

**参数说明：**
```solidity
event Staked(
    address indexed user,      // 质押用户地址
    uint256 amount,            // 质押金额（USDT，单位：wei）
    uint256 timestamp,         // 质押时间戳
    uint256 index,             // 质押记录索引
    uint256 stakeTime          // 质押周期（秒）
);
```

**使用场景：**
- 前端监听此事件更新用户质押列表
- 统计平台总质押量
- 追踪用户质押历史

---

### 2. WithdrawalCompleted（完整提取完成）

**触发时机：** 用户在质押到期后完整提取本金和收益

**参数说明：**
```solidity
event WithdrawalCompleted(
    address indexed user,      // 提取用户地址
    uint256 indexed stakeIndex,// 质押记录索引
    uint256 principalAmount,   // 本金金额（USDT）
    uint256 calculatedReward,  // 计算的总奖励（本金+利息，SYI）
    uint256 usdtReceived,      // 实际收到的 USDT
    uint256 olaTokensUsed,     // 消耗的 SYI 代币数量
    uint256 referralFee,       // 推荐费（好友 5%）
    uint256 teamFee,           // 团队费（最高 35%）
    uint256 userPayout,        // 用户实际到账金额
    uint256 interestEarned,    // 赚取的利息
    uint40 withdrawalTime      // 提取时间戳
);
```

**使用场景：**
- 前端展示完整的提取明细
- 计算用户真实收益率
- 统计平台总收益分发

---

### 3. InterestWithdrawn（中途提取利息）

**触发时机：** 用户在质押未到期时提取已产生的利息

**参数说明：**
```solidity
event InterestWithdrawn(
    address indexed user,      // 提取用户地址
    uint256 indexed stakeIndex,// 质押记录索引
    uint256 profitAmount,      // 利润金额（SYI）
    uint256 usdtReceived,      // 收到的 USDT
    uint256 userPayout,        // 用户实际到账
    uint256 friendReward,      // 好友奖励
    uint256 teamReward,        // 团队奖励
    uint256 redemptionFee,     // 赎回手续费（1%）
    uint40 resetTime,          // 重置后的新起始时间
    uint40 originalEndTime,    // 原定到期时间（不变）
    uint256 timestamp          // 操作时间戳
);
```

**使用场景：**
- 追踪用户中途提息行为
- 计算实际 APY
- 监控资金流出

---

### 4. CompoundInterestReset（复利重置）

**触发时机：** 用户中途提取利息后，复利计算起点被重置

**参数说明：**
```solidity
event CompoundInterestReset(
    address indexed user,      // 用户地址
    uint256 indexed stakeIndex,// 质押记录索引
    uint256 oldValue,          // 重置前的总价值（本金+利息）
    uint256 newPrincipal,      // 重置后的本金（保持不变）
    uint40 oldStakeTime,       // 旧的复利起始时间
    uint40 newStakeTime,       // 新的复利起始时间
    uint40 unchangedEndTime,   // 到期时间（保持不变）
    uint256 timestamp          // 重置时间戳
);
```

**使用场景：**
- 调试复利计算逻辑
- 追踪用户收益提取历史
- 审计复利重置行为

---

### 5. RewardPaid（奖励支付 - Legacy）

**触发时机：** unstake 时触发（已被 WithdrawalCompleted 替代）

**参数说明：**
```solidity
event RewardPaid(
    address indexed user,      // 用户地址
    uint256 reward,            // 奖励金额
    uint40 timestamp,          // 时间戳
    uint256 index              // 质押索引
);
```

**使用场景：**
- 兼容旧版本监听逻辑
- 建议前端迁移到 WithdrawalCompleted

---

## 二、推荐与好友系统事件

### 6. BindReferral（绑定推荐人）

**触发时机：** 用户调用 `lockReferral()` 成功绑定推荐人

**参数说明：**
```solidity
event BindReferral(
    address indexed user,      // 被推荐用户地址
    address indexed parent     // 推荐人地址
);
```

**使用场景：**
- 构建推荐关系树
- 统计推荐人数
- 防止重复绑定

---

### 7. BindFriend（绑定好友）

**触发时机：** 用户调用 `lockFriend()` 绑定好友地址（直推 5% 接收方）

**参数说明：**
```solidity
event BindFriend(
    address indexed user,      // 用户地址
    address indexed friend     // 好友地址
);
```

**使用场景：**
- 记录直推奖励接收方
- 与推荐树分离的收益渠道

---

### 8. StrictDifferentialRewardPaid（差额奖励支付）

**触发时机：** 团队成员领取奖励时，按层级支付差额奖励

**参数说明：**
```solidity
event StrictDifferentialRewardPaid(
    address indexed recipient, // 奖励接收人
    uint8 indexed tier,        // 等级（1-7，对应V1-V7）
    uint256 actualRewardRate,  // 实际奖励比例（差额）
    uint256 rewardAmount,      // 奖励金额（USDT）
    uint256 previousCumulativeRate, // 之前累计比例
    uint256 currentTierRate    // 当前等级的完整比例
);
```

**使用场景：**
- 追踪每层的差额奖励
- 调试团队奖励分配逻辑
- 审计奖励计算准确性

**差额奖励说明：**
- V1(5%) - V2(10%) - V3(15%) - V4(20%) - V5(25%) - V6(30%) - V7(35%)
- 如果 V3 领取，实际拿 15% - 上层已领（如10%）= 5%

---

### 9. TeamRewardDistributionCompleted（团队奖励分发完成）

**触发时机：** 一次完整的团队奖励分发结束

**参数说明：**
```solidity
event TeamRewardDistributionCompleted(
    uint256 interestAmount,    // 原始利息金额
    uint256 totalTeamRewardPool, // 团队奖励池（35% of interest）
    uint256 totalDistributed,  // 实际分发金额
    uint256 marketingAmount,   // 剩余进入营销地址
    address[7] tierRecipients, // 各层级接收人数组
    uint256[7] tierAmounts,    // 各层级奖励金额数组
    uint8 activeTiers          // 激活的层级位图
);
```

**使用场景：**
- 总览一次分发的完整情况
- 统计各层级总收益
- 监控营销地址收入

---

### 10. PreacherCheckFailed（传教者检查失败）

**触发时机：** 团队成员不满足 Preacher 条件（≥200 ether 质押）

**参数说明：**
```solidity
event PreacherCheckFailed(
    address indexed user,      // 用户地址
    uint8 indexed tier,        // 本应拥有的等级
    string reason              // 失败原因
);
```

**使用场景：**
- 调试为何用户未获得奖励
- 提醒用户提升质押量
- 监控潜在的资格不足情况

---

## 三、系统管理事件

### 11. Transfer（代币转账）

**触发时机：** sSYI 代币铸造或销毁（不支持用户间转账）

**参数说明：**
```solidity
event Transfer(
    address indexed from,      // 发送方（address(0)为铸造）
    address indexed to,        // 接收方（address(0)为销毁）
    uint256 amount             // 金额
);
```

**使用场景：**
- ERC20 标准事件
- 追踪 sSYI 供应量变化

---

### 12. SYIContractSet（设置 SYI 合约）

**触发时机：** Owner 调用 `setSYI()` 设置代币合约地址

**参数说明：**
```solidity
event SYIContractSet(
    address indexed syiAddress // SYI 代币合约地址
);
```

**使用场景：**
- 初始化或升级代币合约
- 审计合约关联关系

---

### 13. StakingRatesUpdated（质押利率更新）

**触发时机：** 合约初始化时设置各档位利率

**参数说明：**
```solidity
event StakingRatesUpdated(
    uint256[4] newRates        // 新利率数组 [1D, 30D, 90D, 180D]
);
```

**使用场景：**
- 记录利率配置
- 审计 APY 设置

---

## 四、费用相关事件

### 14. RedemptionFeeCollected（赎回手续费收取）

**触发时机：** 用户 unstake 或 withdrawInterest 时收取 1% 手续费

**参数说明：**
```solidity
event RedemptionFeeCollected(
    address indexed user,      // 用户地址
    uint256 stakeIndex,        // 质押索引
    uint256 syiAmount,         // SYI 代币费用
    uint256 usdtAmount,        // USDT 费用金额
    address indexed feeRecipient, // 费用接收地址
    uint256 timestamp          // 时间戳
);
```

**使用场景：**
- 统计平台手续费收入
- 审计费用收取情况

---

### 15. FeeRecipientUpdated（费用接收地址更新）

**触发时机：** Owner 调用 `setFeeRecipient()` 更新费用接收地址

**参数说明：**
```solidity
event FeeRecipientUpdated(
    address indexed oldRecipient, // 旧地址
    address indexed newRecipient  // 新地址
);
```

**使用场景：**
- 追踪费用接收方变更
- 审计管理操作

---

## 五、节点等级管理事件

### 16. TierManagerUpdated（等级管理员更新）

**触发时机：** Owner 调用 `setTierManager()` 设置等级管理员

**参数说明：**
```solidity
event TierManagerUpdated(
    address indexed oldManager, // 旧管理员
    address indexed newManager, // 新管理员
    address indexed operator,   // 操作者
    uint256 timestamp           // 时间戳
);
```

**使用场景：**
- 审计管理员权限变更

---

### 17. NodeTierSet（设置节点等级）

**触发时机：** TierManager 为用户设置节点等级（V1 或 V2）

**参数说明：**
```solidity
event NodeTierSet(
    address indexed user,      // 用户地址
    uint8 tier,                // 等级（1或2）
    address indexed setBy,     // 设置者
    uint256 timestamp          // 时间戳
);
```

**使用场景：**
- 追踪节点等级分配
- 审计管理操作

---

### 18. NodeTierRemoved（移除节点等级）

**触发时机：** TierManager 移除用户的节点等级

**参数说明：**
```solidity
event NodeTierRemoved(
    address indexed user,      // 用户地址
    uint8 previousTier,        // 之前的等级
    address indexed removedBy, // 移除者
    uint256 timestamp          // 时间戳
);
```

**使用场景：**
- 追踪等级移除操作
- 审计管理操作

---

### 19. NodeTierBatchSet（批量设置节点等级）

**触发时机：** TierManager 批量设置多个用户的节点等级

**参数说明：**
```solidity
event NodeTierBatchSet(
    address[] users,           // 用户地址数组
    uint8[] tiers,             // 等级数组
    address indexed setBy,     // 设置者
    uint256 count,             // 数量
    uint256 timestamp          // 时间戳
);
```

**使用场景：**
- 追踪批量操作
- 提高事件监听效率

---

## 事件监听最佳实践

### 1. 核心业务监听
```javascript
// 监听用户质押
contract.on("Staked", (user, amount, timestamp, index, stakeTime) => {
  console.log(`用户 ${user} 质押了 ${ethers.formatUnits(amount, 18)} USDT`);
});

// 监听完整提取
contract.on("WithdrawalCompleted", (user, stakeIndex, ...args) => {
  const [principalAmount, calculatedReward, usdtReceived, ...rest] = args;
  console.log(`用户 ${user} 提取了质押 #${stakeIndex}，收到 ${ethers.formatUnits(usdtReceived, 18)} USDT`);
});
```

### 2. 团队奖励监听
```javascript
// 监听差额奖励
contract.on("StrictDifferentialRewardPaid", (recipient, tier, actualRewardRate, rewardAmount) => {
  console.log(`V${tier} 用户 ${recipient} 获得差额奖励 ${ethers.formatUnits(rewardAmount, 18)} USDT`);
});
```

### 3. 过滤特定用户事件
```javascript
const userAddress = "0x...";
const filter = contract.filters.Staked(userAddress);
const events = await contract.queryFilter(filter, fromBlock, toBlock);
```

---

## 注意事项

1. **Indexed 参数：** 带 `indexed` 的参数可以被过滤，但最多 3 个
2. **Gas 优化：** 过多的 indexed 参数会增加 gas 消耗
3. **历史事件：** 使用 `queryFilter()` 查询历史事件时注意区块范围限制
4. **事件顺序：** 一笔交易可能触发多个事件，按执行顺序排列

---

## 版本历史

- **v1.0** - 初始版本，包含所有核心事件
- **v1.1** - 新增节点等级管理事件
- **v1.2** - 新增中途提息功能相关事件（InterestWithdrawn, CompoundInterestReset）

---

## 参考资料

- 合约源码：`contracts/SYI-Staking/abstract/StakingBase.sol`
- 接口定义：`contracts/SYI-Staking/interfaces/IStaking.sol`
