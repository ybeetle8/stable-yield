# SYI-Staking äº‹ä»¶ç›‘å¬ä½¿ç”¨æŒ‡å—

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **äº‹ä»¶è¯´æ˜æ–‡æ¡£**ï¼š[è´¨æŠ¼åˆçº¦äº‹ä»¶è¯´æ˜.md](./è´¨æŠ¼åˆçº¦äº‹ä»¶è¯´æ˜.md)
- **åˆçº¦æ¥å£**ï¼š`contracts/SYI-Staking/interfaces/IStaking.sol`
- **åˆçº¦å®ç°**ï¼š`contracts/SYI-Staking/abstract/StakingBase.sol`

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å‰ç½®æ¡ä»¶

1. **å¯åŠ¨ Fork èŠ‚ç‚¹**ï¼ˆåœ¨ç¬¬ä¸€ä¸ªç»ˆç«¯çª—å£ï¼‰ï¼š

```bash
npx hardhat node --fork https://binance.llamarpc.com --fork-block-number 63482920
```

> âš ï¸ **é‡è¦**ï¼šä¿æŒæ­¤ç»ˆç«¯çª—å£è¿è¡Œï¼Œä¸è¦å…³é—­ï¼

---

### æ–¹æ³•ä¸€ï¼šå®æ—¶ç›‘å¬äº‹ä»¶ï¼ˆæ¨èï¼‰

#### æ­¥éª¤ 1ï¼šå¯åŠ¨äº‹ä»¶ç›‘å¬å™¨ï¼ˆç¬¬äºŒä¸ªç»ˆç«¯çª—å£ï¼‰

```bash
npm run monitor-events
```

æˆ–

```bash
npx hardhat run scripts/monitorStakingEvents.js --network localhost
```

**åŠŸèƒ½è¯´æ˜ï¼š**
- âœ… è‡ªåŠ¨æŸ¥è¯¢æœ€è¿‘ 100 ä¸ªåŒºå—çš„å†å²äº‹ä»¶
- âœ… å®æ—¶ç›‘å¬æ‰€æœ‰æ–°äº‹ä»¶
- âœ… ä»¥ä¸­æ–‡æ ¼å¼åŒ–è¾“å‡ºäº‹ä»¶è¯¦æƒ…
- âœ… æ”¯æŒ 19 ç§äº‹ä»¶ç±»å‹

**è¾“å‡ºç¤ºä¾‹ï¼š**
```
================================================================================
ğŸ“Œ äº‹ä»¶ï¼šè´¨æŠ¼æˆåŠŸ (Staked)
================================================================================
ç”¨æˆ·åœ°å€ï¼š     0x1234...5678 (0x1234...5678)
è´¨æŠ¼é‡‘é¢ï¼š     500.0 USDT
è´¨æŠ¼æ—¶é—´ï¼š     2025-10-14 15:30:45
è®°å½•ç´¢å¼•ï¼š     #0
è´¨æŠ¼å‘¨æœŸï¼š     180å¤© 0å°æ—¶
åŒºå—é«˜åº¦ï¼š     12345678
äº¤æ˜“å“ˆå¸Œï¼š     0xabcd...efgh
================================================================================
```

#### æ­¥éª¤ 2ï¼šè§¦å‘æµ‹è¯•äº‹ä»¶ï¼ˆç¬¬ä¸‰ä¸ªç»ˆç«¯çª—å£ï¼‰

```bash
npm run test-events
```

æˆ–

```bash
npx hardhat run scripts/testStakingEvents.js --network localhost
```

**æµ‹è¯•å†…å®¹ï¼š**
1. âœ… ç»‘å®šæ¨èå…³ç³»ï¼ˆ4ä¸ªç”¨æˆ·ï¼‰
2. âœ… ç»‘å®šå¥½å‹å…³ç³»
3. âœ… æ‰§è¡Œè´¨æŠ¼æ“ä½œï¼ˆ4ç¬”ä¸åŒæ¡£ä½ï¼‰
4. âœ… ä¸­é€”æå–åˆ©æ¯
5. âœ… è®¾ç½®èŠ‚ç‚¹ç­‰çº§
6. âœ… æ‰¹é‡è®¾ç½®èŠ‚ç‚¹ç­‰çº§
7. âœ… æ›´æ–°è´¹ç”¨æ¥æ”¶åœ°å€

**è§¦å‘çš„äº‹ä»¶ï¼š**
- `BindReferral` - ç»‘å®šæ¨èäºº
- `BindFriend` - ç»‘å®šå¥½å‹
- `Staked` - è´¨æŠ¼æˆåŠŸ
- `Transfer` - sSYI é“¸é€ 
- `InterestWithdrawn` - ä¸­é€”ææ¯
- `CompoundInterestReset` - å¤åˆ©é‡ç½®
- `RedemptionFeeCollected` - èµå›æ‰‹ç»­è´¹
- `NodeTierSet` - è®¾ç½®èŠ‚ç‚¹ç­‰çº§
- `NodeTierBatchSet` - æ‰¹é‡è®¾ç½®ç­‰çº§
- `FeeRecipientUpdated` - æ›´æ–°è´¹ç”¨æ¥æ”¶åœ°å€

---

### æ–¹æ³•äºŒï¼šè„šæœ¬å†…é›†æˆç›‘å¬

åœ¨ä½ è‡ªå·±çš„è„šæœ¬ä¸­é›†æˆäº‹ä»¶ç›‘å¬ï¼š

```javascript
const { ethers } = require("hardhat");

async function main() {
  const staking = await ethers.getContractAt("Staking", stakingAddress);

  // ç›‘å¬è´¨æŠ¼äº‹ä»¶
  staking.on("Staked", (user, amount, timestamp, index, stakeTime) => {
    console.log(`ç”¨æˆ· ${user} è´¨æŠ¼äº† ${ethers.formatUnits(amount, 18)} USDT`);
  });

  // ç›‘å¬æå–äº‹ä»¶
  staking.on("WithdrawalCompleted", (user, stakeIndex, ...args) => {
    console.log(`ç”¨æˆ· ${user} å®Œæˆæå–ï¼Œè´¨æŠ¼ç´¢å¼• #${stakeIndex}`);
  });

  // æ‰§è¡Œæ“ä½œ...
  await staking.connect(user).stake(amount, stakeIndex);
}
```

---

## ğŸ“Š æ”¯æŒçš„äº‹ä»¶åˆ—è¡¨

### æ ¸å¿ƒä¸šåŠ¡äº‹ä»¶ï¼ˆ5ä¸ªï¼‰

| äº‹ä»¶å | è¯´æ˜ | è§¦å‘æ—¶æœº |
|--------|------|---------|
| `Staked` | è´¨æŠ¼æˆåŠŸ | ç”¨æˆ·æˆåŠŸè´¨æŠ¼ USDT |
| `WithdrawalCompleted` | å®Œæ•´æå– | è´¨æŠ¼åˆ°æœŸåå®Œæ•´æå– |
| `InterestWithdrawn` | ä¸­é€”ææ¯ | è´¨æŠ¼æœªåˆ°æœŸæ—¶æå–åˆ©æ¯ |
| `CompoundInterestReset` | å¤åˆ©é‡ç½® | ä¸­é€”ææ¯åé‡ç½®å¤åˆ©èµ·ç‚¹ |
| `RewardPaid` | å¥–åŠ±æ”¯ä»˜ | Legacy äº‹ä»¶ï¼Œå·²è¢« WithdrawalCompleted æ›¿ä»£ |

### æ¨èä¸å¥½å‹ç³»ç»Ÿï¼ˆ5ä¸ªï¼‰

| äº‹ä»¶å | è¯´æ˜ | è§¦å‘æ—¶æœº |
|--------|------|---------|
| `BindReferral` | ç»‘å®šæ¨èäºº | ç”¨æˆ·è°ƒç”¨ lockReferral() |
| `BindFriend` | ç»‘å®šå¥½å‹ | ç”¨æˆ·è°ƒç”¨ lockFriend() |
| `StrictDifferentialRewardPaid` | å·®é¢å¥–åŠ± | å›¢é˜Ÿæˆå‘˜é¢†å–å·®é¢å¥–åŠ± |
| `TeamRewardDistributionCompleted` | åˆ†å‘å®Œæˆ | ä¸€æ¬¡å®Œæ•´çš„å›¢é˜Ÿå¥–åŠ±åˆ†å‘ |
| `PreacherCheckFailed` | èµ„æ ¼ä¸è¶³ | ç”¨æˆ·æœªæ»¡è¶³ Preacher æ¡ä»¶ |

### ç³»ç»Ÿç®¡ç†ï¼ˆ3ä¸ªï¼‰

| äº‹ä»¶å | è¯´æ˜ | è§¦å‘æ—¶æœº |
|--------|------|---------|
| `Transfer` | ä»£å¸è½¬è´¦ | sSYI é“¸é€ æˆ–é”€æ¯ |
| `SYIContractSet` | è®¾ç½®åˆçº¦ | Owner è®¾ç½® SYI ä»£å¸åˆçº¦ |
| `StakingRatesUpdated` | åˆ©ç‡æ›´æ–° | åˆçº¦åˆå§‹åŒ–æ—¶è®¾ç½®åˆ©ç‡ |

### è´¹ç”¨ç›¸å…³ï¼ˆ2ä¸ªï¼‰

| äº‹ä»¶å | è¯´æ˜ | è§¦å‘æ—¶æœº |
|--------|------|---------|
| `RedemptionFeeCollected` | æ”¶å–æ‰‹ç»­è´¹ | ç”¨æˆ· unstake æˆ– withdrawInterest |
| `FeeRecipientUpdated` | æ›´æ–°æ¥æ”¶æ–¹ | Owner æ›´æ–°è´¹ç”¨æ¥æ”¶åœ°å€ |

### èŠ‚ç‚¹ç­‰çº§ç®¡ç†ï¼ˆ4ä¸ªï¼‰

| äº‹ä»¶å | è¯´æ˜ | è§¦å‘æ—¶æœº |
|--------|------|---------|
| `TierManagerUpdated` | ç®¡ç†å‘˜æ›´æ–° | Owner è®¾ç½®ç­‰çº§ç®¡ç†å‘˜ |
| `NodeTierSet` | è®¾ç½®ç­‰çº§ | TierManager ä¸ºç”¨æˆ·è®¾ç½®ç­‰çº§ |
| `NodeTierRemoved` | ç§»é™¤ç­‰çº§ | TierManager ç§»é™¤ç”¨æˆ·ç­‰çº§ |
| `NodeTierBatchSet` | æ‰¹é‡è®¾ç½® | TierManager æ‰¹é‡è®¾ç½®ç­‰çº§ |

**æ€»è®¡ï¼š19 ä¸ªäº‹ä»¶**

---

## ğŸ” æŸ¥è¯¢å†å²äº‹ä»¶

### æŸ¥è¯¢ç‰¹å®šç”¨æˆ·çš„è´¨æŠ¼è®°å½•

```javascript
const filter = staking.filters.Staked(userAddress);
const events = await staking.queryFilter(filter, fromBlock, toBlock);

for (const event of events) {
  console.log(`è´¨æŠ¼æ—¶é—´ï¼š${event.args.timestamp}`);
  console.log(`è´¨æŠ¼é‡‘é¢ï¼š${ethers.formatUnits(event.args.amount, 18)} USDT`);
}
```

### æŸ¥è¯¢æ‰€æœ‰å›¢é˜Ÿå¥–åŠ±åˆ†å‘

```javascript
const filter = staking.filters.TeamRewardDistributionCompleted();
const events = await staking.queryFilter(filter, fromBlock, toBlock);

for (const event of events) {
  const totalDistributed = event.args.totalDistributed;
  console.log(`åˆ†å‘é‡‘é¢ï¼š${ethers.formatUnits(totalDistributed, 18)} USDT`);
}
```

### æŸ¥è¯¢èŠ‚ç‚¹ç­‰çº§å˜æ›´

```javascript
// æŸ¥è¯¢æŸç”¨æˆ·çš„ç­‰çº§è®¾ç½®è®°å½•
const setFilter = staking.filters.NodeTierSet(userAddress);
const setEvents = await staking.queryFilter(setFilter, fromBlock, toBlock);

// æŸ¥è¯¢æŸç”¨æˆ·çš„ç­‰çº§ç§»é™¤è®°å½•
const removeFilter = staking.filters.NodeTierRemoved(userAddress);
const removeEvents = await staking.queryFilter(removeFilter, fromBlock, toBlock);
```

---

## ğŸ’¡ ä½¿ç”¨æŠ€å·§

### 1. è¿‡æ»¤ç‰¹å®šäº‹ä»¶

```javascript
// åªç›‘å¬ç‰¹å®šç”¨æˆ·çš„è´¨æŠ¼äº‹ä»¶
const filter = staking.filters.Staked(userAddress);
staking.on(filter, (user, amount, timestamp, index, stakeTime, event) => {
  console.log("ç‰¹å®šç”¨æˆ·è´¨æŠ¼äº†ï¼");
});
```

### 2. ä¸€æ¬¡æ€§ç›‘å¬ï¼ˆonceï¼‰

```javascript
// åªç›‘å¬ä¸€æ¬¡ï¼Œè§¦å‘åè‡ªåŠ¨å–æ¶ˆ
staking.once("Staked", (user, amount) => {
  console.log("ç¬¬ä¸€æ¬¡è´¨æŠ¼è§¦å‘ï¼");
});
```

### 3. ç§»é™¤ç›‘å¬å™¨

```javascript
const handler = (user, amount) => {
  console.log("è´¨æŠ¼äº‹ä»¶ï¼");
};

staking.on("Staked", handler);

// ç§»é™¤ç‰¹å®šç›‘å¬å™¨
staking.off("Staked", handler);

// ç§»é™¤æ‰€æœ‰ç›‘å¬å™¨
staking.removeAllListeners("Staked");
```

### 4. é™åˆ¶æŸ¥è¯¢åŒºå—èŒƒå›´

```javascript
// åˆ†æ‰¹æŸ¥è¯¢é¿å…è¶…æ—¶
const batchSize = 1000;
for (let i = startBlock; i < endBlock; i += batchSize) {
  const events = await staking.queryFilter(
    filter,
    i,
    Math.min(i + batchSize, endBlock)
  );
  // å¤„ç†äº‹ä»¶...
}
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. Indexed å‚æ•°é™åˆ¶

- æ¯ä¸ªäº‹ä»¶æœ€å¤š 3 ä¸ª `indexed` å‚æ•°
- åªæœ‰ indexed å‚æ•°å¯ä»¥è¢«è¿‡æ»¤
- ç¤ºä¾‹ï¼š`Staked` äº‹ä»¶ä¸­åªæœ‰ `user` æ˜¯ indexed

### 2. åŒºå—èŒƒå›´é™åˆ¶

- æŸ¥è¯¢å†å²äº‹ä»¶æ—¶æ³¨æ„åŒºå—èŒƒå›´é™åˆ¶
- BSC ä¸»ç½‘å•æ¬¡æŸ¥è¯¢å»ºè®®ä¸è¶…è¿‡ 5000 ä¸ªåŒºå—
- å¯ä»¥åˆ†æ‰¹æŸ¥è¯¢é¿å…è¶…æ—¶

### 3. äº‹ä»¶ç›‘å¬å†…å­˜

- é•¿æ—¶é—´ç›‘å¬å¯èƒ½å ç”¨å†…å­˜
- ç”Ÿäº§ç¯å¢ƒå»ºè®®å®šæœŸé‡å¯ç›‘å¬å™¨
- æˆ–è€…ä½¿ç”¨æ•°æ®åº“å­˜å‚¨å†å²äº‹ä»¶

### 4. ç½‘ç»œå»¶è¿Ÿ

- äº‹ä»¶è§¦å‘å¯èƒ½æœ‰ 1-2 ä¸ªåŒºå—çš„å»¶è¿Ÿ
- ä½¿ç”¨ `event.blockNumber` ç¡®è®¤å®é™…åŒºå—é«˜åº¦
- ç›‘å¬æ—¶ç­‰å¾…äº¤æ˜“ç¡®è®¤ï¼ˆ`await tx.wait()`ï¼‰

---

## ğŸ› å¸¸è§é—®é¢˜

### Q1: ç›‘å¬å™¨æ²¡æœ‰æ”¶åˆ°äº‹ä»¶ï¼Ÿ

**è§£å†³æ–¹æ¡ˆï¼š**
1. ç¡®è®¤ Hardhat èŠ‚ç‚¹æ­£åœ¨è¿è¡Œ
2. æ£€æŸ¥åˆçº¦åœ°å€æ˜¯å¦æ­£ç¡®ï¼ˆdeployed-addresses.jsonï¼‰
3. ç¡®è®¤äº‹ä»¶åç§°æ‹¼å†™æ­£ç¡®
4. ä½¿ç”¨ `queryFilter` æ£€æŸ¥å†å²äº‹ä»¶æ˜¯å¦å­˜åœ¨

### Q2: æŸ¥è¯¢å†å²äº‹ä»¶è¶…æ—¶ï¼Ÿ

**è§£å†³æ–¹æ¡ˆï¼š**
1. å‡å°åŒºå—èŒƒå›´ï¼ˆfromBlock - toBlockï¼‰
2. åˆ†æ‰¹æŸ¥è¯¢
3. ä½¿ç”¨ Archive Nodeï¼ˆæ”¯æŒæ›´å¤§èŒƒå›´æŸ¥è¯¢ï¼‰

### Q3: äº‹ä»¶å‚æ•°è§£æé”™è¯¯ï¼Ÿ

**è§£å†³æ–¹æ¡ˆï¼š**
1. ç¡®è®¤åˆçº¦ ABI æ˜¯å¦æœ€æ–°ï¼ˆé‡æ–°ç¼–è¯‘ï¼‰
2. æ£€æŸ¥å‚æ•°ç±»å‹åŒ¹é…
3. ä½¿ç”¨ `event.args` è®¿é—®å‚æ•°è€Œä¸æ˜¯ä½ç½®ç´¢å¼•

### Q4: å¦‚ä½•åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ï¼Ÿ

**å»ºè®®ï¼š**
1. ä½¿ç”¨ WebSocket è¿æ¥ï¼ˆæ›´ç¨³å®šï¼‰
2. é…ç½®é‡è¿æœºåˆ¶
3. ä½¿ç”¨ The Graph æˆ– Moralis ç­‰ç´¢å¼•æœåŠ¡
4. å­˜å‚¨äº‹ä»¶åˆ°æ•°æ®åº“

---

## ğŸ“ ç¤ºä¾‹ï¼šå®Œæ•´çš„äº‹ä»¶ç›‘å¬æœåŠ¡

```javascript
const { ethers } = require("hardhat");

class StakingEventMonitor {
  constructor(stakingAddress) {
    this.stakingAddress = stakingAddress;
    this.staking = null;
    this.listeners = new Map();
  }

  async start() {
    this.staking = await ethers.getContractAt("Staking", this.stakingAddress);

    // æ³¨å†Œæ‰€æœ‰ç›‘å¬å™¨
    this.registerAllListeners();

    console.log("âœ… äº‹ä»¶ç›‘å¬å™¨å¯åŠ¨æˆåŠŸ");
  }

  registerAllListeners() {
    // è´¨æŠ¼äº‹ä»¶
    this.on("Staked", this.handleStaked.bind(this));
    this.on("WithdrawalCompleted", this.handleWithdrawal.bind(this));
    this.on("InterestWithdrawn", this.handleInterestWithdrawn.bind(this));

    // æ¨èç³»ç»Ÿ
    this.on("BindReferral", this.handleBindReferral.bind(this));
    this.on("TeamRewardDistributionCompleted", this.handleTeamReward.bind(this));

    // æ›´å¤šäº‹ä»¶...
  }

  on(eventName, handler) {
    this.staking.on(eventName, handler);
    this.listeners.set(eventName, handler);
  }

  handleStaked(user, amount, timestamp, index, stakeTime) {
    console.log(`[è´¨æŠ¼] ${user} è´¨æŠ¼äº† ${ethers.formatUnits(amount, 18)} USDT`);
    // å­˜å‚¨åˆ°æ•°æ®åº“ã€å‘é€é€šçŸ¥ç­‰...
  }

  handleWithdrawal(user, stakeIndex, ...args) {
    console.log(`[æå–] ${user} å®Œæˆæå– #${stakeIndex}`);
    // å¤„ç†æå–é€»è¾‘...
  }

  handleInterestWithdrawn(user, stakeIndex, profitAmount, ...args) {
    console.log(`[ææ¯] ${user} æå–åˆ©æ¯ ${ethers.formatUnits(profitAmount, 18)} SYI`);
    // å¤„ç†ææ¯é€»è¾‘...
  }

  handleBindReferral(user, parent) {
    console.log(`[æ¨è] ${user} ç»‘å®šæ¨èäºº ${parent}`);
    // æ›´æ–°æ¨èå…³ç³»æ ‘...
  }

  handleTeamReward(...args) {
    console.log(`[å›¢é˜Ÿå¥–åŠ±] åˆ†å‘å®Œæˆ`);
    // ç»Ÿè®¡å›¢é˜Ÿå¥–åŠ±...
  }

  async stop() {
    // ç§»é™¤æ‰€æœ‰ç›‘å¬å™¨
    for (const [eventName, handler] of this.listeners) {
      this.staking.off(eventName, handler);
    }
    this.listeners.clear();
    console.log("âŒ äº‹ä»¶ç›‘å¬å™¨å·²åœæ­¢");
  }

  async queryHistory(eventName, fromBlock, toBlock) {
    const filter = this.staking.filters[eventName]();
    return await this.staking.queryFilter(filter, fromBlock, toBlock);
  }
}

// ä½¿ç”¨ç¤ºä¾‹
async function main() {
  const monitor = new StakingEventMonitor(stakingAddress);
  await monitor.start();

  // æŸ¥è¯¢å†å²
  const events = await monitor.queryHistory("Staked", 0, "latest");
  console.log(`æ‰¾åˆ° ${events.length} ä¸ªå†å²è´¨æŠ¼äº‹ä»¶`);

  // ä¿æŒè¿è¡Œ
  await new Promise(() => {});
}

main();
```

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·å‚è€ƒï¼š
- [åˆçº¦äº‹ä»¶è¯´æ˜æ–‡æ¡£](./è´¨æŠ¼åˆçº¦äº‹ä»¶è¯´æ˜.md)
- [Hardhat å®˜æ–¹æ–‡æ¡£](https://hardhat.org/hardhat-runner/docs/advanced/using-viem)
- [Ethers.js äº‹ä»¶æ–‡æ¡£](https://docs.ethers.org/v6/api/contract/#ContractEvent)

---

**æœ€åæ›´æ–°ï¼š2025-10-14**
