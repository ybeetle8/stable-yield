# åŠŸèƒ½å†²çªåˆ†æï¼šèŠ‚ç‚¹ç­‰çº§ç®¡ç† vs æå‰æ”¯å–ç›ˆåˆ©

## æ–‡æ¡£ä¿¡æ¯
- **åˆ›å»ºæ—¶é—´**: 2025-10-14
- **åˆ†æèŒƒå›´**: èŠ‚ç‚¹ç­‰çº§ç®¡ç†ç³»ç»Ÿ + æå‰æ”¯å–ç›ˆåˆ©åŠŸèƒ½
- **åˆçº¦ç‰ˆæœ¬**: StakingBase.sol
- **é£é™©ç­‰çº§**: ğŸŸ¡ ä¸­ç­‰ï¼ˆéœ€è¦åè°ƒè®¾è®¡ï¼Œä½†æ— è‡´å‘½å†²çªï¼‰

---

## ä¸€ã€åŠŸèƒ½æ¦‚è¿°å¯¹æ¯”

### 1.1 èŠ‚ç‚¹ç­‰çº§ç®¡ç†ç³»ç»Ÿ

**æ ¸å¿ƒå˜æ›´**:
```solidity
// æ–°å¢æ•°æ®ç»“æ„
struct NodeTierRecord {
    uint8 tier;        // 1 byte
    uint40 setTime;    // 5 bytes
    address setBy;     // 20 bytes
    bool active;       // 1 byte
}

address public tierManager;
mapping(address => NodeTierRecord) public nodeTiers;

// ä¿®æ”¹æ ¸å¿ƒå‡½æ•°
function _getUserTier(address user) private view returns (uint8) {
    // åŸé€»è¾‘ï¼šä»…åŸºäº teamKPI è®¡ç®—
    // æ–°é€»è¾‘ï¼šMAX(è‡ªç„¶ç­‰çº§, èŠ‚ç‚¹ç­‰çº§)
}
```

**å½±å“èŒƒå›´**:
- âœ… _getUserTier (ä¿®æ”¹è®¡ç®—é€»è¾‘)
- âœ… _distributeHybridRewards (é—´æ¥å½±å“ï¼Œé€šè¿‡ _getUserTier)
- âœ… getTeamPerformanceDetails (æŸ¥è¯¢åŠŸèƒ½)

---

### 1.2 æå‰æ”¯å–ç›ˆåˆ©åŠŸèƒ½

**æ ¸å¿ƒå˜æ›´**:
```solidity
// ä¿®æ”¹ç°æœ‰æ•°æ®ç»“æ„
struct Record {
    uint40 stakeTime;
    uint160 amount;
    uint160 withdrawnProfit;  // â­ æ–°å¢å­—æ®µ
    bool status;
    uint8 stakeIndex;
}

// æ–°å¢çŠ¶æ€å˜é‡
mapping(address => mapping(uint256 => uint40)) public lastInterestWithdrawTime;
uint256 public constant INTEREST_WITHDRAW_COOLDOWN = 30 days;

// æ–°å¢æ ¸å¿ƒå‡½æ•°
function withdrawInterest(uint256 stakeIndex) external returns (uint256);

// ä¿®æ”¹ç°æœ‰å‡½æ•°
function unstake(uint256 stakeIndex) external {
    // éœ€è¦å‡å» withdrawnProfit
}
```

**å½±å“èŒƒå›´**:
- âœ… Record ç»“æ„ä½“ï¼ˆå­˜å‚¨å¸ƒå±€å˜åŒ–ï¼‰
- âœ… unstake å‡½æ•°ï¼ˆéœ€é€‚é…å·²æå–ç›ˆåˆ©ï¼‰
- âœ… è´¹ç”¨åˆ†é…é€»è¾‘ï¼ˆæ–°å¢ä¸€ä¸ªæå–å…¥å£ï¼‰

---

## äºŒã€å†²çªç‚¹è¯¦ç»†åˆ†æ

### 2.1 æ•°æ®ç»“æ„å†²çªï¼ˆğŸŸ¢ ä½é£é™©ï¼‰

#### å†²çªæè¿°

**èŠ‚ç‚¹ç­‰çº§åŠŸèƒ½**ï¼š
- æ–°å¢ `NodeTierRecord` ç»“æ„ä½“
- æ–°å¢ `mapping(address => NodeTierRecord) nodeTiers`
- æ–°å¢ `address tierManager`
- **ä¸ä¿®æ”¹** `Record` ç»“æ„ä½“

**æå‰æ”¯å–åŠŸèƒ½**ï¼š
- **ä¿®æ”¹** `Record` ç»“æ„ä½“ï¼ˆæ·»åŠ  `withdrawnProfit` å­—æ®µï¼‰
- æ–°å¢ `mapping(address => mapping(uint256 => uint40)) lastInterestWithdrawTime`
- **ä¸ä¿®æ”¹**å…¶ä»–ç»“æ„ä½“

#### å­˜å‚¨å¸ƒå±€å½±å“

```solidity
// åŸ Record ç»“æ„ (1 ä¸ª slot)
struct Record {
    uint40 stakeTime;      // 40 bits
    uint160 amount;        // 160 bits
    bool status;           // 8 bits
    uint8 stakeIndex;      // 8 bits
    // æ€»è®¡: 216 bits < 256 bits â†’ 1 slot
}

// æå‰æ”¯å–åŠŸèƒ½ä¿®æ”¹å (2 ä¸ª slot)
struct Record {
    uint40 stakeTime;          // Slot 0: 40 bits
    uint160 amount;            // Slot 0: 160 bits
    uint160 withdrawnProfit;   // Slot 1: 160 bits  âš ï¸ æ–°å¢
    bool status;               // Slot 1: 8 bits
    uint8 stakeIndex;          // Slot 1: 8 bits
    // æ€»è®¡: 376 bits â†’ 2 slots
}

// èŠ‚ç‚¹ç­‰çº§åŠŸèƒ½æ–°å¢ (ç‹¬ç«‹å­˜å‚¨)
mapping(address => NodeTierRecord) nodeTiers;  // æ¯ç”¨æˆ· 1 slot
```

#### ç»“è®º
âœ… **æ— å†²çª**ï¼šä¸¤ä¸ªåŠŸèƒ½çš„æ•°æ®ç»“æ„ä¿®æ”¹æ˜¯ç‹¬ç«‹çš„
- Record ä¿®æ”¹ä»…å½±å“è´¨æŠ¼è®°å½•
- NodeTierRecord æ˜¯ç‹¬ç«‹çš„ mapping
- ä¸¤è€…ä¸ä¼šäº’ç›¸è¦†ç›–æˆ–å†²çª

âš ï¸ **æ³¨æ„äº‹é¡¹**ï¼š
- Record ç»“æ„ä½“ä» 1 slot å˜æˆ 2 slotsï¼Œæ¯ä¸ªè´¨æŠ¼è®°å½•å¢åŠ  ~20,000 gas
- å¿…é¡»åœ¨åˆçº¦éƒ¨ç½²å‰å®Œæˆä¿®æ”¹ï¼Œå¦åˆ™éœ€è¦ä»£ç†å‡çº§

---

### 2.2 å‡½æ•°è°ƒç”¨é“¾å†²çªï¼ˆğŸŸ¡ ä¸­é£é™©ï¼‰

#### è°ƒç”¨é“¾å›¾ç¤º

```
èŠ‚ç‚¹ç­‰çº§åŠŸèƒ½çš„è°ƒç”¨é“¾ï¼š
unstake()
  â””â”€ _distributeTeamReward()
       â””â”€ _distributeHybridRewards()
            â””â”€ _getUserTier()  âš ï¸ ä¿®æ”¹ï¼šå¢åŠ èŠ‚ç‚¹ç­‰çº§é€»è¾‘

æå‰æ”¯å–åŠŸèƒ½çš„è°ƒç”¨é“¾ï¼š
withdrawInterest()  âš ï¸ æ–°å¢å‡½æ•°
  â”œâ”€ _calculateStakeReward()
  â”œâ”€ _swapSYIForReward()
  â”œâ”€ _distributeFriendReward()
  â””â”€ _distributeTeamReward()
       â””â”€ _distributeHybridRewards()
            â””â”€ _getUserTier()  âš ï¸ ä¼šå—èŠ‚ç‚¹ç­‰çº§åŠŸèƒ½å½±å“

unstake()  âš ï¸ ä¿®æ”¹
  â”œâ”€ _burn()
  â”œâ”€ _calculateStakeReward()  âš ï¸ éœ€è¦å‡å» withdrawnProfit
  â”œâ”€ _swapSYIForReward()
  â”œâ”€ _distributeFriendReward()
  â””â”€ _distributeTeamReward()
```

#### å†²çªç‚¹

**é—®é¢˜1ï¼šwithdrawInterest ä¼šè§¦å‘èŠ‚ç‚¹ç­‰çº§çš„å›¢é˜Ÿå¥–åŠ±è®¡ç®—**

åœºæ™¯ï¼š
```
ç”¨æˆ·A: èŠ‚ç‚¹ç­‰çº§ V1, è‡ªç„¶ç­‰çº§ 0, è´¨æŠ¼ 200 SYI (Preacher âœ“)
ç”¨æˆ·B: A çš„ç›´æ¥ä¸‹çº§, è´¨æŠ¼ 1000 USDT

Day 15: B è°ƒç”¨ withdrawInterest(0)
  â†’ è®¡ç®—ç›ˆåˆ©: 93.8 USDT
  â†’ è°ƒç”¨ _distributeTeamReward(Bçš„æ¨èé“¾, 93.8)
  â†’ _getUserTier(A) = 1 (èŠ‚ç‚¹ç­‰çº§ç”Ÿæ•ˆ)
  â†’ A è·å¾—: 93.8 Ã— 5% = 4.69 USDT  âœ…

Day 30: B è°ƒç”¨ unstake(0)
  â†’ è®¡ç®—å‰©ä½™ç›ˆåˆ©: 198.8 - 93.8 = 105.0 USDT
  â†’ è°ƒç”¨ _distributeTeamReward(Bçš„æ¨èé“¾, 105.0)
  â†’ _getUserTier(A) = 1 (èŠ‚ç‚¹ç­‰çº§ä»ç”Ÿæ•ˆ)
  â†’ A è·å¾—: 105.0 Ã— 5% = 5.25 USDT  âœ…

A æ€»å…±è·å¾—: 4.69 + 5.25 = 9.94 USDT
å¦‚æœä¸æå‰æ”¯å–ï¼ŒA è·å¾—: 198.8 Ã— 5% = 9.94 USDT  âœ… ä¸€è‡´
```

**ç»“è®º**ï¼šâœ… **é€»è¾‘æ­£ç¡®**ï¼Œåˆ†å¤šæ¬¡åˆ†é…çš„æ€»é¢ = ä¸€æ¬¡æ€§åˆ†é…çš„æ€»é¢

---

**é—®é¢˜2ï¼šunstake å¿…é¡»æ­£ç¡®å‡å» withdrawnProfit**

æå‰æ”¯å–åŠŸèƒ½æ–‡æ¡£åœ¨ç¬¬ 5.1 èŠ‚å·²ç»è¯´æ˜ï¼š

```solidity
// æå‰æ”¯å–è®¾è®¡ä¸­è¦æ±‚çš„ä¿®æ”¹
function unstake(uint256 stakeIndex) external {
    (uint256 calculatedReward, uint256 principalAmount) = _burn(stakeIndex);

    // âš ï¸ æ–°å¢ï¼šå‡å»å·²æå–çš„ç›ˆåˆ©
    Record storage stakeRecord = userStakeRecord[msg.sender][stakeIndex];
    uint256 remainingReward = calculatedReward - stakeRecord.withdrawnProfit;

    // åç»­ä½¿ç”¨ remainingReward è€Œä¸æ˜¯ calculatedReward
    (uint256 usdtReceived, uint256 syiTokensUsed) = _swapSYIForReward(remainingReward);
    // ...
}
```

**ç»“è®º**ï¼šâœ… **å¿…é¡»ä¿®æ”¹ unstake**ï¼Œä¸¤ä¸ªåŠŸèƒ½éƒ½è¦æ±‚è¿™ä¸ªä¿®æ”¹

---

### 2.3 å›¢é˜Ÿå¥–åŠ±è®¡ç®—é€»è¾‘å†²çªï¼ˆğŸŸ¢ ä½é£é™©ï¼‰

#### åœºæ™¯åˆ†æ

```
æ¨èé“¾: ç”¨æˆ·C â†’ ç”¨æˆ·B(èŠ‚ç‚¹ç­‰çº§V2) â†’ ç”¨æˆ·A(èŠ‚ç‚¹ç­‰çº§V1) â†’ root

ç”¨æˆ·C è´¨æŠ¼ 1000 USDT (30å¤©æ¡£)

æƒ…å†µ1: C åœ¨ Day 30 ç›´æ¥ unstake
- ç›ˆåˆ©: 198.8 USDT
- A è·å¾—: 198.8 Ã— 5% = 9.94 USDT (V1)
- B è·å¾—: 198.8 Ã— 5% = 9.94 USDT (V2-V1 å·®é¢)
- root è·å¾—: 198.8 Ã— 25% = 49.7 USDT

æƒ…å†µ2: C åˆ† 3 æ¬¡æå– (Day 10, 20, 30)
- Day 10: ç›ˆåˆ© 62.3 USDT
  - A è·å¾—: 62.3 Ã— 5% = 3.12 USDT
  - B è·å¾—: 62.3 Ã— 5% = 3.12 USDT

- Day 20: æ–°å¢ç›ˆåˆ© 65.8 USDT
  - A è·å¾—: 65.8 Ã— 5% = 3.29 USDT
  - B è·å¾—: 65.8 Ã— 5% = 3.29 USDT

- Day 30: å‰©ä½™ç›ˆåˆ© 70.7 USDT
  - A è·å¾—: 70.7 Ã— 5% = 3.54 USDT
  - B è·å¾—: 70.7 Ã— 5% = 3.54 USDT

æ€»è®¡:
- A: 3.12 + 3.29 + 3.54 = 9.95 USDT â‰ˆ 9.94 USDT  âœ…
- B: 3.12 + 3.29 + 3.54 = 9.95 USDT â‰ˆ 9.94 USDT  âœ…
```

#### ç»“è®º
âœ… **æ— å†²çª**ï¼š
- èŠ‚ç‚¹ç­‰çº§çš„å·®é¢å¥–åŠ±æœºåˆ¶åœ¨å¤šæ¬¡æå–åœºæ™¯ä¸‹ä»ç„¶æ­£ç¡®
- æ€»å¥–åŠ± = å„æ¬¡æå–å¥–åŠ±ä¹‹å’Œ
- ä¸å­˜åœ¨é‡å¤åˆ†é…æˆ–é—æ¼

---

### 2.4 Preacher çŠ¶æ€æ£€æŸ¥å†²çªï¼ˆğŸŸ¢ ä½é£é™©ï¼‰

#### èŠ‚ç‚¹ç­‰çº§å¯¹ Preacher çš„ä¾èµ–

```solidity
// èŠ‚ç‚¹ç­‰çº§åŠŸèƒ½çš„ _getUserTier å®ç°
function _getUserTier(address user) private view returns (uint8) {
    if (user == rootAddress) return 0;

    // âš ï¸ èŠ‚ç‚¹ç­‰çº§ä»…åœ¨ Preacher æ—¶ç”Ÿæ•ˆ
    if (!isPreacher(user)) {
        return 0;  // èŠ‚ç‚¹ç­‰çº§æ— æ•ˆ
    }

    uint8 naturalTier = _calculateNaturalTier(user);
    uint8 nodeTier = nodeTiers[user].active ? nodeTiers[user].tier : 0;

    return _max8(naturalTier, nodeTier);
}
```

#### æå‰æ”¯å–å¯¹ Preacher çŠ¶æ€çš„å½±å“

```solidity
function isPreacher(address user) public view returns (bool) {
    return currentStakeValue(user) >= PREACHER_THRESHOLD; // 200 ether
}

// withdrawInterest ä¸æ”¹å˜æœ¬é‡‘ï¼Œåªæå–ç›ˆåˆ©
function withdrawInterest(uint256 stakeIndex) external {
    // ...
    // âš ï¸ ä»…æå–ç›ˆåˆ©ï¼ŒstakeRecord.amount ä¸å˜
    stakeRecord.withdrawnProfit += actualWithdraw;
    // balances[user] ä¸å˜
    // ...
}

// currentStakeValue è®¡ç®—å½“å‰ä»·å€¼ï¼ˆåŒ…å«ç›ˆåˆ©ï¼‰
function currentStakeValue(address user) public view returns (uint256) {
    // éå†æ‰€æœ‰è´¨æŠ¼è®°å½•ï¼Œç´¯åŠ  _calculateStakeReward(stakeRecord)
    // withdrawnProfit ä¸å½±å“æ­¤è®¡ç®—
}
```

#### æ½œåœ¨é—®é¢˜

**åœºæ™¯**ï¼š
```
ç”¨æˆ·è´¨æŠ¼ 200 SYI (åˆšå¥½è¾¾åˆ° Preacher é—¨æ§›)
- Day 0: currentStakeValue = 200 SYI â†’ isPreacher = true
- Day 15: æå–ç›ˆåˆ©å
  - balances[user] = 200 SYI (æœ¬é‡‘æœªå˜)
  - currentStakeValue = 200 Ã— 1.006^15 = 218.8 SYI
  - isPreacher = true âœ… (ä»ç„¶æ»¡è¶³)
```

**å¦‚æœæœªæ¥æ·»åŠ "æå‰å–å›éƒ¨åˆ†æœ¬é‡‘"åŠŸèƒ½**ï¼š
```
ç”¨æˆ·è´¨æŠ¼ 200 SYI
- æå‰å–å› 50 SYI æœ¬é‡‘
- balances[user] = 150 SYI
- currentStakeValue = 150 SYI (< 200)
- isPreacher = false âŒ
- èŠ‚ç‚¹ç­‰çº§å¤±æ•ˆ âŒ
```

#### ç»“è®º
âœ… **å½“å‰è®¾è®¡æ— å†²çª**ï¼š
- withdrawInterest åªæå–ç›ˆåˆ©ï¼Œä¸å½±å“æœ¬é‡‘
- currentStakeValue ä¼šéšæ—¶é—´å¢é•¿ï¼Œä¸ä¼šå› æå–ç›ˆåˆ©è€Œä¸‹é™
- Preacher çŠ¶æ€ç¨³å®šï¼ŒèŠ‚ç‚¹ç­‰çº§ä¸ä¼šæ„å¤–å¤±æ•ˆ

âš ï¸ **æœªæ¥é£é™©**ï¼š
- å¦‚æœæ‰©å±•ä¸º"æå‰å–å›éƒ¨åˆ†æœ¬é‡‘"ï¼Œéœ€è¦é¢å¤–è®¾è®¡
- å»ºè®®ï¼šé™åˆ¶æå–æœ¬é‡‘æ—¶å¿…é¡»ä¿ç•™ â‰¥ 200 SYI

---

### 2.5 å¤åˆ©è®¡ç®—å†²çªï¼ˆğŸŸ¢ æ— å†²çªï¼‰

#### èŠ‚ç‚¹ç­‰çº§åŠŸèƒ½å¯¹å¤åˆ©è®¡ç®—çš„å½±å“

èŠ‚ç‚¹ç­‰çº§åŠŸèƒ½**ä¸ä¿®æ”¹** `_calculateStakeReward` å‡½æ•°ï¼š

```solidity
function _calculateStakeReward(
    IStaking.Record storage stakeRecord
) private view returns (uint256 currentReward) {
    // èŠ‚ç‚¹ç­‰çº§åŠŸèƒ½ä¸ä¿®æ”¹æ­¤å‡½æ•°
    // ä»ç„¶ä½¿ç”¨åŸå§‹çš„å¤åˆ©å…¬å¼
    UD60x18 principalAmount = ud(stakeRecord.amount);
    uint40 stakingDuration = uint40(block.timestamp) - stakeRecord.stakeTime;
    // ...
}
```

#### æå‰æ”¯å–åŠŸèƒ½å¯¹å¤åˆ©è®¡ç®—çš„å½±å“

æå‰æ”¯å–åŠŸèƒ½**ä¸ä¿®æ”¹** `_calculateStakeReward`ï¼Œä½†ä¿®æ”¹å…¶ä½¿ç”¨æ–¹å¼ï¼š

```solidity
// withdrawInterest ä¸­ä½¿ç”¨
function withdrawInterest(uint256 stakeIndex) external {
    uint256 currentValue = _calculateStakeReward(stakeRecord);  // è®¡ç®—æ€»ä»·å€¼
    uint256 totalProfit = currentValue - stakeRecord.amount;    // æ€»ç›ˆåˆ©
    uint256 withdrawableProfit = totalProfit - stakeRecord.withdrawnProfit; // å¯æå–

    // âš ï¸ stakeTime ä¸å˜ï¼Œç»§ç»­å¤åˆ©
}

// unstake ä¸­ä½¿ç”¨
function unstake(uint256 stakeIndex) external {
    uint256 calculatedReward = _calculateStakeReward(stakeRecord);  // è®¡ç®—æ€»ä»·å€¼
    uint256 remainingReward = calculatedReward - stakeRecord.withdrawnProfit; // å‡å»å·²æå–

    // åç»­ä½¿ç”¨ remainingReward
}
```

#### ç»“è®º
âœ… **æ— å†²çª**ï¼š
- ä¸¤ä¸ªåŠŸèƒ½éƒ½ä¸ä¿®æ”¹å¤åˆ©è®¡ç®—æ ¸å¿ƒ
- æå‰æ”¯å–åŠŸèƒ½é€šè¿‡ `withdrawnProfit` è¿½è¸ªå·²æå–é‡‘é¢
- èŠ‚ç‚¹ç­‰çº§åŠŸèƒ½ä»…å½±å“å›¢é˜Ÿå¥–åŠ±åˆ†é…ï¼Œä¸å½±å“æ”¶ç›Šè®¡ç®—

---

## ä¸‰ã€ç»¼åˆé£é™©è¯„ä¼°

### 3.1 é£é™©çŸ©é˜µ

| é£é™©ç±»åˆ« | æ¦‚ç‡ | å½±å“ | é£é™©ç­‰çº§ | ç¼“è§£æªæ–½ |
|---------|------|------|---------|---------|
| **å­˜å‚¨å¸ƒå±€å˜åŒ–** | å¿…ç„¶ | ä¸­ | ğŸŸ¡ ä¸­ | éƒ¨ç½²å‰å®Œæˆä¿®æ”¹ï¼Œæˆ–ä½¿ç”¨ä»£ç†æ¨¡å¼ |
| **å›¢é˜Ÿå¥–åŠ±é‡å¤åˆ†é…** | æ—  | - | ğŸŸ¢ ä½ | æ•°å­¦éªŒè¯é€šè¿‡ï¼Œæ€»é¢ä¸€è‡´ |
| **èŠ‚ç‚¹ç­‰çº§å¤±æ•ˆ** | ä½ | ä½ | ğŸŸ¢ ä½ | withdrawInterest ä¸æ”¹å˜æœ¬é‡‘ |
| **å¤åˆ©è®¡ç®—é”™è¯¯** | æ—  | - | ğŸŸ¢ ä½ | ä¸¤åŠŸèƒ½éƒ½ä¸ä¿®æ”¹æ ¸å¿ƒå…¬å¼ |
| **unstake é—æ¼ withdrawnProfit** | ä¸­ | é«˜ | ğŸŸ¡ ä¸­ | ä»£ç å®¡æŸ¥ + æµ‹è¯•è¦†ç›– |
| **Gas æˆæœ¬å¢åŠ ** | å¿…ç„¶ | ä½ | ğŸŸ¢ ä½ | Record å¢åŠ  1 slotï¼Œæˆæœ¬å¯æ¥å— |
| **æµ‹è¯•å¤æ‚åº¦** | å¿…ç„¶ | ä¸­ | ğŸŸ¡ ä¸­ | å¢åŠ ç»„åˆåœºæ™¯æµ‹è¯•ç”¨ä¾‹ |

### 3.2 å…³é”®é£é™©è¯¦è§£

#### é£é™©1ï¼šunstake å¿…é¡»å‡å» withdrawnProfitï¼ˆğŸ”´ é«˜ä¼˜å…ˆçº§ï¼‰

**é—®é¢˜æè¿°**ï¼š
å¦‚æœ unstake å¿˜è®°å‡å» `stakeRecord.withdrawnProfit`ï¼Œç”¨æˆ·å¯ä»¥é‡å¤è·å¾—å·²æå–çš„ç›ˆåˆ©ã€‚

**æ”»å‡»åœºæ™¯**ï¼š
```
ç”¨æˆ·è´¨æŠ¼ 1000 USDT (30å¤©æ¡£)
Day 15: withdrawInterest(0) â†’ æå– 93.8 USDT
Day 30: unstake(0) â†’ å¦‚æœä¸å‡å» withdrawnProfitï¼Œä¼šå†æ¬¡è·å¾— 198.8 USDT
æ€»æ”¶ç›Š: 93.8 + 198.8 = 292.6 USDT (åº”è¯¥æ˜¯ 198.8 USDT)
```

**å¿…é¡»çš„ä»£ç ä¿®æ”¹**ï¼š
```solidity
function unstake(uint256 stakeIndex) external onlyEOA returns (uint256 totalReward) {
    (uint256 calculatedReward, uint256 principalAmount) = _burn(stakeIndex);

    // âš ï¸ å¿…é¡»æ·»åŠ ï¼šå‡å»å·²æå–ç›ˆåˆ©
    Record storage stakeRecord = userStakeRecord[msg.sender][stakeIndex];
    uint256 withdrawnProfit = stakeRecord.withdrawnProfit;

    // âš ï¸ å®‰å…¨æ£€æŸ¥
    require(calculatedReward >= withdrawnProfit, "Invalid withdrawn profit");

    uint256 remainingReward = calculatedReward - withdrawnProfit;

    // âš ï¸ åç»­æ‰€æœ‰é€»è¾‘ä½¿ç”¨ remainingReward è€Œä¸æ˜¯ calculatedReward
    (uint256 usdtReceived, uint256 syiTokensUsed) = _swapSYIForReward(remainingReward);

    // åˆ©æ¯è®¡ç®—ä¹Ÿéœ€è¦è°ƒæ•´
    uint256 interestEarned = usdtReceived > principalAmount
        ? usdtReceived - principalAmount
        : 0;

    // è´¹ç”¨åˆ†é…åŸºäº interestEarned (å‰©ä½™åˆ©æ¯)
    // ...
}
```

**ç¼“è§£æªæ–½**ï¼š
1. âœ… ä»£ç å®¡æŸ¥æ—¶é‡ç‚¹æ£€æŸ¥
2. âœ… æµ‹è¯•ç”¨ä¾‹å¿…é¡»è¦†ç›–"æå–åå† unstake"åœºæ™¯
3. âœ… æ·»åŠ  `require` æ£€æŸ¥ï¼Œé˜²æ­¢ withdrawnProfit > calculatedReward

---

#### é£é™©2ï¼šå­˜å‚¨å¸ƒå±€å˜åŒ–éœ€è¦è°¨æ…å¤„ç†ï¼ˆğŸŸ¡ ä¸­ä¼˜å…ˆçº§ï¼‰

**é—®é¢˜æè¿°**ï¼š
ä¿®æ”¹ Record ç»“æ„ä½“ä¼šæ”¹å˜å­˜å‚¨å¸ƒå±€ï¼Œå·²æœ‰æ•°æ®å¯èƒ½æ— æ³•è¯»å–ã€‚

**å½±å“åˆ†æ**ï¼š
```solidity
// æ—§åˆçº¦ï¼ˆå·²éƒ¨ç½²ï¼‰
struct Record {
    uint40 stakeTime;    // Slot 0: bits 0-39
    uint160 amount;      // Slot 0: bits 40-199
    bool status;         // Slot 0: bits 200-207
    uint8 stakeIndex;    // Slot 0: bits 208-215
}

// æ–°åˆçº¦ï¼ˆæ·»åŠ  withdrawnProfitï¼‰
struct Record {
    uint40 stakeTime;          // Slot 0: bits 0-39
    uint160 amount;            // Slot 0: bits 40-199
    uint160 withdrawnProfit;   // Slot 1: bits 0-159  âš ï¸ æ–°å¢
    bool status;               // Slot 1: bits 160-167
    uint8 stakeIndex;          // Slot 1: bits 168-175
}

// é—®é¢˜ï¼šæ—§æ•°æ®çš„ status å’Œ stakeIndex ä½ç½®é”™ä¹±ï¼
// æ—§åˆçº¦ä¸­ status åœ¨ Slot 0 çš„ bits 200-207
// æ–°åˆçº¦ä¸­ status åœ¨ Slot 1 çš„ bits 160-167
// è¯»å–æ—¶ä¼šå¾—åˆ°é”™è¯¯çš„å€¼
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

**æ–¹æ¡ˆ1ï¼šé‡æ–°éƒ¨ç½²åˆçº¦ï¼ˆæ¨èï¼‰**
- âœ… ä¼˜ç‚¹ï¼šå¹²å‡€ç®€å•ï¼Œæ— å†å²åŒ…è¢±
- âœ… é€‚ç”¨åœºæ™¯ï¼šåˆçº¦æœªéƒ¨ç½²æˆ–ç”¨æˆ·æ•°æ®å¯è¿ç§»
- âŒ ç¼ºç‚¹ï¼šéœ€è¦ç”¨æˆ·é‡æ–°è´¨æŠ¼

**æ–¹æ¡ˆ2ï¼šä½¿ç”¨é€æ˜ä»£ç†å‡çº§**
```solidity
// éƒ¨ç½²ä»£ç†åˆçº¦
TransparentUpgradeableProxy proxy = new TransparentUpgradeableProxy(
    stakingV1Address,
    proxyAdmin,
    ""
);

// å‡çº§åˆ° V2
proxyAdmin.upgrade(proxy, stakingV2Address);

// âš ï¸ æ³¨æ„ï¼šV2 çš„å­˜å‚¨å¸ƒå±€å¿…é¡»å…¼å®¹ V1
// åªèƒ½åœ¨æœ«å°¾æ·»åŠ æ–°å­—æ®µï¼Œä¸èƒ½æ’å…¥ä¸­é—´
```

**æ–¹æ¡ˆ3ï¼šæ·»åŠ ç‹¬ç«‹ mappingï¼ˆå¦¥åæ–¹æ¡ˆï¼‰**
```solidity
// ä¸ä¿®æ”¹ Recordï¼Œä½¿ç”¨ç‹¬ç«‹ mapping
struct Record {
    uint40 stakeTime;
    uint160 amount;
    bool status;
    uint8 stakeIndex;
    // ä¸æ·»åŠ æ–°å­—æ®µ
}

// ç‹¬ç«‹å­˜å‚¨å·²æå–ç›ˆåˆ©
mapping(address => mapping(uint256 => uint256)) public userStakeWithdrawnProfit;

// ä½¿ç”¨æ—¶
uint256 withdrawnProfit = userStakeWithdrawnProfit[user][stakeIndex];
```

**æ¨èç­–ç•¥**ï¼š
- å¦‚æœåˆçº¦**æœªéƒ¨ç½²** â†’ ç›´æ¥ä¿®æ”¹ Record ç»“æ„ä½“ âœ…
- å¦‚æœåˆçº¦**å·²éƒ¨ç½²ä½†æ— ç”¨æˆ·** â†’ é‡æ–°éƒ¨ç½² âœ…
- å¦‚æœåˆçº¦**å·²éƒ¨ç½²ä¸”æœ‰ç”¨æˆ·** â†’ ä½¿ç”¨ä»£ç†å‡çº§æˆ–ç‹¬ç«‹ mapping âš ï¸

---

#### é£é™©3ï¼šGas æˆæœ¬å¢åŠ ï¼ˆğŸŸ¢ ä½ä¼˜å…ˆçº§ï¼‰

**å½±å“é‡åŒ–**ï¼š

```
æå‰æ”¯å–åŠŸèƒ½çš„ Gas æ¶ˆè€—ï¼š
- åŸºç¡€æ“ä½œ: ~10,000 gas
- _calculateStakeReward: ~5,000 gas
- _swapSYIForReward: ~100,000 gas
- _distributeFriendReward: ~30,000 gas
- _distributeTeamReward: ~50,000-200,000 gas (å–å†³äºæ¨èé“¾æ·±åº¦)
- å­˜å‚¨æ›´æ–° (withdrawnProfit): ~5,000 gas
æ€»è®¡: ~200,000-350,000 gas

èŠ‚ç‚¹ç­‰çº§åŠŸèƒ½çš„ Gas æ¶ˆè€—å¢åŠ ï¼š
- _getUserTier é¢å¤– SLOAD (nodeTiers): ~2,100 gas
- å¦‚æœä½¿ç”¨èŠ‚ç‚¹ç­‰çº§ï¼Œemit äº‹ä»¶: ~1,000 gas
unstake å¢åŠ : ~3,000 gas (< 1%)

Record ç»“æ„ä½“å¢åŠ  1 slotï¼š
- æ¯æ¬¡è´¨æŠ¼: +20,000 gas (SSTORE cold)
- æ¯æ¬¡è¯»å–: +2,100 gas (SLOAD cold)
```

**ç»“è®º**ï¼š
âœ… Gas å¢åŠ åœ¨å¯æ¥å—èŒƒå›´å†…ï¼ˆ< 10%ï¼‰

---

## å››ã€è®¾è®¡åè°ƒå»ºè®®

### 4.1 ç»Ÿä¸€çš„ unstake ä¿®æ”¹

ä¸¤ä¸ªåŠŸèƒ½éƒ½è¦æ±‚ä¿®æ”¹ unstakeï¼Œéœ€è¦åè°ƒä¸ºç»Ÿä¸€çš„å®ç°ï¼š

```solidity
function unstake(
    uint256 stakeIndex
) external onlyEOA returns (uint256 totalReward) {
    // ========================================
    // æ­¥éª¤1: é”€æ¯è´¨æŠ¼è®°å½•ï¼ˆåŸæœ‰é€»è¾‘ï¼‰
    // ========================================
    (uint256 calculatedReward, uint256 principalAmount) = _burn(stakeIndex);

    // ========================================
    // æ­¥éª¤2: âš ï¸ æ–°å¢ - å‡å»å·²æå–ç›ˆåˆ©ï¼ˆæå‰æ”¯å–åŠŸèƒ½ï¼‰
    // ========================================
    Record storage stakeRecord = userStakeRecord[msg.sender][stakeIndex];
    uint256 withdrawnProfit = stakeRecord.withdrawnProfit;

    require(calculatedReward >= withdrawnProfit, "Invalid withdrawn profit");

    uint256 remainingReward = calculatedReward - withdrawnProfit;

    // ========================================
    // æ­¥éª¤3: å…‘æ¢ä¸º USDTï¼ˆåŸæœ‰é€»è¾‘ï¼Œä½¿ç”¨ remainingRewardï¼‰
    // ========================================
    (uint256 usdtReceived, uint256 syiTokensUsed) = _swapSYIForReward(
        remainingReward  // âš ï¸ æ”¹ä¸º remainingReward
    );

    // ========================================
    // æ­¥éª¤4: è®¡ç®—åˆ©æ¯ï¼ˆåŸºäºå‰©ä½™å¥–åŠ±ï¼‰
    // ========================================
    uint256 interestEarned = usdtReceived > principalAmount
        ? usdtReceived - principalAmount
        : 0;

    // ========================================
    // æ­¥éª¤5: è´¹ç”¨åˆ†é…ï¼ˆåŸæœ‰é€»è¾‘ï¼ŒèŠ‚ç‚¹ç­‰çº§åŠŸèƒ½ä¼šå½±å“ _distributeTeamRewardï¼‰
    // ========================================
    address[] memory referralChain = getReferrals(msg.sender, maxD);
    uint256 friendReward = _distributeFriendReward(msg.sender, interestEarned);

    // âš ï¸ _distributeTeamReward å†…éƒ¨è°ƒç”¨ _getUserTier
    // èŠ‚ç‚¹ç­‰çº§åŠŸèƒ½ä¿®æ”¹äº† _getUserTierï¼Œä¼šåœ¨è¿™é‡Œç”Ÿæ•ˆ
    uint256 teamFee = _distributeTeamReward(referralChain, interestEarned);

    // ... åç»­é€»è¾‘ä¸å˜ ...
}
```

### 4.2 äº‹ä»¶è®°å½•åè°ƒ

å»ºè®®ç»Ÿä¸€äº‹ä»¶å‘½åå’Œå‚æ•°ï¼š

```solidity
// æå‰æ”¯å–åŠŸèƒ½çš„äº‹ä»¶
event InterestWithdrawn(
    address indexed user,
    uint256 indexed stakeIndex,
    uint256 profitAmount,
    uint256 usdtReceived,
    uint256 userPayout,
    uint256 friendReward,
    uint256 teamReward,
    uint256 redemptionFee,
    uint256 timestamp
);

// èŠ‚ç‚¹ç­‰çº§åŠŸèƒ½çš„äº‹ä»¶
event NodeTierUsed(
    address indexed user,
    uint8 naturalTier,
    uint8 nodeTier,
    uint8 finalTier,
    string reason
);

// å»ºè®®ï¼šåœ¨ withdrawInterest ä¸­ä¹Ÿè§¦å‘ NodeTierUsed
function withdrawInterest(uint256 stakeIndex) external {
    // ...

    // å¦‚æœå›¢é˜Ÿå¥–åŠ±åˆ†é…æ—¶ä½¿ç”¨äº†èŠ‚ç‚¹ç­‰çº§ï¼Œè®°å½•äº‹ä»¶
    // ï¼ˆå¯åœ¨ _distributeHybridRewards ä¸­è‡ªåŠ¨è§¦å‘ï¼‰

    // ...
}
```

### 4.3 æŸ¥è¯¢å‡½æ•°åè°ƒ

å»ºè®®æ·»åŠ ç»Ÿä¸€çš„ç”¨æˆ·ä¿¡æ¯æŸ¥è¯¢å‡½æ•°ï¼š

```solidity
/**
 * @notice æŸ¥è¯¢ç”¨æˆ·çš„å®Œæ•´è´¨æŠ¼å’Œç­‰çº§ä¿¡æ¯
 */
function getUserCompleteInfo(
    address user,
    uint256 stakeIndex
) external view returns (
    // è´¨æŠ¼ä¿¡æ¯
    uint256 principal,
    uint256 currentValue,
    uint256 totalProfit,
    uint256 withdrawnProfit,
    uint256 availableProfit,
    bool canWithdraw,
    uint256 timeRemaining,
    // ç­‰çº§ä¿¡æ¯ (èŠ‚ç‚¹ç­‰çº§åŠŸèƒ½)
    bool isPreacherStatus,
    uint8 naturalTier,
    uint8 nodeTier,
    uint8 finalTier,
    bool usingNodeTier,
    // æå‰æ”¯å–ä¿¡æ¯
    bool canWithdrawInterest,
    uint256 interestCooldownRemaining
) {
    Record storage stakeRecord = userStakeRecord[user][stakeIndex];

    principal = stakeRecord.amount;
    currentValue = _calculateStakeReward(stakeRecord);
    totalProfit = currentValue - principal;
    withdrawnProfit = stakeRecord.withdrawnProfit;
    availableProfit = totalProfit - withdrawnProfit;

    // ... å…¶ä½™å­—æ®µ ...
}
```

---

## äº”ã€æµ‹è¯•ç”¨ä¾‹è®¾è®¡

### 5.1 ç»„åˆåœºæ™¯æµ‹è¯•ï¼ˆå¿…é¡»ï¼‰

```javascript
describe("èŠ‚ç‚¹ç­‰çº§ + æå‰æ”¯å–ç»„åˆæµ‹è¯•", function() {

    it("åœºæ™¯1: èŠ‚ç‚¹ç­‰çº§ç”¨æˆ·æå‰æ”¯å–ï¼Œåº”è·å¾—ç›¸åº”ç­‰çº§çš„å›¢é˜Ÿå¥–åŠ±", async function() {
        // 1. è®¾ç½®æ¨èå…³ç³»: C -> B -> A -> root
        await staking.connect(A).lockReferral(root.address);
        await staking.connect(B).lockReferral(A.address);
        await staking.connect(C).lockReferral(B.address);

        // 2. A è´¨æŠ¼ 200 SYI (Preacher)ï¼Œæ—  teamKPI
        await staking.connect(A).stake(ethers.parseEther("200"), 0);

        // 3. è®¾ç½® A ä¸ºèŠ‚ç‚¹ç­‰çº§ V1
        await staking.setTierManager(tierManager.address);
        await staking.connect(tierManager).setNodeTier(A.address, 1);

        // 4. C è´¨æŠ¼ 1000 USDT
        await staking.connect(C).stake(ethers.parseEther("1000"), 1);

        // 5. Day 15: C æå‰æ”¯å–åˆ©æ¯
        await time.increase(15 * 24 * 60 * 60);
        const balanceBeforeA = await usdt.balanceOf(A.address);
        await staking.connect(C).withdrawInterest(0);
        const balanceAfterA = await usdt.balanceOf(A.address);

        // 6. éªŒè¯ A è·å¾—äº† V1 çš„å›¢é˜Ÿå¥–åŠ± (5%)
        const rewardA = balanceAfterA - balanceBeforeA;
        const expectedReward = ethers.parseEther("93.8") * 5n / 100n; // çº¦ 4.69 USDT

        expect(rewardA).to.be.closeTo(expectedReward, ethers.parseEther("0.1"));
    });

    it("åœºæ™¯2: æå‰æ”¯å–å unstakeï¼Œå¥–åŠ±æ€»é¢åº”ä¸€è‡´", async function() {
        // 1. è®¾ç½®å…³ç³»ï¼ˆåŒä¸Šï¼‰
        // ...

        // 2. C è´¨æŠ¼ 1000 USDT
        await staking.connect(C).stake(ethers.parseEther("1000"), 1);

        // 3. Day 15 æå–åˆ©æ¯
        await time.increase(15 * 24 * 60 * 60);
        const balanceBeforeA1 = await usdt.balanceOf(A.address);
        await staking.connect(C).withdrawInterest(0);
        const reward1 = (await usdt.balanceOf(A.address)) - balanceBeforeA1;

        // 4. Day 30 è§£é™¤è´¨æŠ¼
        await time.increase(15 * 24 * 60 * 60);
        const balanceBeforeA2 = await usdt.balanceOf(A.address);
        await staking.connect(C).unstake(0);
        const reward2 = (await usdt.balanceOf(A.address)) - balanceBeforeA2;

        // 5. éªŒè¯æ€»å¥–åŠ± = ä¸€æ¬¡æ€§ unstake çš„å¥–åŠ±
        const totalReward = reward1 + reward2;
        const expectedTotal = ethers.parseEther("198.8") * 5n / 100n; // çº¦ 9.94 USDT

        expect(totalReward).to.be.closeTo(expectedTotal, ethers.parseEther("0.1"));
    });

    it("åœºæ™¯3: æå‰æ”¯å–åå¤±å» Preacher èµ„æ ¼ï¼ŒèŠ‚ç‚¹ç­‰çº§å¤±æ•ˆ", async function() {
        // 1. A è´¨æŠ¼ 200 SYI (åˆšå¥½ Preacher)
        await staking.connect(A).stake(ethers.parseEther("200"), 0);
        await staking.connect(tierManager).setNodeTier(A.address, 1);

        // 2. éªŒè¯èŠ‚ç‚¹ç­‰çº§ç”Ÿæ•ˆ
        let breakdown = await staking.getUserTierBreakdown(A.address);
        expect(breakdown.isPreacherStatus).to.be.true;
        expect(breakdown.finalTier).to.equal(1);

        // 3. A æå‰æ”¯å–åˆ©æ¯ï¼ˆæœ¬é‡‘ä¸å˜ï¼Œä»æ˜¯ Preacherï¼‰
        await time.increase(15 * 24 * 60 * 60);
        await staking.connect(A).withdrawInterest(0);

        // 4. éªŒè¯ä»æ˜¯ Preacherï¼ŒèŠ‚ç‚¹ç­‰çº§ä»ç”Ÿæ•ˆ
        breakdown = await staking.getUserTierBreakdown(A.address);
        expect(breakdown.isPreacherStatus).to.be.true;
        expect(breakdown.finalTier).to.equal(1);

        // âš ï¸ æ³¨æ„ï¼šå¦‚æœæœªæ¥æ·»åŠ "æå‰å–å›éƒ¨åˆ†æœ¬é‡‘"åŠŸèƒ½ï¼Œéœ€è¦é¢å¤–æµ‹è¯•
    });

    it("åœºæ™¯4: unstake æ­£ç¡®å‡å» withdrawnProfit", async function() {
        // 1. C è´¨æŠ¼ 1000 USDT
        await staking.connect(C).stake(ethers.parseEther("1000"), 1);

        // 2. è®°å½• C çš„åˆå§‹ä½™é¢
        const initialBalance = await usdt.balanceOf(C.address);

        // 3. Day 15 æå–åˆ©æ¯
        await time.increase(15 * 24 * 60 * 60);
        await staking.connect(C).withdrawInterest(0);
        const balanceAfterWithdraw = await usdt.balanceOf(C.address);
        const withdrawnAmount = balanceAfterWithdraw - initialBalance;

        // 4. Day 30 unstake
        await time.increase(15 * 24 * 60 * 60);
        await staking.connect(C).unstake(0);
        const finalBalance = await usdt.balanceOf(C.address);

        // 5. éªŒè¯æ€»æ”¶ç›Š = å®Œæ•´çš„ 30 å¤©æ”¶ç›Š
        const totalReceived = finalBalance - initialBalance;
        const expectedTotal = ethers.parseEther("198.8"); // 30å¤©æ”¶ç›Š

        expect(totalReceived).to.be.closeTo(expectedTotal, ethers.parseEther("1"));

        // 6. éªŒè¯ unstake è¿”å›çš„é‡‘é¢ = æ€»æ”¶ç›Š - å·²æå–
        const unstakeAmount = finalBalance - balanceAfterWithdraw;
        expect(unstakeAmount).to.be.closeTo(
            expectedTotal - withdrawnAmount,
            ethers.parseEther("0.5")
        );
    });

    it("åœºæ™¯5: èŠ‚ç‚¹ç­‰çº§å˜åŒ–ä¸å½±å“å·²æå–çš„ç›ˆåˆ©è®°å½•", async function() {
        // 1. A è·å¾—èŠ‚ç‚¹ç­‰çº§ V1
        await staking.connect(A).stake(ethers.parseEther("200"), 0);
        await staking.connect(tierManager).setNodeTier(A.address, 1);

        // 2. C è´¨æŠ¼å¹¶æå–åˆ©æ¯
        await staking.connect(C).stake(ethers.parseEther("1000"), 1);
        await time.increase(15 * 24 * 60 * 60);
        await staking.connect(C).withdrawInterest(0);

        // 3. ç§»é™¤ A çš„èŠ‚ç‚¹ç­‰çº§
        await staking.connect(tierManager).removeNodeTier(A.address);

        // 4. C unstakeï¼ŒéªŒè¯æ€»æ”¶ç›Šä»æ­£ç¡®
        await time.increase(15 * 24 * 60 * 60);
        const balanceBefore = await usdt.balanceOf(C.address);
        await staking.connect(C).unstake(0);
        const balanceAfter = await usdt.balanceOf(C.address);

        // è™½ç„¶ A çš„èŠ‚ç‚¹ç­‰çº§è¢«ç§»é™¤ï¼ŒC çš„æ€»æ”¶ç›Šä¸å—å½±å“
        const totalReceived = balanceAfter - balanceBefore;
        expect(totalReceived).to.be.gt(0);
    });
});
```

### 5.2 è¾¹ç•Œæ¡ä»¶æµ‹è¯•

```javascript
describe("è¾¹ç•Œæ¡ä»¶æµ‹è¯•", function() {
    it("æå–å…¨éƒ¨ç›ˆåˆ©å unstakeï¼Œåº”åªè¿”å›æœ¬é‡‘", async function() {
        // 1. è´¨æŠ¼ 1000 USDT (1å¤©æ¡£)
        await staking.stake(ethers.parseEther("1000"), 0);

        // 2. 1å¤©åï¼Œæå–å…¨éƒ¨ç›ˆåˆ©
        await time.increase(1 * 24 * 60 * 60);
        const profitAmount = await staking.canWithdrawInterest(user, 0).withdrawableProfit;
        await staking.withdrawInterest(0);

        // 3. ç«‹å³ unstake
        const balanceBefore = await usdt.balanceOf(user);
        await staking.unstake(0);
        const received = (await usdt.balanceOf(user)) - balanceBefore;

        // 4. åº”è¯¥åªæ”¶åˆ°æœ¬é‡‘ï¼ˆæ‰£é™¤è´¹ç”¨åï¼‰
        expect(received).to.be.closeTo(
            ethers.parseEther("1000"),
            ethers.parseEther("50") // å…è®¸è´¹ç”¨è¯¯å·®
        );
    });

    it("èŠ‚ç‚¹ç­‰çº§ç”¨æˆ·æå‰æ”¯å– 0 ç›ˆåˆ©åº” revert", async function() {
        await staking.connect(tierManager).setNodeTier(user, 1);
        await staking.stake(ethers.parseEther("1000"), 0);

        // ç«‹å³å°è¯•æå–ï¼ˆæ— ç›ˆåˆ©ï¼‰
        await expect(
            staking.withdrawInterest(0)
        ).to.be.revertedWith("No new profit to withdraw");
    });
});
```

---

## å…­ã€å®æ–½å»ºè®®

### 6.1 å¼€å‘é¡ºåºï¼ˆæ¨èï¼‰

```
é˜¶æ®µ1: æ•°æ®ç»“æ„ä¿®æ”¹ (1å¤©)
â”œâ”€ ä¿®æ”¹ Record ç»“æ„ä½“ (æ·»åŠ  withdrawnProfit)
â”œâ”€ æ·»åŠ  NodeTierRecord å’Œç›¸å…³ mapping
â”œâ”€ ç¼–è¯‘éªŒè¯
â””â”€ å­˜å‚¨å¸ƒå±€æµ‹è¯•

é˜¶æ®µ2: èŠ‚ç‚¹ç­‰çº§åŠŸèƒ½ (2-3å¤©)
â”œâ”€ å®ç° setTierManager / setNodeTier ç­‰ç®¡ç†å‡½æ•°
â”œâ”€ ä¿®æ”¹ _getUserTier å‡½æ•°
â”œâ”€ æ·»åŠ æŸ¥è¯¢å‡½æ•° (getNodeTierDetails, getUserTierBreakdown)
â””â”€ å•å…ƒæµ‹è¯•ï¼ˆä¸æ¶‰åŠæå‰æ”¯å–ï¼‰

é˜¶æ®µ3: æå‰æ”¯å–åŠŸèƒ½ (3-4å¤©)
â”œâ”€ å®ç° withdrawInterest å‡½æ•°
â”œâ”€ ä¿®æ”¹ unstake å‡½æ•°ï¼ˆå‡å» withdrawnProfitï¼‰
â”œâ”€ æ·»åŠ æŸ¥è¯¢å‡½æ•° (canWithdrawInterest)
â””â”€ å•å…ƒæµ‹è¯•ï¼ˆä¸æ¶‰åŠèŠ‚ç‚¹ç­‰çº§ï¼‰

é˜¶æ®µ4: é›†æˆæµ‹è¯• (2-3å¤©)
â”œâ”€ ç»„åˆåœºæ™¯æµ‹è¯•ï¼ˆèŠ‚ç‚¹ç­‰çº§ + æå‰æ”¯å–ï¼‰
â”œâ”€ è¾¹ç•Œæ¡ä»¶æµ‹è¯•
â”œâ”€ Gas ä¼˜åŒ–æµ‹è¯•
â””â”€ å®¡è®¡å‡†å¤‡

é˜¶æ®µ5: éƒ¨ç½²ä¸Šçº¿ (1-2å¤©)
â”œâ”€ æµ‹è¯•ç½‘éƒ¨ç½²
â”œâ”€ åŠŸèƒ½éªŒè¯
â”œâ”€ ä¸»ç½‘éƒ¨ç½²
â””â”€ ç›‘æ§è®¾ç½®
```

### 6.2 å…³é”®ä»£ç å®¡æŸ¥ç‚¹

```
å¿…é¡»å®¡æŸ¥çš„ä»£ç ï¼š
â–¡ unstake æ˜¯å¦æ­£ç¡®å‡å» withdrawnProfitï¼Ÿ
â–¡ _getUserTier çš„èŠ‚ç‚¹ç­‰çº§é€»è¾‘æ˜¯å¦æ­£ç¡®ï¼Ÿ
â–¡ withdrawInterest æ˜¯å¦æ­£ç¡®è®°å½• withdrawnProfitï¼Ÿ
â–¡ å›¢é˜Ÿå¥–åŠ±åˆ†é…æ˜¯å¦å—èŠ‚ç‚¹ç­‰çº§å½±å“ï¼Ÿ
â–¡ Preacher æ£€æŸ¥æ˜¯å¦åœ¨æ‰€æœ‰å¿…è¦ä½ç½®ï¼Ÿ
â–¡ äº‹ä»¶æ˜¯å¦å®Œæ•´è®°å½•æ‰€æœ‰å…³é”®æ“ä½œï¼Ÿ
â–¡ æ˜¯å¦å­˜åœ¨é‡å…¥æ”»å‡»é£é™©ï¼Ÿ
â–¡ æ˜¯å¦å­˜åœ¨æ•´æ•°æº¢å‡ºé£é™©ï¼Ÿï¼ˆSolidity 0.8+ è‡ªåŠ¨æ£€æŸ¥ï¼‰
```

### 6.3 éƒ¨ç½²å‰æ£€æŸ¥æ¸…å•

```
æ•°æ®ç»“æ„ï¼š
â–¡ Record ç»“æ„ä½“å·²æ­£ç¡®ä¿®æ”¹ï¼ˆæ·»åŠ  withdrawnProfitï¼‰
â–¡ NodeTierRecord å·²å®šä¹‰å¹¶æ·»åŠ åˆ° mapping
â–¡ å­˜å‚¨å¸ƒå±€å…¼å®¹æ€§å·²éªŒè¯

åŠŸèƒ½å®ç°ï¼š
â–¡ withdrawInterest å‡½æ•°å·²å®ç°å¹¶æµ‹è¯•
â–¡ unstake å‡½æ•°å·²ä¿®æ”¹ï¼ˆå‡å» withdrawnProfitï¼‰
â–¡ _getUserTier å‡½æ•°å·²ä¿®æ”¹ï¼ˆèŠ‚ç‚¹ç­‰çº§é€»è¾‘ï¼‰
â–¡ æ‰€æœ‰ç®¡ç†å‡½æ•°å·²å®ç°ï¼ˆsetTierManager, setNodeTier ç­‰ï¼‰

æµ‹è¯•è¦†ç›–ï¼š
â–¡ èŠ‚ç‚¹ç­‰çº§å•ç‹¬æµ‹è¯•é€šè¿‡
â–¡ æå‰æ”¯å–å•ç‹¬æµ‹è¯•é€šè¿‡
â–¡ ç»„åˆåœºæ™¯æµ‹è¯•é€šè¿‡
â–¡ è¾¹ç•Œæ¡ä»¶æµ‹è¯•é€šè¿‡
â–¡ Gas æµ‹è¯•é€šè¿‡

å®‰å…¨å®¡æŸ¥ï¼š
â–¡ ä»£ç å®¡æŸ¥å®Œæˆ
â–¡ é‡å…¥æ”»å‡»æ£€æŸ¥é€šè¿‡
â–¡ æƒé™æ§åˆ¶æ£€æŸ¥é€šè¿‡
â–¡ äº‹ä»¶è®°å½•å®Œæ•´
â–¡ é”™è¯¯å¤„ç†å®Œå–„

æ–‡æ¡£å’Œç›‘æ§ï¼š
â–¡ ç”¨æˆ·æ–‡æ¡£æ›´æ–°
â–¡ æŠ€æœ¯æ–‡æ¡£æ›´æ–°
â–¡ ç›‘æ§ä»ªè¡¨ç›˜é…ç½®
â–¡ å‘Šè­¦è§„åˆ™è®¾ç½®
```

---

## ä¸ƒã€ç»“è®º

### 7.1 å†²çªæ€»ç»“

| å†²çªç±»å‹ | æ˜¯å¦å­˜åœ¨ | ä¸¥é‡ç¨‹åº¦ | è§£å†³æ–¹æ¡ˆ |
|---------|---------|---------|---------|
| æ•°æ®ç»“æ„å†²çª | âŒ æ—  | - | ç‹¬ç«‹ä¿®æ”¹ï¼Œæ— å†²çª |
| å‡½æ•°è°ƒç”¨é“¾å†²çª | âœ… æœ‰ | ğŸŸ¢ ä½ | é€»è¾‘ä¸Šå…¼å®¹ï¼Œæ— éœ€ç‰¹æ®Šå¤„ç† |
| å›¢é˜Ÿå¥–åŠ±è®¡ç®—å†²çª | âŒ æ—  | - | æ•°å­¦éªŒè¯é€šè¿‡ |
| Preacher æ£€æŸ¥å†²çª | âŒ æ—  | - | withdrawInterest ä¸å½±å“æœ¬é‡‘ |
| å¤åˆ©è®¡ç®—å†²çª | âŒ æ—  | - | ä¸¤åŠŸèƒ½éƒ½ä¸ä¿®æ”¹æ ¸å¿ƒå…¬å¼ |

### 7.2 å¿…é¡»åè°ƒçš„ä¿®æ”¹

1. **unstake å‡½æ•°ä¿®æ”¹**ï¼ˆğŸ”´ å¿…é¡»ï¼‰
   - æå‰æ”¯å–åŠŸèƒ½è¦æ±‚ï¼šå‡å» withdrawnProfit
   - èŠ‚ç‚¹ç­‰çº§åŠŸèƒ½è¦æ±‚ï¼šä½¿ç”¨ä¿®æ”¹åçš„ _getUserTier
   - è§£å†³æ–¹æ¡ˆï¼šç»Ÿä¸€åœ¨ unstake ä¸­å®ç°ä¸¤ä¸ªä¿®æ”¹

2. **Record ç»“æ„ä½“ä¿®æ”¹**ï¼ˆğŸ”´ å¿…é¡»ï¼‰
   - æå‰æ”¯å–åŠŸèƒ½è¦æ±‚ï¼šæ·»åŠ  withdrawnProfit å­—æ®µ
   - èŠ‚ç‚¹ç­‰çº§åŠŸèƒ½ï¼šä¸ä¿®æ”¹ Record
   - è§£å†³æ–¹æ¡ˆï¼šæŒ‰æå‰æ”¯å–åŠŸèƒ½çš„è¦æ±‚ä¿®æ”¹

3. **_getUserTier å‡½æ•°ä¿®æ”¹**ï¼ˆğŸ”´ å¿…é¡»ï¼‰
   - èŠ‚ç‚¹ç­‰çº§åŠŸèƒ½è¦æ±‚ï¼šå¢åŠ  MAX(è‡ªç„¶ç­‰çº§, èŠ‚ç‚¹ç­‰çº§) é€»è¾‘
   - æå‰æ”¯å–åŠŸèƒ½ï¼šä¼šé—´æ¥å—å½±å“ï¼ˆé€šè¿‡å›¢é˜Ÿå¥–åŠ±åˆ†é…ï¼‰
   - è§£å†³æ–¹æ¡ˆï¼šæŒ‰èŠ‚ç‚¹ç­‰çº§åŠŸèƒ½çš„è¦æ±‚ä¿®æ”¹

### 7.3 æœ€ç»ˆè¯„ä¼°

**æ€»ä½“é£é™©ç­‰çº§**ï¼šğŸŸ¡ ä¸­ç­‰ï¼ˆéœ€è¦åè°ƒè®¾è®¡ï¼Œä½†æ— è‡´å‘½å†²çªï¼‰

**å¯è¡Œæ€§è¯„ä¼°**ï¼šâœ… **å¯ä»¥åŒæ—¶å®æ–½**

**å…³é”®å‰æ**ï¼š
1. âœ… åˆçº¦å°šæœªéƒ¨ç½²ï¼Œæˆ–å¯ä»¥é‡æ–°éƒ¨ç½²
2. âœ… unstake å‡½æ•°æ­£ç¡®å®ç° withdrawnProfit å‡æ³•
3. âœ… å……åˆ†çš„æµ‹è¯•è¦†ç›–ï¼ˆå•å…ƒæµ‹è¯• + é›†æˆæµ‹è¯•ï¼‰
4. âœ… ä»£ç å®¡æŸ¥å’Œå®‰å…¨å®¡è®¡

**é¢„æœŸæ•ˆæœ**ï¼š
- ç”¨æˆ·ä½“éªŒï¼šâ˜…â˜…â˜…â˜…â˜…ï¼ˆèŠ‚ç‚¹ç­‰çº§ä¿éšœ + çµæ´»æå–ï¼‰
- ç³»ç»Ÿå®‰å…¨ï¼šâ˜…â˜…â˜…â˜…â˜†ï¼ˆéœ€ç›‘æ§æµåŠ¨æ€§å’Œå›¢é˜Ÿå¥–åŠ±ï¼‰
- å®ç°éš¾åº¦ï¼šâ˜…â˜…â˜…â˜†â˜†ï¼ˆä¸­ç­‰ï¼Œéœ€è¦åè°ƒä¸¤ä¸ªåŠŸèƒ½ï¼‰
- Gas æˆæœ¬ï¼šâ˜…â˜…â˜…â˜…â˜†ï¼ˆå¢åŠ  < 10%ï¼Œå¯æ¥å—ï¼‰

**æ¨èåšæ³•**ï¼š
1. å…ˆå®Œæˆæ•°æ®ç»“æ„ä¿®æ”¹
2. å¹¶è¡Œå¼€å‘ä¸¤ä¸ªåŠŸèƒ½ï¼ˆåˆ†åˆ«æµ‹è¯•ï¼‰
3. é›†æˆæµ‹è¯•è¦†ç›–ç»„åˆåœºæ™¯
4. å®¡è®¡åå†éƒ¨ç½²ä¸»ç½‘

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¥æœŸ**: 2025-10-14
**ä½œè€…**: Claude Code
**çŠ¶æ€**: âœ… åˆ†æå®Œæˆï¼Œå»ºè®®åŒæ—¶å®æ–½
