# SYI è´¨æŠ¼ç³»ç»Ÿ - å›¢é˜Ÿæ”¶ç›Šæœºåˆ¶è¯¦è§£

## ç›®å½•
- [æ¦‚è¿°](#æ¦‚è¿°)
- [ç­‰çº§ä½“ç³»](#ç­‰çº§ä½“ç³»)
- [å‡çº§æœºåˆ¶](#å‡çº§æœºåˆ¶)
- [å¥–åŠ±è®¡ç®—](#å¥–åŠ±è®¡ç®—)
- [åˆ†å‘æµç¨‹](#åˆ†å‘æµç¨‹)
- [å®é™…æ¡ˆä¾‹](#å®é™…æ¡ˆä¾‹)
- [ç®¡ç†å‘˜å¼ºåˆ¶æå‡æ–¹æ¡ˆ](#ç®¡ç†å‘˜å¼ºåˆ¶æå‡æ–¹æ¡ˆ)

---

## æ¦‚è¿°

SYI è´¨æŠ¼ç³»ç»Ÿé‡‡ç”¨ **7 çº§å›¢é˜Ÿå¥–åŠ±æœºåˆ¶**ï¼ŒåŸºäº **ä¸¥æ ¼å·®é¢åˆ¶åº¦** åˆ†å‘å›¢é˜Ÿæ”¶ç›Šã€‚æ ¸å¿ƒç‰¹ç‚¹ï¼š

- ğŸ¯ **æ€»å¥–åŠ±æ± **: ç”¨æˆ·è§£è´¨æŠ¼åˆ©æ¯çš„ **35%** ç”¨äºå›¢é˜Ÿå¥–åŠ±
- ğŸ“Š **7ä¸ªç­‰çº§**: V1 åˆ° V7ï¼Œå¥–åŠ±æ¯”ä¾‹ä» 5% é€’å¢åˆ° 35%
- ğŸ”„ **å·®é¢åˆ†å‘**: é«˜ç­‰çº§ç”¨æˆ·ä»…è·å¾—ä¸ä¸‹ä¸€ç­‰çº§çš„å·®é¢éƒ¨åˆ†
- âš¡ **Preacheré—¨æ§›**: å¿…é¡»è´¨æŠ¼ â‰¥ 200 SYI æ‰èƒ½è·å¾—å›¢é˜Ÿå¥–åŠ±
- ğŸ† **KPIé©±åŠ¨**: åŸºäºå›¢é˜Ÿæ€»æŠ•èµ„é¢ï¼ˆteamTotalInvestValueï¼‰å‡çº§

---

## ç­‰çº§ä½“ç³»

### ç­‰çº§é…ç½®è¡¨

| ç­‰çº§ | å›¢é˜ŸKPIé—¨æ§› | ç´¯è®¡å¥–åŠ±æ¯”ä¾‹ | å·®é¢å¥–åŠ± | Preacherè¦æ±‚ |
|------|-------------|--------------|----------|--------------|
| **V1** | 10,000 USDT | 5% | 5% | â‰¥ 200 SYI |
| **V2** | 50,000 USDT | 10% | 5% (10%-5%) | â‰¥ 200 SYI |
| **V3** | 200,000 USDT | 15% | 5% (15%-10%) | â‰¥ 200 SYI |
| **V4** | 500,000 USDT | 20% | 5% (20%-15%) | â‰¥ 200 SYI |
| **V5** | 1,000,000 USDT | 25% | 5% (25%-20%) | â‰¥ 200 SYI |
| **V6** | 2,500,000 USDT | 30% | 5% (30%-25%) | â‰¥ 200 SYI |
| **V7** | 5,000,000 USDT | 35% | 5% (35%-30%) | â‰¥ 200 SYI |

### å…³é”®ä»£ç ä½ç½®

**ç­‰çº§é—¨æ§›å®šä¹‰**: `contracts/SYI-Staking/mainnet/Staking.sol:65-91`
```solidity
function getTeamThresholdTier1() internal pure override returns (uint256) {
    return 10_000 ether; // V1
}
// ... V2 åˆ° V7
```

**å¥–åŠ±æ¯”ä¾‹å®šä¹‰**: `contracts/SYI-Staking/abstract/StakingBase.sol:67-73`
```solidity
uint256 internal constant TEAM_REWARD_TIER_1 = 5;  // V1: 5%
uint256 internal constant TEAM_REWARD_TIER_2 = 10; // V2: 10%
// ... åˆ° V7: 35%
```

---

## å‡çº§æœºåˆ¶

### å‡çº§æ¡ä»¶ï¼ˆåŒæ—¶æ»¡è¶³ï¼‰

```mermaid
graph TD
    A[ç”¨æˆ·] --> B{æ£€æŸ¥1: æ˜¯å¦ä¸ºPreacher?}
    B -->|å¦| C[ç­‰çº§ = 0<br/>æ— æ³•è·å¾—å›¢é˜Ÿå¥–åŠ±]
    B -->|æ˜¯| D{æ£€æŸ¥2: teamKPI â‰¥ ç­‰çº§é—¨æ§›?}
    D -->|å¦| E[ä¿æŒå½“å‰ç­‰çº§]
    D -->|æ˜¯| F[æ™‹å‡åˆ°å¯¹åº”ç­‰çº§]

    style C fill:#ff6b6b
    style E fill:#ffd93d
    style F fill:#6bcf7f
```

### 1. Preacher èµ„æ ¼

**å®šä¹‰**: `StakingBase.sol:669-671`
```solidity
function isPreacher(address user) public view override returns (bool) {
    return currentStakeValue(user) >= PREACHER_THRESHOLD; // 200 SYI
}
```

- **è¦æ±‚**: ç”¨æˆ·å½“å‰è´¨æŠ¼ä»·å€¼ â‰¥ 200 SYI
- **åŠ¨æ€æ£€æŸ¥**: æ¯æ¬¡åˆ†å‘å¥–åŠ±æ—¶å®æ—¶æ£€æŸ¥
- **å¤±å»èµ„æ ¼**: å¦‚æœè´¨æŠ¼ä½äº 200 SYIï¼Œå³ä½¿è¾¾åˆ° KPI ä¹Ÿæ— æ³•è·å¾—å¥–åŠ±

### 2. å›¢é˜Ÿ KPI è®¡ç®—

**æ ¸å¿ƒå˜é‡**: `teamTotalInvestValue[address]` - è®°å½•ç”¨æˆ·å›¢é˜Ÿçš„ç´¯è®¡æŠ•èµ„æ€»é¢

#### KPI ç´¯åŠ æ—¶æœºï¼ˆè´¨æŠ¼æ—¶ï¼‰
`StakingBase.sol:804-820`
```solidity
function _updateTeamInvestmentValues(
    address user,
    uint256 amount,
    bool isIncrease
) internal {
    address[] memory referralChain = getReferrals(user, maxD);
    for (uint8 i = 0; i < referralChain.length; ) {
        unchecked {
            if (isIncrease) {
                teamTotalInvestValue[referralChain[i]] += amount;
            } else {
                teamTotalInvestValue[referralChain[i]] -= amount;
            }
            ++i;
        }
    }
}
```

**æµç¨‹è¯´æ˜**:
1. ç”¨æˆ· A è´¨æŠ¼ 1000 USDT
2. è·å– A çš„æ¨èé“¾ï¼ˆæœ€å¤š 30 å±‚ï¼‰ï¼š`[B, C, D, ...]`
3. å°† 1000 USDT **ä¾æ¬¡ç´¯åŠ **åˆ° Bã€Cã€D... çš„ `teamTotalInvestValue`
4. è§£è´¨æŠ¼æ—¶ï¼Œæ‰§è¡Œ**ç›¸åæ“ä½œ**ï¼ˆå‡å»é‡‘é¢ï¼‰

#### ç­‰çº§åˆ¤æ–­é€»è¾‘
`StakingBase.sol:1255-1273`
```solidity
function _getUserTier(address user) private view returns (uint8 tier) {
    // æ¡ä»¶1: rootAddress æˆ–é Preacherï¼Œç­‰çº§ä¸º 0
    if (user == rootAddress || !isPreacher(user)) {
        return 0;
    }

    // æ¡ä»¶2: æ ¹æ® teamKPI åŒ¹é…ç­‰çº§ï¼ˆä»é«˜åˆ°ä½æ£€æŸ¥ï¼‰
    uint256 teamKPI = getTeamKpi(user);
    IStaking.TeamTier[7] memory tiers = _getTeamTiers();

    for (uint256 i = 0; i < tiers.length; ) {
        if (teamKPI >= tiers[i].threshold) {
            return uint8(7 - i); // è¿”å›ç­‰çº§ 1-7
        }
        unchecked {
            ++i;
        }
    }

    return 0; // æœªè¾¾åˆ°ä»»ä½•é—¨æ§›
}
```

---

## å¥–åŠ±è®¡ç®—

### å¥–åŠ±æ¥æº

å½“ç”¨æˆ·è§£é™¤è´¨æŠ¼ï¼ˆunstakeï¼‰æ—¶ï¼Œäº§ç”Ÿçš„**åˆ©æ¯æ”¶ç›Š**ä¼šè¢«åˆ†æˆä¸‰éƒ¨åˆ†ï¼š

```
æ€»åˆ©æ¯æ”¶ç›Š (interestEarned)
â”‚
â”œâ”€ 5% â†’ Friend ç›´æ¨å¥–åŠ±
â”œâ”€ 35% â†’ å›¢é˜Ÿå¥–åŠ±æ±  (ç”¨äºåˆ†å‘å›¢é˜Ÿæ”¶ç›Š)
â””â”€ 60% â†’ ç”¨æˆ·æœ¬äºº
```

**ä»£ç ä½ç½®**: `StakingBase.sol:202-264`
```solidity
function unstake(uint256 stakeIndex) external onlyEOA returns (uint256 totalReward) {
    // 1. è®¡ç®—æœ¬é‡‘å’Œæ”¶ç›Š
    (uint256 calculatedReward, uint256 principalAmount) = _burn(stakeIndex);
    (uint256 usdtReceived, uint256 syiTokensUsed) = _swapSYIForReward(calculatedReward);

    // 2. è®¡ç®—åˆ©æ¯
    uint256 interestEarned = usdtReceived > principalAmount
        ? usdtReceived - principalAmount
        : 0;

    // 3. åˆ†å‘å¥–åŠ±
    address[] memory referralChain = getReferrals(msg.sender, maxD);
    uint256 friendReward = _distributeFriendReward(msg.sender, interestEarned);    // 5%
    uint256 teamFee = _distributeTeamReward(referralChain, interestEarned);        // 35%

    // 4. ç”¨æˆ·å®é™…åˆ°æ‰‹
    uint256 userPayout = usdtReceived - friendReward - teamFee;
    IERC20(USDT).transfer(msg.sender, userPayout);
}
```

### å·®é¢åˆ¶åº¦è¯¦è§£

å‡è®¾æ¨èé“¾ä¸Šæœ‰ä»¥ä¸‹ç”¨æˆ·ï¼ˆä»ä¸‹åˆ°ä¸Šï¼‰ï¼š

```
ç”¨æˆ·D (è§£è´¨æŠ¼è€…)
  â†“ (æ¨èäºº)
ç”¨æˆ·C: V3ç­‰çº§ (team KPI = 250,000 USDT)
  â†“
ç”¨æˆ·B: V1ç­‰çº§ (team KPI = 15,000 USDT)
  â†“
ç”¨æˆ·A: V5ç­‰çº§ (team KPI = 1,200,000 USDT)
```

ç”¨æˆ·D è§£è´¨æŠ¼ï¼Œäº§ç”Ÿåˆ©æ¯ 1000 USDTï¼Œå›¢é˜Ÿå¥–åŠ±æ±  = **1000 Ã— 35% = 350 USDT**

#### åˆ†å‘è®¡ç®—

| é¡ºåº | ç”¨æˆ· | ç­‰çº§ | ç´¯è®¡æ¯”ä¾‹ | å·²åˆ†é…æ¯”ä¾‹ | å·®é¢ | å®é™…è·å¾— |
|------|------|------|----------|-----------|------|----------|
| 1 | C | V3 | 15% | 0% | 15% | 1000 Ã— 15% = 150 USDT |
| 2 | B | V1 | 5% | 15% | 0% | 0 USDT (å·²è¢«Cè¦†ç›–) |
| 3 | A | V5 | 25% | 15% | 10% | 1000 Ã— 10% = 100 USDT |
| å‰©ä½™ | rootAddress | - | - | 25% | 10% | 1000 Ã— 10% = 100 USDT |

**æ ¸å¿ƒè§„åˆ™**:
- æ¨èé“¾**ä»ä¸‹å¾€ä¸Š**æ‰«æï¼Œå…ˆé‡åˆ°çš„é«˜ç­‰çº§ç”¨æˆ·ä¼˜å…ˆåˆ†é…
- æ¯ä¸ªç­‰çº§åªèƒ½è¢«åˆ†é…**ä¸€æ¬¡**
- ç”¨æˆ·åªèƒ½è·å¾— **(è‡ªå·±ç­‰çº§æ¯”ä¾‹ - å·²åˆ†é…æ¯”ä¾‹)** çš„å·®é¢éƒ¨åˆ†
- æœªåˆ†é…çš„éƒ¨åˆ†å½’ `rootAddress`ï¼ˆé¡¹ç›®æ–¹ï¼‰

---

## åˆ†å‘æµç¨‹

### å®Œæ•´æµç¨‹å›¾

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·D<br/>(è§£è´¨æŠ¼)
    participant SC as Stakingåˆçº¦
    participant C1 as ç”¨æˆ·C (V3)
    participant C2 as ç”¨æˆ·B (V1)
    participant C3 as ç”¨æˆ·A (V5)
    participant Root as rootAddress

    U->>SC: unstake(stakeIndex)
    SC->>SC: è®¡ç®—æ”¶ç›Š<br/>interestEarned = 1000 USDT
    SC->>SC: teamRewardPool = 1000 Ã— 35% = 350 USDT

    Note over SC: è·å–æ¨èé“¾: [C, B, A, ...]

    SC->>SC: è®¡ç®—å„æˆå‘˜ç­‰çº§<br/>C=V3, B=V1, A=V5

    Note over SC: å¼€å§‹å·®é¢åˆ†å‘å¾ªç¯

    SC->>C1: æ£€æŸ¥: V3ç­‰çº§ + Preacher âœ“
    SC->>SC: å·®é¢ = 15% - 0% = 15%
    SC->>C1: è½¬è´¦ 1000 Ã— 15% = 150 USDT
    SC->>SC: å·²åˆ†é…ç´¯è®¡ = 15%

    SC->>C2: æ£€æŸ¥: V1ç­‰çº§ + Preacher âœ“
    SC->>SC: å·®é¢ = 5% - 15% = -10% (è·³è¿‡)
    Note over C2: è¢«æ›´é«˜ç­‰çº§è¦†ç›–ï¼Œæ— å¥–åŠ±

    SC->>C3: æ£€æŸ¥: V5ç­‰çº§ + Preacher âœ“
    SC->>SC: å·®é¢ = 25% - 15% = 10%
    SC->>C3: è½¬è´¦ 1000 Ã— 10% = 100 USDT
    SC->>SC: å·²åˆ†é…ç´¯è®¡ = 25%

    SC->>Root: å‰©ä½™éƒ¨åˆ†<br/>(35% - 25%) Ã— 1000 = 100 USDT

    SC->>U: ç”¨æˆ·å®é™…åˆ°æ‰‹<br/>60% Ã— 1000 = 600 USDT
```

### æ ¸å¿ƒä»£ç åˆ†æ

**ä¸»åˆ†å‘å‡½æ•°**: `StakingBase.sol:1014-1078`
```solidity
function _distributeTeamReward(
    address[] memory referralChain,
    uint256 _interset  // ç”¨æˆ·åˆ©æ¯æ”¶ç›Š
) private returns (uint256 fee) {
    unchecked {
        fee = (_interset * MAX_TEAM_REWARD_RATE) / PERCENTAGE_BASE; // 35%
    }

    if (referralChain.length == 0) {
        IERC20(USDT).transfer(rootAddress, fee);
        return fee;
    }

    // 1. è·å–æ¨èé“¾ä¸Šæ‰€æœ‰æˆå‘˜çš„ç­‰çº§
    uint8[] memory memberTiers = new uint8[](referralChain.length);
    for (uint256 i = 0; i < referralChain.length; ) {
        memberTiers[i] = _getUserTier(referralChain[i]);
        unchecked { ++i; }
    }

    // 2. æ‰§è¡Œæ··åˆå¥–åŠ±åˆ†å‘ï¼ˆå·®é¢åˆ¶ï¼‰
    (
        uint256 totalDistributed,
        address[7] memory tierRecipients,
        uint256[7] memory tierAmounts,
        uint8 activeTiers
    ) = _distributeHybridRewards(referralChain, memberTiers, _interset);

    // 3. å‰©ä½™éƒ¨åˆ†ç»™ rootAddress
    uint256 marketingAmount = 0;
    if (totalDistributed < fee) {
        marketingAmount = fee - totalDistributed;
        IERC20(USDT).transfer(rootAddress, marketingAmount);
    }

    emit TeamRewardDistributionCompleted(...);
    return fee;
}
```

**å·®é¢åˆ†å‘é€»è¾‘**: `StakingBase.sol:1080-1165`
```solidity
function _distributeHybridRewards(
    address[] memory referralChain,
    uint8[] memory memberTiers,
    uint256 _interset
) private returns (
    uint256 totalDistributed,
    address[7] memory tierRecipients,
    uint256[7] memory tierAmounts,
    uint8 activeTiers
) {
    bool[8] memory tierAllocated;
    uint256 cumulativeAllocatedRate = 0;

    for (uint256 i = 0; i < referralChain.length; ) {
        uint8 currentTier = memberTiers[i];

        // æ¡ä»¶1: ç­‰çº§ > 0
        // æ¡ä»¶2: è¯¥ç­‰çº§æœªè¢«åˆ†é…
        // æ¡ä»¶3: æ˜¯ Preacher
        if (
            currentTier > 0 &&
            !tierAllocated[currentTier] &&
            isPreacher(referralChain[i])
        ) {
            uint256 tierRewardRate = _getTierRewardRate(currentTier);
            uint256 actualRewardRate;

            // è®¡ç®—å·®é¢å¥–åŠ±
            if (tierRewardRate > cumulativeAllocatedRate) {
                actualRewardRate = tierRewardRate - cumulativeAllocatedRate;
            } else {
                actualRewardRate = 0;
            }

            if (actualRewardRate > 0) {
                uint256 memberReward = (_interset * actualRewardRate) / PERCENTAGE_BASE;

                if (memberReward > 0) {
                    IERC20(USDT).transfer(referralChain[i], memberReward);
                    totalDistributed += memberReward;

                    tierRecipients[currentTier - 1] = referralChain[i];
                    tierAmounts[currentTier - 1] = memberReward;

                    emit StrictDifferentialRewardPaid(...);
                }
            }

            tierAllocated[currentTier] = true;
            cumulativeAllocatedRate = tierRewardRate;
        }

        unchecked { ++i; }
    }
}
```

### å…³é”®æ£€æŸ¥ç‚¹

1. **Preacher æ£€æŸ¥å¤±è´¥äº‹ä»¶**:
   ```solidity
   if (currentTier > 0 && !tierAllocated[currentTier] && !isPreacher(referralChain[i])) {
       emit PreacherCheckFailed(
           referralChain[i],
           currentTier,
           "INSUFFICIENT_PREACHER_STATUS"
       );
   }
   ```
   - å¦‚æœç”¨æˆ·è¾¾åˆ°ç­‰çº§é—¨æ§›ä½†ä¸æ˜¯ Preacherï¼Œä¼šè§¦å‘å¤±è´¥äº‹ä»¶

2. **ç­‰çº§å»é‡**: ä½¿ç”¨ `bool[8] memory tierAllocated` ç¡®ä¿æ¯ä¸ªç­‰çº§åªåˆ†é…ä¸€æ¬¡

3. **ç´¯è®¡è¿½è¸ª**: `cumulativeAllocatedRate` è®°å½•å·²åˆ†é…çš„ç´¯è®¡æ¯”ä¾‹

---

## å®é™…æ¡ˆä¾‹

### æ¡ˆä¾‹ 1: å®Œæ•´åˆ†å‘åœºæ™¯

**æ¨èå…³ç³»æ ‘**:
```
Root (V7, 8M KPI)
  â†“
Alice (V5, 1.5M KPI, 250 SYIè´¨æŠ¼)
  â†“
Bob (V2, 80K KPI, 300 SYIè´¨æŠ¼)
  â†“
Charlie (V1, 12K KPI, 500 SYIè´¨æŠ¼)
  â†“
David (0, è§£è´¨æŠ¼è€…)
```

**David è§£è´¨æŠ¼æ•°æ®**:
- æœ¬é‡‘: 10,000 USDT
- æ”¶ç›Š: 12,000 USDT
- åˆ©æ¯: **2,000 USDT**

#### åˆ†å‘è®¡ç®—

| æ­¥éª¤ | æ£€æŸ¥å¯¹è±¡ | ç­‰çº§ | Preacher | ç´¯è®¡æ¯”ä¾‹ | å·²åˆ†é… | å·®é¢ | å®é™…å¥–åŠ± |
|------|----------|------|----------|----------|--------|------|----------|
| 1 | Charlie | V1 | âœ“ (500 SYI) | 5% | 0% | **5%** | 2000 Ã— 5% = **100 USDT** |
| 2 | Bob | V2 | âœ“ (300 SYI) | 10% | 5% | **5%** | 2000 Ã— 5% = **100 USDT** |
| 3 | Alice | V5 | âœ“ (250 SYI) | 25% | 10% | **15%** | 2000 Ã— 15% = **300 USDT** |
| 4 | Root | V7 | - | 35% | 25% | **10%** | 2000 Ã— 10% = **200 USDT** |

**David å®é™…åˆ°æ‰‹**:
- Friend å¥–åŠ±: 2000 Ã— 5% = 100 USDT (å‡è®¾ç»‘å®šäº† friend)
- å›¢é˜Ÿå¥–åŠ±: 2000 Ã— 35% = 700 USDT (å·²åˆ†å‘ç»™ä¸Šçº§)
- **ç”¨æˆ·å‡€æ”¶ç›Š**: 12,000 - 100 - 700 = **11,200 USDT**

---

### æ¡ˆä¾‹ 2: Preacher èµ„æ ¼å¤±æ•ˆ

**æ¨èé“¾**:
```
Alice (V3, 250K KPI, 150 SYIè´¨æŠ¼) â† ä¸æ˜¯ Preacher!
  â†“
Bob (V1, 20K KPI, 500 SYIè´¨æŠ¼)
  â†“
Charlie (è§£è´¨æŠ¼è€…, åˆ©æ¯ 1000 USDT)
```

#### åˆ†å‘è®¡ç®—

| æ­¥éª¤ | æ£€æŸ¥å¯¹è±¡ | ç­‰çº§ | Preacher | ç»“æœ |
|------|----------|------|----------|------|
| 1 | Bob | V1 | âœ“ (500 SYI) | è·å¾— 1000 Ã— 5% = 50 USDT |
| 2 | Alice | V3 | âœ— (150 SYI) | **è·³è¿‡**ï¼ˆè§¦å‘ PreacherCheckFailed äº‹ä»¶ï¼‰|
| 3 | Root | - | - | è·å¾— 1000 Ã— (35% - 5%) = 300 USDT |

**å…³é”®ç‚¹**: Alice è™½ç„¶è¾¾åˆ° V3 é—¨æ§›ï¼ˆ250K KPIï¼‰ï¼Œä½†å› è´¨æŠ¼ä¸è¶³ 200 SYIï¼Œæ— æ³•è·å¾—å›¢é˜Ÿå¥–åŠ±ã€‚

---

### æ¡ˆä¾‹ 3: ç­‰çº§è¦†ç›–

**æ¨èé“¾**:
```
Alice (V5, 1.2M KPI, 300 SYI)
  â†“
Bob (V1, 15K KPI, 400 SYI)
  â†“
Carol (V3, 300K KPI, 250 SYI)
  â†“
David (è§£è´¨æŠ¼è€…, åˆ©æ¯ 1000 USDT)
```

#### åˆ†å‘è®¡ç®—

| æ­¥éª¤ | æ£€æŸ¥å¯¹è±¡ | ç­‰çº§ | ç´¯è®¡æ¯”ä¾‹ | å·²åˆ†é… | å·®é¢ | å®é™…å¥–åŠ± |
|------|----------|------|----------|--------|------|----------|
| 1 | Carol | V3 | 15% | 0% | 15% | 1000 Ã— 15% = **150 USDT** |
| 2 | Bob | V1 | 5% | 15% | -10% | **0 USDT** (è¢«Carolè¦†ç›–) |
| 3 | Alice | V5 | 25% | 15% | 10% | 1000 Ã— 10% = **100 USDT** |
| 4 | Root | - | - | - | 10% | 1000 Ã— 10% = **100 USDT** |

**ç»“è®º**: Bob è™½ç„¶æ˜¯ V1ï¼Œä½†å› ä¸ºä¸‹çº§ Carol æ˜¯ V3ï¼ˆæ›´é«˜ç­‰çº§ï¼‰ï¼ŒBob çš„ 5% å¥–åŠ±è¢« Carol çš„ 15% å®Œå…¨è¦†ç›–ã€‚

---

## ç®¡ç†å‘˜å¼ºåˆ¶æå‡æ–¹æ¡ˆ

### éœ€æ±‚åˆ†æ

**ç›®æ ‡**: å…è®¸ç®¡ç†å‘˜ä¸ºç‰¹å®šåœ°å€å¼ºåˆ¶æå‡ç­‰çº§ï¼Œä»…é™ **V1** å’Œ **V2**ã€‚

**åº”ç”¨åœºæ™¯**:
- æ—©æœŸç”¨æˆ·æ¿€åŠ±
- å¸‚åœºæ¨å¹¿æ´»åŠ¨å¥–åŠ±
- æˆ˜ç•¥åˆä½œä¼™ä¼´ç‰¹æƒ
- ç¤¾åŒºè´¡çŒ®è€…å¥–åŠ±

### å®ç°æ–¹æ¡ˆ

#### æ–¹æ¡ˆ A: å¢åŠ è¦†ç›–ç­‰çº§æ˜ å°„ï¼ˆæ¨èï¼‰

**éš¾åº¦**: â­â­â˜†â˜†â˜† (ç®€å•)

**æ ¸å¿ƒæ€è·¯**:
- å¢åŠ  `mapping(address => uint8) public manualTierOverride`
- ä¿®æ”¹ `_getUserTier` å‡½æ•°ï¼Œä¼˜å…ˆè¿”å›æ‰‹åŠ¨è®¾ç½®çš„ç­‰çº§
- é™åˆ¶åªèƒ½è®¾ç½®ä¸º 1 æˆ– 2

**ä»£ç å®ç°**:

```solidity
// åœ¨ StakingBase ä¸­æ·»åŠ çŠ¶æ€å˜é‡
mapping(address => uint8) public manualTierOverride;

// æ·»åŠ ç®¡ç†å‡½æ•°
function setManualTier(
    address user,
    uint8 tier
) external onlyOwner {
    require(tier >= 1 && tier <= 2, "Only tier 1 or 2 allowed");
    require(user != address(0), "Invalid address");

    manualTierOverride[user] = tier;
    emit ManualTierSet(user, tier);
}

function removeManualTier(address user) external onlyOwner {
    delete manualTierOverride[user];
    emit ManualTierRemoved(user);
}

// ä¿®æ”¹ _getUserTier å‡½æ•°
function _getUserTier(address user) private view returns (uint8 tier) {
    // 1. æ£€æŸ¥æ‰‹åŠ¨è®¾ç½®çš„ç­‰çº§ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰
    uint8 manualTier = manualTierOverride[user];
    if (manualTier > 0) {
        // ä»ç„¶éœ€è¦æ»¡è¶³ Preacher æ¡ä»¶
        if (isPreacher(user)) {
            return manualTier;
        } else {
            // å¦‚æœä¸æ˜¯ Preacherï¼Œæ‰‹åŠ¨ç­‰çº§å¤±æ•ˆ
            return 0;
        }
    }

    // 2. rootAddress æˆ–é Preacher
    if (user == rootAddress || !isPreacher(user)) {
        return 0;
    }

    // 3. æ ¹æ® teamKPI è‡ªåŠ¨è®¡ç®—ç­‰çº§
    uint256 teamKPI = getTeamKpi(user);
    IStaking.TeamTier[7] memory tiers = _getTeamTiers();

    for (uint256 i = 0; i < tiers.length; ) {
        if (teamKPI >= tiers[i].threshold) {
            return uint8(7 - i);
        }
        unchecked {
            ++i;
        }
    }

    return 0;
}
```

**ä¼˜ç‚¹**:
- âœ… ç®€å•ç›´æ¥ï¼Œä¸å½±å“ç°æœ‰é€»è¾‘
- âœ… å¯ä»¥éšæ—¶å¯ç”¨/ç¦ç”¨
- âœ… ä¿ç•™ Preacher æ£€æŸ¥ï¼ˆç”¨æˆ·ä»éœ€è´¨æŠ¼ â‰¥ 200 SYIï¼‰
- âœ… ä¸å½±å“è‡ªç„¶æ™‹å‡æœºåˆ¶

**ç¼ºç‚¹**:
- âŒ éœ€è¦éƒ¨ç½²æ–°åˆçº¦æˆ–å‡çº§ä»£ç†

---

#### æ–¹æ¡ˆ B: è™šæ‹Ÿ KPI åŠ æˆ

**éš¾åº¦**: â­â­â­â˜†â˜† (ä¸­ç­‰)

**æ ¸å¿ƒæ€è·¯**:
- å¢åŠ  `mapping(address => uint256) public virtualKPIBonus`
- è®¡ç®—ç­‰çº§æ—¶ï¼Œå°† `virtualKPIBonus` åŠ åˆ°å®é™… `teamTotalInvestValue`

**ä»£ç å®ç°**:

```solidity
// çŠ¶æ€å˜é‡
mapping(address => uint256) public virtualKPIBonus;

// ç®¡ç†å‡½æ•°
function grantVirtualKPI(
    address user,
    uint256 bonusAmount
) external onlyOwner {
    require(user != address(0), "Invalid address");

    // é™åˆ¶ï¼šåªèƒ½æå‡åˆ° V1 æˆ– V2
    uint256 maxBonus = getTeamThresholdTier2(); // 50,000 USDT
    require(
        virtualKPIBonus[user] + bonusAmount <= maxBonus,
        "Bonus exceeds V2 threshold"
    );

    virtualKPIBonus[user] += bonusAmount;
    emit VirtualKPIGranted(user, bonusAmount);
}

function revokeVirtualKPI(address user) external onlyOwner {
    delete virtualKPIBonus[user];
    emit VirtualKPIRevoked(user);
}

// ä¿®æ”¹ getTeamKpi å‡½æ•°
function getTeamKpi(address _user) public view returns (uint256) {
    return teamTotalInvestValue[_user] + virtualKPIBonus[_user];
}
```

**ä¼˜ç‚¹**:
- âœ… ä¸ç°æœ‰é€»è¾‘æ— ç¼é›†æˆ
- âœ… ç”¨æˆ·å¯ä»¥é€šè¿‡å®é™…å›¢é˜Ÿä¸šç»©ç»§ç»­å‡çº§
- âœ… æ›´ç¬¦åˆ"å›¢é˜ŸKPI"çš„è¯­ä¹‰

**ç¼ºç‚¹**:
- âŒ éœ€è¦ç²¾ç¡®è®¡ç®—åŠ æˆé‡‘é¢
- âŒ å¯èƒ½è¢«è¯¯è§£ä¸ºå®é™…å›¢é˜ŸæŠ•èµ„

---

#### æ–¹æ¡ˆ C: ä¸´æ—¶ç­‰çº§æå‡ï¼ˆæ—¶é—´é™åˆ¶ï¼‰

**éš¾åº¦**: â­â­â­â­â˜† (å¤æ‚)

**æ ¸å¿ƒæ€è·¯**:
- è®¾ç½®ä¸´æ—¶ç­‰çº§ï¼Œå¸¦æœ‰è¿‡æœŸæ—¶é—´
- è¿‡æœŸåè‡ªåŠ¨æ¢å¤ä¸ºè‡ªç„¶ç­‰çº§

**ä»£ç å®ç°**:

```solidity
struct TemporaryTier {
    uint8 tier;
    uint40 expiryTime;
}

mapping(address => TemporaryTier) public temporaryTiers;

function grantTemporaryTier(
    address user,
    uint8 tier,
    uint256 durationDays
) external onlyOwner {
    require(tier >= 1 && tier <= 2, "Only tier 1 or 2");
    require(durationDays > 0 && durationDays <= 365, "Invalid duration");

    temporaryTiers[user] = TemporaryTier({
        tier: tier,
        expiryTime: uint40(block.timestamp + durationDays * 1 days)
    });

    emit TemporaryTierGranted(user, tier, durationDays);
}

function _getUserTier(address user) private view returns (uint8 tier) {
    // æ£€æŸ¥ä¸´æ—¶ç­‰çº§
    TemporaryTier memory tempTier = temporaryTiers[user];
    if (tempTier.tier > 0 && block.timestamp < tempTier.expiryTime) {
        if (isPreacher(user)) {
            return tempTier.tier;
        }
    }

    // ... å…¶ä»–é€»è¾‘
}
```

**ä¼˜ç‚¹**:
- âœ… è‡ªåŠ¨è¿‡æœŸï¼Œæ— éœ€æ‰‹åŠ¨æ’¤é”€
- âœ… é€‚åˆé™æ—¶æ´»åŠ¨

**ç¼ºç‚¹**:
- âŒ å®ç°å¤æ‚
- âŒ éœ€è¦é¢å¤–çš„è¿‡æœŸç®¡ç†

---

### æ¨èæ–¹æ¡ˆæ€»ç»“

| æ–¹æ¡ˆ | éš¾åº¦ | çµæ´»æ€§ | å®ç°æˆæœ¬ | é€‚ç”¨åœºæ™¯ |
|------|------|--------|----------|----------|
| **æ–¹æ¡ˆ A: è¦†ç›–æ˜ å°„** | â­â­ | â­â­â­â­â­ | **æœ€ä½** | **æ¨èé¦–é€‰** |
| æ–¹æ¡ˆ B: è™šæ‹ŸKPI | â­â­â­ | â­â­â­ | ä¸­ç­‰ | é•¿æœŸæ¿€åŠ± |
| æ–¹æ¡ˆ C: ä¸´æ—¶æå‡ | â­â­â­â­ | â­â­â­â­ | è¾ƒé«˜ | é™æ—¶æ´»åŠ¨ |

**æœ€ç»ˆå»ºè®®**: **é€‰æ‹©æ–¹æ¡ˆ A**

**ç†ç”±**:
1. **ä»£ç é‡æœ€å°‘**: åªéœ€å¢åŠ  1 ä¸ª mapping + 3 ä¸ªå‡½æ•°ï¼ˆçº¦ 30 è¡Œä»£ç ï¼‰
2. **é€»è¾‘æ¸…æ™°**: ä¼˜å…ˆçº§æ˜ç¡®ï¼ˆæ‰‹åŠ¨ > è‡ªåŠ¨ï¼‰
3. **æ˜“äºæµ‹è¯•**: ä¸æ¶‰åŠæ—¶é—´ä¾èµ–
4. **æ˜“äºç®¡ç†**: å¯éšæ—¶å¯ç”¨/ç¦ç”¨
5. **ä¿ç•™å®‰å…¨æ£€æŸ¥**: ä»éœ€æ»¡è¶³ Preacher æ¡ä»¶ï¼ˆé˜²æ­¢æ»¥ç”¨ï¼‰

---

## å®ç°æ–¹æ¡ˆ A çš„å®Œæ•´è¡¥ä¸

### ä¿®æ”¹æ–‡ä»¶: `contracts/SYI-Staking/abstract/StakingBase.sol`

#### 1. æ·»åŠ çŠ¶æ€å˜é‡ï¼ˆç¬¬ 134 è¡Œåï¼‰

```solidity
// Manual tier override system (V1-V2 only)
mapping(address => uint8) public manualTierOverride;
```

#### 2. æ·»åŠ äº‹ä»¶ï¼ˆç¬¬ 155 è¡Œåï¼‰

```solidity
event ManualTierSet(address indexed user, uint8 tier, address indexed operator);
event ManualTierRemoved(address indexed user, address indexed operator);
```

#### 3. æ·»åŠ ç®¡ç†å‡½æ•°ï¼ˆç¬¬ 1420 è¡Œåï¼‰

```solidity
/**
 * @notice ä¸ºæŒ‡å®šåœ°å€è®¾ç½®æ‰‹åŠ¨ç­‰çº§ï¼ˆä»…é™ V1-V2ï¼‰
 * @param user ç›®æ ‡ç”¨æˆ·åœ°å€
 * @param tier ç­‰çº§ (1 æˆ– 2)
 * @dev ç”¨æˆ·ä»éœ€æ»¡è¶³ Preacher æ¡ä»¶ï¼ˆâ‰¥ 200 SYIï¼‰æ‰èƒ½ç”Ÿæ•ˆ
 */
function setManualTier(
    address user,
    uint8 tier
) external onlyOwner {
    require(tier >= 1 && tier <= 2, "Manual tier: only 1 or 2 allowed");
    require(user != address(0), "Manual tier: invalid address");
    require(user != rootAddress, "Manual tier: cannot set for root");

    manualTierOverride[user] = tier;
    emit ManualTierSet(user, tier, msg.sender);
}

/**
 * @notice ç§»é™¤æ‰‹åŠ¨ç­‰çº§è®¾ç½®ï¼Œæ¢å¤ä¸ºè‡ªç„¶ç­‰çº§
 * @param user ç›®æ ‡ç”¨æˆ·åœ°å€
 */
function removeManualTier(address user) external onlyOwner {
    require(manualTierOverride[user] > 0, "Manual tier: no override exists");

    delete manualTierOverride[user];
    emit ManualTierRemoved(user, msg.sender);
}

/**
 * @notice æ‰¹é‡è®¾ç½®æ‰‹åŠ¨ç­‰çº§
 * @param users ç”¨æˆ·åœ°å€æ•°ç»„
 * @param tiers å¯¹åº”ç­‰çº§æ•°ç»„
 */
function batchSetManualTier(
    address[] calldata users,
    uint8[] calldata tiers
) external onlyOwner {
    require(users.length == tiers.length, "Array length mismatch");
    require(users.length > 0 && users.length <= 100, "Batch size: 1-100");

    for (uint256 i = 0; i < users.length; ) {
        require(tiers[i] >= 1 && tiers[i] <= 2, "Invalid tier");
        require(users[i] != address(0), "Invalid address");

        manualTierOverride[users[i]] = tiers[i];
        emit ManualTierSet(users[i], tiers[i], msg.sender);

        unchecked { ++i; }
    }
}

/**
 * @notice æŸ¥è¯¢ç”¨æˆ·çš„æ‰‹åŠ¨ç­‰çº§è®¾ç½®
 * @param user ç”¨æˆ·åœ°å€
 * @return hasOverride æ˜¯å¦æœ‰æ‰‹åŠ¨è®¾ç½®
 * @return tier æ‰‹åŠ¨è®¾ç½®çš„ç­‰çº§
 * @return isActive æ˜¯å¦ç”Ÿæ•ˆï¼ˆéœ€åŒæ—¶æ»¡è¶³ Preacher æ¡ä»¶ï¼‰
 */
function getManualTierStatus(
    address user
) external view returns (
    bool hasOverride,
    uint8 tier,
    bool isActive
) {
    tier = manualTierOverride[user];
    hasOverride = tier > 0;
    isActive = hasOverride && isPreacher(user);
}
```

#### 4. ä¿®æ”¹ `_getUserTier` å‡½æ•°ï¼ˆç¬¬ 1255-1273 è¡Œï¼‰

```solidity
function _getUserTier(address user) private view returns (uint8 tier) {
    // æ£€æŸ¥1: æ‰‹åŠ¨è®¾ç½®çš„ç­‰çº§ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
    uint8 manualTier = manualTierOverride[user];
    if (manualTier > 0) {
        // ä»éœ€æ»¡è¶³ Preacher æ¡ä»¶
        if (isPreacher(user)) {
            return manualTier;
        } else {
            // ä¸æ˜¯ Preacherï¼Œæ‰‹åŠ¨ç­‰çº§æ— æ•ˆ
            return 0;
        }
    }

    // æ£€æŸ¥2: rootAddress æˆ–é Preacher
    if (user == rootAddress || !isPreacher(user)) {
        return 0;
    }

    // æ£€æŸ¥3: æ ¹æ® teamKPI è‡ªåŠ¨è®¡ç®—ç­‰çº§
    uint256 teamKPI = getTeamKpi(user);
    IStaking.TeamTier[7] memory tiers = _getTeamTiers();

    for (uint256 i = 0; i < tiers.length; ) {
        if (teamKPI >= tiers[i].threshold) {
            return uint8(7 - i);
        }
        unchecked {
            ++i;
        }
    }

    return 0;
}
```

---

## æµ‹è¯•æ–¹æ¡ˆ

### æµ‹è¯•ç”¨ä¾‹ 1: åŸºæœ¬åŠŸèƒ½

```javascript
it("ç®¡ç†å‘˜åº”è¯¥èƒ½ä¸ºç”¨æˆ·è®¾ç½® V1 ç­‰çº§", async function() {
    // 1. ç”¨æˆ·è´¨æŠ¼ 200 SYI æˆä¸º Preacher
    await staking.connect(user1).stake(200 * 1e18, 0);

    // 2. ç®¡ç†å‘˜è®¾ç½®ä¸º V1
    await staking.setManualTier(user1.address, 1);

    // 3. éªŒè¯ç­‰çº§
    const [hasOverride, tier, isActive] = await staking.getManualTierStatus(user1.address);
    expect(hasOverride).to.be.true;
    expect(tier).to.equal(1);
    expect(isActive).to.be.true;
});
```

### æµ‹è¯•ç”¨ä¾‹ 2: Preacher æ£€æŸ¥

```javascript
it("é Preacher ç”¨æˆ·æ‰‹åŠ¨ç­‰çº§åº”æ— æ•ˆ", async function() {
    // 1. ç®¡ç†å‘˜è®¾ç½® V1
    await staking.setManualTier(user1.address, 1);

    // 2. ç”¨æˆ·æœªè´¨æŠ¼ï¼Œä¸æ˜¯ Preacher
    const [hasOverride, tier, isActive] = await staking.getManualTierStatus(user1.address);
    expect(hasOverride).to.be.true;
    expect(tier).to.equal(1);
    expect(isActive).to.be.false; // æœªç”Ÿæ•ˆ
});
```

### æµ‹è¯•ç”¨ä¾‹ 3: ç­‰çº§é™åˆ¶

```javascript
it("åº”æ‹’ç»è®¾ç½® V3 æˆ–æ›´é«˜ç­‰çº§", async function() {
    await expect(
        staking.setManualTier(user1.address, 3)
    ).to.be.revertedWith("Manual tier: only 1 or 2 allowed");
});
```

---

## æ€»ç»“

### å›¢é˜Ÿæ”¶ç›Šæœºåˆ¶æ ¸å¿ƒè¦ç‚¹

1. **7çº§å·®é¢åˆ¶åº¦**: å¥–åŠ±æ¯”ä¾‹ 5%-35%ï¼Œå·®é¢åˆ†å‘
2. **Preacher é—¨æ§›**: å¿…é¡»è´¨æŠ¼ â‰¥ 200 SYI
3. **å›¢é˜Ÿ KPI é©±åŠ¨**: åŸºäºä¸‹çº§ç´¯è®¡æŠ•èµ„è‡ªåŠ¨å‡çº§
4. **æ¨èé“¾æ‰«æ**: ä»ä¸‹å¾€ä¸ŠæŸ¥æ‰¾ï¼Œé«˜ç­‰çº§ä¼˜å…ˆ
5. **ç­‰çº§å»é‡**: æ¯ä¸ªç­‰çº§åªåˆ†é…ä¸€æ¬¡
6. **å‰©ä½™å½’é¡¹ç›®æ–¹**: æœªåˆ†é…éƒ¨åˆ†ç»™ rootAddress

### ç®¡ç†å‘˜å¼ºåˆ¶æå‡

**æ¨èæ–¹æ¡ˆ**: æ–¹æ¡ˆ A - è¦†ç›–æ˜ å°„
- **éš¾åº¦**: ä½
- **ä»£ç é‡**: ~80 è¡Œ
- **å½±å“èŒƒå›´**: ä»… `_getUserTier` å‡½æ•°
- **å®‰å…¨æ€§**: ä¿ç•™ Preacher æ£€æŸ¥
- **å¯é€†æ€§**: å¯éšæ—¶ç§»é™¤

### ç›¸å…³åˆçº¦ä½ç½®

- **ç­‰çº§åˆ¤æ–­**: `StakingBase.sol:1255`
- **å›¢é˜Ÿå¥–åŠ±åˆ†å‘**: `StakingBase.sol:1014`
- **KPI æ›´æ–°**: `StakingBase.sol:804`
- **Preacher æ£€æŸ¥**: `StakingBase.sol:669`
