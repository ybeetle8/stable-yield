# 测试命令

## 启动本地测试网络

### 方式 1: 启动普通本地节点
```bash
npx hardhat node
```

### 方式 2: Fork BSC 主网（推荐）
```bash
# Fork BSC 主网到指定区块
npx hardhat node --fork https://binance.llamarpc.com --fork-block-number 63612920

# 或使用其他可用节点
npx hardhat node --fork https://1rpc.io/bnb --fork-block-number 64340000
npx hardhat node --fork https://rpc.tornadoeth.cash/bsc --fork-block-number 64340000
```

**注意**：启动 fork 节点后保持该终端运行，在另一个终端执行部署和测试命令。

---

## SYI 系统部署与测试（新版本 - 已移除 LP 质押集成）

### 1. 编译合约
```bash
npx hardhat compile
```

### 2. 部署完整 SYI 系统
```bash
# 部署 SYI + Staking + FundRelay，并创建交易对
npx hardhat run scripts/deploySYI.js --network localhost
```

**部署内容**：
- ✅ 使用 BSC 主网合约 (USDT, Router, Factory)
- ✅ 部署 Staking 合约
- ✅ 部署 SYI 代币合约
- ✅ 部署 FundRelay 合约
- ✅ 创建 SYI/USDT 交易对
- ✅ 自动配置所有关联关系
- ✅ 保存部署信息到 `syi-deployment.json`

### 3. 测试 SYI 系统
```bash
# 验证合约配置和税费结构
npx hardhat run scripts/testSYI.js --network localhost
```

**测试内容**：
- ✅ 代币基本信息
- ✅ 合约配置正确性
- ✅ 税费结构（买入 1%，卖出 1.5%）
- ✅ LP Fee 为 0（已移除 LP 质押集成）
- ✅ Staking 集成正常
- ✅ 交易对创建成功

---

## 其他测试命令

### 测试 PancakeSwap Demo
```bash
npx hardhat run scripts/testPancakeDemo.js --network localhost
```

### 测试 Staking 功能
```bash
npx hardhat run scripts/testSYIStaking.js --network localhost
```

---

## 部署信息

部署成功后，合约地址保存在：
- `syi-deployment.json` - SYI 系统部署信息

可以查看文件内容：
```bash
cat syi-deployment.json
```

---

## 税费结构（新版本）

| 项目 | 修改前 | 修改后 |
|------|--------|--------|
| 买入税 | 3% (1% burn + 2% LP) | **1%** (只 burn) |
| 卖出税 | 3% (1.5% marketing + 1.5% LP) | **1.5%** (只 marketing) |
| 盈利税分配 | 40% LP + 60% 节点 | **100%** 节点/营销 |
| LP 质押集成 | 完全集成 | **已完全移除** |

---

## 常见问题

### Q: 为什么使用 fork 模式？
A: Fork 模式可以直接使用 BSC 主网上已部署的合约（USDT、PancakeSwap 等），无需自己部署这些基础设施。

### Q: 如何获取区块号？
```bash
curl -s -X POST https://binance.llamarpc.com -H "Content-Type: application/json" \
  --data '{"jsonrpc":"2.0","method":"eth_blockNumber","params":[],"id":1}' \
  | jq -r '.result' | xargs printf "%d\n"
```

### Q: 如何添加初始流动性？
流动性池创建后是空的，需要手动添加初始流动性才能进行交易测试。部署完成后可以使用 Router 的 `addLiquidity()` 方法。

### Q: 如何获取测试 USDT？
在 fork 环境下，可以使用 hardhat 的 `impersonateAccount` 功能从 BSC 主网的富地址获取 USDT。

---

## 完整测试流程示例

### 终端 1: 启动 fork 节点
```bash
cd /home/ybeetle/code/stable-yield
npx hardhat node --fork https://binance.llamarpc.com --fork-block-number 63612920
```

### 终端 2: 部署和测试
```bash
cd /home/ybeetle/code/stable-yield

# 编译合约
npx hardhat compile

# 部署 SYI 系统
npx hardhat run scripts/deploySYI.js --network localhost

# 测试 SYI 系统
npx hardhat run scripts/testSYI.js --network localhost

# 查看部署信息
cat syi-deployment.json
```

---

## 重要提醒

1. **保持 fork 节点运行**：部署和测试期间不要关闭 fork 节点终端
2. **检查部署信息**：部署后检查 `syi-deployment.json` 确认所有地址正确
3. **验证 LP Fee**：测试时确认 LP Fee 为 0，证明 LP 质押集成已移除
4. **税费降低**：用户交易成本降低（买入省 2%，卖出省 1.5%）
5. **盈利税变化**：所有盈利税现在 100% 给节点/营销地址
