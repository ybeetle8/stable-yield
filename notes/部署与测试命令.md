# SYI 系统部署与测试命令

**最新版本**: v2.0 - 完全无税版本 (2025-10-13)

## 启动本地测试网络

### 方式 1: 启动普通本地节点
```bash
npx hardhat node
```

### 方式 2: Fork BSC 主网（推荐）
```bash
# Fork BSC 主网到指定区块（推荐使用最新区块）
npx hardhat node --fork https://binance.llamarpc.com --fork-block-number 63482920

# 或使用其他可用节点
npx hardhat node --fork https://1rpc.io/bnb --fork-block-number 64340000
npx hardhat node --fork https://rpc.tornadoeth.cash/bsc --fork-block-number 64340000
```

**注意**：启动 fork 节点后保持该终端运行，在另一个终端执行部署和测试命令。

---

## SYI 系统部署与测试（v2.0 - 完全无税版本）

### 1. 编译合约
```bash
npx hardhat compile
```

### 2. 部署完整 SYI 系统
```bash
# 部署 SYI + Staking + FundRelay，并创建交易对
npx hardhat run scripts/deploySYI.js --network localhost
```

**部署内容**：
- ✅ 使用 BSC 主网合约 (USDT, Router, Factory)
- ✅ 部署 Staking 合约（带推荐系统）
- ✅ 部署 SYI 代币合约（**完全无税**）
- ✅ 部署 FundRelay 合约
- ✅ 创建 SYI/USDT 交易对
- ✅ 自动配置所有关联关系
- ✅ 保存部署信息到 `syi-deployment.json`

**核心特性**：
- 🚫 **无买入税**：买入交易 0% 费用
- 🚫 **无卖出税**：卖出交易 0% 费用
- 🚫 **无盈利税**：取消 25% 盈利税机制
- 🚫 **无成本追踪**：移除 userInvestment 机制
- ✅ **保留安全机制**：黑名单、冷却时间、预售限制

### 3. 测试 SYI 系统
```bash
# 验证合约配置和无税状态
npx hardhat run scripts/testSYI.js --network localhost
```

**测试内容**：
- ✅ 代币基本信息（1000万总供应量）
- ✅ 合约配置正确性
- ✅ **税费状态：买入 0%、卖出 0%、盈利税 0%**
- ✅ 成本追踪已移除（getUserInvestment 返回 0）
- ✅ Staking 集成正常
- ✅ 交易对创建成功

---

## 其他测试命令

### 测试 PancakeSwap Demo
```bash
npx hardhat run scripts/testPancakeDemo.js --network localhost
```

### 测试 Staking 功能
```bash
npx hardhat run scripts/testSYIStaking.js --network localhost
```

---

## 部署信息

部署成功后，合约地址保存在：
- `syi-deployment.json` - SYI 系统部署信息

可以查看文件内容：
```bash
cat syi-deployment.json
```

---

## 税费结构变更历史

### v2.0 (2025-10-13) - 完全无税版本

| 项目 | v1.0 (原版) | v1.5 (中间版) | **v2.0 (当前版)** |
|------|------------|--------------|------------------|
| 买入 burn 税 | 3% (1% burn + 2% LP) | 1% (只 burn) | **0%** ✅ |
| 买入 LP 税 | 包含在 3% 中 | 已移除 | **0%** ✅ |
| 卖出 marketing 税 | 3% (1.5% marketing + 1.5% LP) | 1.5% (只 marketing) | **0%** ✅ |
| 卖出 LP 税 | 包含在 3% 中 | 已移除 | **0%** ✅ |
| 盈利税 | 25% (40% LP + 60% 节点) | 25% (100% 节点/营销) | **0%** ✅ |
| 成本追踪 | 有 | 有 | **已移除** ✅ |
| marketingAddress | 必需 | 必需 | **已移除** ✅ |
| LP 质押集成 | 完全集成 | 已移除 | **已移除** ✅ |

### 核心改动说明

**v2.0 完全无税版本特点**：
1. ✅ **买入交易**：无任何扣除，用户获得全额代币
2. ✅ **卖出交易**：无任何扣除，用户获得全额 USDT
3. ✅ **无盈利税**：不再追踪成本，不计算盈利
4. ✅ **无 burn**：不再自动销毁代币
5. ✅ **无 marketing 费用**：不再扣除营销费用
6. ✅ **符合 OKX 上币要求**：零税费，纯粹 ERC20 代币

**保留的安全机制**：
- ⚠️ **黑名单**：可阻止恶意地址交易
- ⚠️ **白名单**：核心地址免检查
- ✅ **冷却时间**：买入后 10 秒内不能卖出
- ✅ **预售限制**：30 天预售期内限制购买
- ✅ **延迟买入**：反机器人机制
- ✅ **Recycle 上限**：最多回收池子 1/3 代币

---

## 常见问题

### Q: 为什么使用 fork 模式？
A: Fork 模式可以直接使用 BSC 主网上已部署的合约（USDT、PancakeSwap 等），无需自己部署这些基础设施。

### Q: 如何获取区块号？
```bash
curl -s -X POST https://binance.llamarpc.com -H "Content-Type: application/json" \
  --data '{"jsonrpc":"2.0","method":"eth_blockNumber","params":[],"id":1}' \
  | jq -r '.result' | xargs printf "%d\n"
```

### Q: 如何添加初始流动性？
流动性池创建后是空的，需要手动添加初始流动性才能进行交易测试。部署完成后可以使用 Router 的 `addLiquidity()` 方法。

### Q: 如何获取测试 USDT？
在 fork 环境下，可以使用 hardhat 的 `impersonateAccount` 功能从 BSC 主网的富地址获取 USDT。

---

## 完整测试流程示例（v2.0）

### 终端 1: 启动 fork 节点
```bash
cd /home/ybeetle/code/stable-yield

# 推荐：使用最新的 fork 节点
npx hardhat node --fork https://binance.llamarpc.com --fork-block-number 63482920
```

### 终端 2: 部署和测试
```bash
cd /home/ybeetle/code/stable-yield

# 1. 编译合约
npx hardhat compile

# 2. 部署 SYI 系统（完全无税版本）
npx hardhat run scripts/deploySYI.js --network localhost

# 3. 测试 SYI 系统（验证无税状态）
npx hardhat run scripts/testSYI.js --network localhost

# 4. 查看部署信息
cat syi-deployment.json | jq
```

**预期输出**：
```
税费结构:
- 买入税: 0% (完全无税)
- 卖出税: 0% (完全无税)
- 盈利税: 0% (完全无税)
- 说明: 已移除所有交易税机制，买卖无任何费用

核心变更验证:
✅ 买入税: 0% (完全无税，原 3%)
✅ 卖出税: 0% (完全无税，原 3%)
✅ 盈利税: 0% (完全无税，原 25%)
✅ Burn 机制: 已移除
✅ Marketing 费用: 已移除
✅ 成本追踪: 已移除
✅ 说明: 买卖交易无任何费用
```

---

## 重要提醒（v2.0 版本）

### 部署和测试注意事项
1. **保持 fork 节点运行**：部署和测试期间不要关闭 fork 节点终端
2. **检查部署信息**：部署后检查 `syi-deployment.json` 确认所有地址正确
3. **验证无税状态**：测试时确认所有税费为 0%
4. **检查合约配置**：验证 Staking 和交易对创建成功

### v2.0 核心变更
1. ✅ **完全无税**：买入、卖出、盈利税全部为 0%
2. ✅ **用户体验**：交易无任何扣除，100% 获得代币/USDT
3. ✅ **符合合规**：零税费设计符合 OKX 等交易所上币要求
4. ⚠️ **黑白名单**：保留黑白名单功能，可能需要进一步移除以符合 OKX 要求
5. ⚠️ **无收入来源**：项目方需要通过其他方式获得收入（如 Staking 赎回费 1%）

### 与 OKX 上币的兼容性
✅ **已满足**：
- 无买入税
- 无卖出税
- 无盈利税
- 标准 ERC20 接口

⚠️ **需要注意**：
- 黑白名单功能可能被 OKX 标记为"蜜罐"
- 建议上交易所前进一步移除或禁用黑白名单

### 经济模型调整建议
由于完全取消了交易税，项目方需要考虑：
1. **收入来源**：
   - Staking 赎回费（当前 1%）
   - 项目方初始储备
   - 社区捐赠

2. **通缩机制**：
   - 定期手动 burn 代币
   - 通过 Staking 锁定供应量
   - 社区投票销毁机制

3. **流动性管理**：
   - 初始添加大额流动性
   - 质押持续添加流动性
   - 项目方定期补充

4. **价格稳定**：
   - 增加流动性深度
   - 社区稳定机制
   - 做市商合作

---

## 版本历史

| 版本 | 日期 | 主要变更 |
|------|------|----------|
| v1.0 | 初始版本 | 完整税费系统（买入 3%、卖出 3%、盈利税 25%） |
| v1.5 | 中间版本 | 降低税费（买入 1%、卖出 1.5%），移除 LP 质押 |
| **v2.0** | **2025-10-13** | **完全无税**（买入 0%、卖出 0%、盈利税 0%） |

---

## 快速命令参考

```bash
# 启动 fork 节点
npx hardhat node --fork https://binance.llamarpc.com --fork-block-number 63482920

# 编译 + 部署 + 测试（一键执行）
npx hardhat compile && \
npx hardhat run scripts/deploySYI.js --network localhost && \
npx hardhat run scripts/testSYI.js --network localhost

# 查看部署信息
cat syi-deployment.json | jq

# 获取当前区块号
curl -s -X POST https://binance.llamarpc.com -H "Content-Type: application/json" \
  --data '{"jsonrpc":"2.0","method":"eth_blockNumber","params":[],"id":1}' \
  | jq -r '.result' | xargs printf "%d\n"
```
