# è§£è´¨æŠ¼å®Œæ•´æµç¨‹è¯´æ˜ï¼ˆç»ˆæç‰ˆï¼‰

> æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜ SYI è´¨æŠ¼ç³»ç»Ÿçš„è§£è´¨æŠ¼æµç¨‹ï¼Œé‡ç‚¹è§£æ **Staking åˆçº¦çš„ SYI å‚¨å¤‡æœºåˆ¶** å’Œ **Recycle å¾ªç¯å›æ”¶æœºåˆ¶**

---

## ç›®å½•

1. [æ ¸å¿ƒæ¦‚å¿µ](#æ ¸å¿ƒæ¦‚å¿µ)
2. [å®Œæ•´æµç¨‹å›¾](#å®Œæ•´æµç¨‹å›¾)
3. [è¯¦ç»†æ­¥éª¤æ‹†è§£](#è¯¦ç»†æ­¥éª¤æ‹†è§£)
4. [Recycle æœºåˆ¶æ·±åº¦è§£æ](#recycle-æœºåˆ¶æ·±åº¦è§£æ)
5. [ä¸ä¸»æµ DeFi é¡¹ç›®å¯¹æ¯”](#ä¸ä¸»æµ-defi-é¡¹ç›®å¯¹æ¯”)
6. [å®‰å…¨æ€§åˆ†æ](#å®‰å…¨æ€§åˆ†æ)
7. [å…³é”®ä»£ç ç´¢å¼•](#å…³é”®ä»£ç ç´¢å¼•)

---

## æ ¸å¿ƒæ¦‚å¿µ

### ä¸‰ä¸ªå…³é”®é—®é¢˜

#### Q1: Staking åˆçº¦ä¸Šæœ‰ SYI å‚¨å¤‡å—ï¼Ÿ
**ç­”ï¼šæœ‰ï¼** Staking åˆçº¦å¿…é¡»é¢„å…ˆæŒæœ‰ SYI å‚¨å¤‡ï¼ˆé€šå¸¸åœ¨éƒ¨ç½²æ—¶è½¬å…¥ï¼‰ã€‚

```
åˆå§‹çŠ¶æ€ç¤ºä¾‹ï¼š
â”œâ”€ Staking åˆçº¦: 200,000 SYI ï¼ˆå‚¨å¤‡ï¼‰
â””â”€ Pair æµåŠ¨æ€§æ± : 4,000,000 SYI + 40,000 USDT
```

#### Q2: è§£è´¨æŠ¼æ—¶å–å‡ºçš„ 162,981 SYI ä»å“ªé‡Œæ¥ï¼Ÿ
**ç­”ï¼šä» Staking åˆçº¦çš„ SYI å‚¨å¤‡ä¸­æ¥ã€‚**

ä»£ç ä½ç½®ï¼š`contracts/SYI-Staking/abstract/StakingBase.sol:922-950`

```solidity
function _swapSYIForReward(uint256 calculatedReward) private returns (...) {
    uint256 syiBalanceBefore = SYI.balanceOf(address(this));  // æŸ¥è¯¢ Staking å‚¨å¤‡

    // ç”¨ Staking çš„ SYI å‚¨å¤‡æ¢ USDT
    ROUTER.swapTokensForExactTokens(
        calculatedReward,      // éœ€è¦æ¢å–çš„ USDT æ•°é‡
        maxSYIInput,           // æœ€å¤šç”¨å¤šå°‘ SYI
        swapPath,              // [SYI, USDT]
        address(this),         // USDT è½¬åˆ° Staking åˆçº¦
        block.timestamp
    );

    syiTokensUsed = syiBalanceBefore - SYI.balanceOf(address(this));
    // è¿”å›å®é™…ä½¿ç”¨çš„ SYI æ•°é‡ï¼ˆä¾‹å¦‚ï¼š162,981ï¼‰
}
```

#### Q3: ä¸ºä»€ä¹ˆéœ€è¦ Recycleï¼Ÿ
**ç­”ï¼šä¸ºäº†è®© Staking åˆçº¦çš„ SYI å‚¨å¤‡æ°¸è¿œç”¨ä¸å®Œï¼Œå®ç°å¯æŒç»­è¿è¡Œã€‚**

---

## å®Œæ•´æµç¨‹å›¾

### æµç¨‹å›¾ 1: è§£è´¨æŠ¼ + Recycle å®Œæ•´æµç¨‹

```mermaid
sequenceDiagram
    autonumber
    participant User as ç”¨æˆ·
    participant Staking as Staking åˆçº¦
    participant SYI as SYI ä»£å¸åˆçº¦
    participant Router as PancakeRouter
    participant Pair as æµåŠ¨æ€§æ± (Pair)

    Note over Staking,Pair: åˆå§‹çŠ¶æ€<br/>Staking: 200,000 SYI<br/>Pair: 4,000,000 SYI + 40,000 USDT

    User->>Staking: unstake(stakeIndex)

    rect rgb(255, 245, 230)
        Note over Staking: é˜¶æ®µ 1: è®¡ç®—å¥–åŠ±
        Staking->>Staking: _burn(stakeIndex)
        Note over Staking: è¿”å›:<br/>æœ¬é‡‘ = 1,000 USDT<br/>å¥–åŠ± = 1,563.1 USDT
    end

    rect rgb(230, 245, 255)
        Note over Staking,Pair: é˜¶æ®µ 2: å– SYI æ¢ USDTï¼ˆä½¿ç”¨ Staking å‚¨å¤‡ï¼‰

        Staking->>SYI: balanceOf(Staking)
        SYI-->>Staking: 200,000 SYI âœ… å‚¨å¤‡å……è¶³

        Staking->>Router: swapTokensForExactTokens(<br/>  éœ€è¦: 1,563.1 USDT<br/>  æœ€å¤šç”¨: 200,000 SYI<br/>)

        Note over Router: AMM è®¡ç®—:<br/>éœ€è¦çº¦ 162,981 SYI

        Router->>SYI: transferFrom(Staking, Pair, 162,981)
        SYI->>Pair: è½¬è´¦ 162,981 SYI
        Note over Pair: SYI balance:<br/>4,000,000 + 162,981<br/>= 4,162,981 SYI

        Router->>Pair: swap(0, 1563.1, Staking)
        Pair-->>Staking: è½¬è´¦ 1,563.1 USDT

        Note over Staking: Staking ä½™é¢å˜åŒ–:<br/>SYI: 200,000 â†’ 37,019 âš ï¸<br/>USDT: + 1,563.1 âœ…
    end

    rect rgb(245, 255, 245)
        Note over Staking: é˜¶æ®µ 3: åˆ†é…å¥–åŠ±
        Staking->>User: è½¬è´¦ 1,337.86 USDT (ç”¨æˆ·å‡€æ”¶ç›Š)
        Staking->>User: è½¬è´¦ 28.155 USDT (Friend 5%)
        Staking->>User: è½¬è´¦ 197.085 USDT (å›¢é˜Ÿ 35%)
    end

    rect rgb(255, 230, 230)
        Note over Staking,Pair: é˜¶æ®µ 4: ğŸ”¥ Recycle å›æ”¶ï¼ˆå…³é”®ï¼‰

        Staking->>SYI: recycle(162,981)

        Note over SYI: æƒé™æ£€æŸ¥
        SYI->>SYI: require(msg.sender == staking)

        SYI->>Pair: balanceOf(Pair)
        Pair-->>SYI: 4,162,981 SYI

        Note over SYI: è®¡ç®—å®‰å…¨ä¸Šé™:<br/>maxRecyclable = 4,162,981 / 3<br/>= 1,387,660 SYI<br/><br/>è¯·æ±‚ 162,981 < ä¸Šé™ âœ…

        SYI->>SYI: _update(Pair, Staking, 162,981)
        Note over SYI: ç›´æ¥ä¿®æ”¹ä½™é¢:<br/>Pair: 4,162,981 - 162,981 = 4,000,000<br/>Staking: 37,019 + 162,981 = 200,000 âœ…

        SYI->>Pair: sync()
        Note over Pair: åŒæ­¥å‚¨å¤‡é‡:<br/>reserve_SYI = 4,000,000<br/>reserve_USDT = 38,436.9<br/>ä»·æ ¼é‡æ–°è®¡ç®— âœ…
    end

    Note over Staking,Pair: æœ€ç»ˆçŠ¶æ€<br/>Staking: 200,000 SYI âœ… æ¢å¤<br/>Pair: 4,000,000 SYI + 38,436.9 USDT<br/>ç”¨æˆ·è·å¾—: 1,337.86 USDT
```

### æµç¨‹å›¾ 2: èµ„é‡‘é—­ç¯ç¤ºæ„å›¾

```mermaid
graph TB
    subgraph åˆå§‹éƒ¨ç½²
        D[éƒ¨ç½²æ—¶é¢„å……å€¼<br/>200,000 SYI]
        D --> S1[Staking åˆçº¦<br/>å‚¨å¤‡: 200,000 SYI]
    end

    subgraph è§£è´¨æŠ¼æµç¨‹
        U1[ç”¨æˆ·è§£è´¨æŠ¼] --> C1[è®¡ç®—å¥–åŠ±<br/>1,563.1 USDT]
        C1 --> S2[Staking å–å‡º<br/>162,981 SYI]
        S2 --> P1[è½¬å…¥ Pair]
        P1 --> U2[æ¢å¾— 1,563.1 USDT]
        U2 --> D1[åˆ†é…ç»™ç”¨æˆ·/å›¢é˜Ÿ]

        Note1[æ­¤æ—¶ Staking<br/>åªå‰© 37,019 SYI âš ï¸]
    end

    subgraph Recycleå›æ”¶
        D1 --> R1[è°ƒç”¨ SYI.recycle<br/>162,981 SYI]
        R1 --> P2[ä» Pair å–å›]
        P2 --> S3[Staking ä½™é¢æ¢å¤<br/>200,000 SYI âœ…]
        S3 --> SY1[è°ƒç”¨ Pair.sync<br/>åŒæ­¥å‚¨å¤‡é‡]
    end

    subgraph å¾ªç¯
        SY1 -.å¾ªç¯ä½¿ç”¨.-> U1
    end

    style S1 fill:#e1f5e1
    style Note1 fill:#ffe1e1
    style S3 fill:#e1f5e1
    style R1 fill:#fff3e1
```

### æµç¨‹å›¾ 3: Recycle å†³ç­–æ ‘

```mermaid
flowchart TD
    Start[Staking.unstake<br/>å–å‡ºåéœ€è¦ recycle] --> Check1{è°ƒç”¨è€…æ˜¯å¦<br/>Staking åˆçº¦?}

    Check1 -->|å¦| Fail1[âŒ revert:<br/>Only staking contract]
    Check1 -->|æ˜¯| GetBalance[è·å– Pair çš„ SYI ä½™é¢]

    GetBalance --> Check2{Pair ä¸­æœ‰ SYI?}
    Check2 -->|pairBalance = 0| Fail2[âŒ æ— æ³•å›æ”¶<br/>æ± å­ç©ºäº†]
    Check2 -->|pairBalance > 0| Calc[è®¡ç®—å®‰å…¨ä¸Šé™<br/>maxRecyclable = pairBalance / 3]

    Calc --> Check3{è¯·æ±‚æ•°é‡ vs ä¸Šé™}
    Check3 -->|è¯·æ±‚ â‰¤ ä¸Šé™| Full[âœ… å…¨é¢å›æ”¶<br/>recycleAmount = è¯·æ±‚æ•°é‡]
    Check3 -->|è¯·æ±‚ > ä¸Šé™| Partial[âš ï¸ éƒ¨åˆ†å›æ”¶<br/>recycleAmount = maxRecyclable]

    Full --> Execute[æ‰§è¡Œ _update<br/>from: Pair<br/>to: Staking]
    Partial --> Execute

    Execute --> UpdateBalance[æ›´æ–°ä½™é¢:<br/>Pair -= recycleAmount<br/>Staking += recycleAmount]
    UpdateBalance --> Sync[è°ƒç”¨ Pair.sync<br/>åŒæ­¥å‚¨å¤‡é‡]
    Sync --> Done[âœ… å›æ”¶å®Œæˆ]

    style Fail1 fill:#ffcccc
    style Fail2 fill:#ffcccc
    style Full fill:#ccffcc
    style Partial fill:#ffffcc
    style Done fill:#99ff99
    style Execute fill:#e1f0ff
```

### æµç¨‹å›¾ 4: å¯¹æ¯”æœ‰æ—  Recycle çš„åŒºåˆ«

```mermaid
gantt
    title Staking SYI å‚¨å¤‡å˜åŒ–å¯¹æ¯”
    dateFormat X
    axisFormat %s

    section æ²¡æœ‰ Recycleï¼ˆä¼šè€—å°½ï¼‰
    åˆå§‹å‚¨å¤‡ 200,000 :done, 0, 1
    ç¬¬1æ¬¡è§£è´¨æŠ¼ -162,981 â†’ 37,019 :crit, 1, 2
    ç¬¬2æ¬¡è§£è´¨æŠ¼ æ— æ³•æ”¯ä»˜ âŒ :milestone, 2, 3

    section æœ‰ Recycleï¼ˆæ°¸ä¸è€—å°½ï¼‰
    åˆå§‹å‚¨å¤‡ 200,000 :done, 3, 4
    ç¬¬1æ¬¡å–å‡º â†’ 37,019 :active, 4, 4.3
    ç¬¬1æ¬¡å›æ”¶ â†’ 200,000 âœ… :milestone, 4.3, 5
    ç¬¬2æ¬¡å–å‡º â†’ 37,019 :active, 5, 5.3
    ç¬¬2æ¬¡å›æ”¶ â†’ 200,000 âœ… :milestone, 5.3, 6
    å¯æ— é™å¾ªç¯ â™¾ï¸ :done, 6, 7
```

---

## è¯¦ç»†æ­¥éª¤æ‹†è§£

### æ­¥éª¤ 1: è®¡ç®—å¥–åŠ± (_burn)

**ä»£ç ä½ç½®**: `contracts/SYI-Staking/abstract/StakingBase.sol:897-920`

```solidity
function _burn(uint256 index) private returns (uint256 reward, uint256 amount) {
    Record storage user_record = userStakeRecord[msg.sender][index];

    // 1. æ£€æŸ¥è´¨æŠ¼æœŸé™
    require(
        block.timestamp - user_record.stakeTime >= getStakePeriod(...),
        "Staking period not met"
    );

    // 2. æ£€æŸ¥æ˜¯å¦å·²æç°
    require(!user_record.status, "Already withdrawn");

    // 3. è®¡ç®—å¤åˆ©å¥–åŠ±
    amount = user_record.amount;           // æœ¬é‡‘: 1,000 USDT
    reward = _calculateStakeReward(...);   // å¥–åŠ±: 1,563.1 USDT (å«æœ¬é‡‘)

    // 4. æ ‡è®°å·²æç°
    user_record.status = true;

    // 5. é”€æ¯ sSYI ä»£å¸
    _update(msg.sender, address(0), amount);
}
```

**è¾“å‡º**:
- `principalAmount`: 1,000 USDTï¼ˆæœ¬é‡‘ï¼‰
- `calculatedReward`: 1,563.1 USDTï¼ˆæœ¬é‡‘ + åˆ©æ¯ï¼‰

---

### æ­¥éª¤ 2: å– SYI æ¢ USDT (_swapSYIForReward)

**ä»£ç ä½ç½®**: `contracts/SYI-Staking/abstract/StakingBase.sol:922-950`

```solidity
function _swapSYIForReward(uint256 calculatedReward) private returns (...) {
    // 1. è®°å½• Staking åˆçº¦çš„ SYI ä½™é¢ï¼ˆå‚¨å¤‡ï¼‰
    uint256 syiBalanceBefore = SYI.balanceOf(address(this));  // ä¾‹å¦‚: 200,000 SYI

    // 2. è®°å½• USDT ä½™é¢
    uint256 usdtBalanceBefore = IERC20(USDT).balanceOf(address(this));

    // 3. è®¾ç½®äº¤æ˜“è·¯å¾„
    address[] memory swapPath = new address[](2);
    swapPath[0] = address(SYI);   // å–å‡º SYI
    swapPath[1] = address(USDT);  // ä¹°å…¥ USDT

    // 4. è®¡ç®—æœ€å¤§å…è®¸ä½¿ç”¨çš„ SYI æ•°é‡ï¼ˆå«æ»‘ç‚¹ä¿æŠ¤ï¼‰
    uint256 maxSYIInput = _calculateMaxSYIInput(
        calculatedReward,      // éœ€è¦ 1,563.1 USDT
        syiBalanceBefore       // å¯ç”¨ 200,000 SYI
    );

    // 5. æ‰§è¡Œäº¤æ˜“ï¼šç²¾ç¡®æ¢å–æŒ‡å®šæ•°é‡çš„ USDT
    ROUTER.swapTokensForExactTokens(
        calculatedReward,      // ç²¾ç¡®éœ€è¦: 1,563.1 USDT
        maxSYIInput,           // æœ€å¤šç”¨: ~250,000 SYI (å«æ»‘ç‚¹)
        swapPath,              // [SYI, USDT]
        address(this),         // USDT è½¬åˆ° Staking åˆçº¦
        block.timestamp        // æˆªæ­¢æ—¶é—´
    );

    // 6. è®¡ç®—å®é™…ä½¿ç”¨äº†å¤šå°‘ SYI
    uint256 syiBalanceAfter = SYI.balanceOf(address(this));
    syiTokensUsed = syiBalanceBefore - syiBalanceAfter;  // ä¾‹å¦‚: 162,981 SYI

    // 7. è®¡ç®—å®é™…æ¢å¾—å¤šå°‘ USDT
    usdtReceived = IERC20(USDT).balanceOf(address(this)) - usdtBalanceBefore;

    return (usdtReceived, syiTokensUsed);
}
```

**å…³é”®ç‚¹**ï¼š
- âœ… ä½¿ç”¨ `swapTokensForExactTokens`ï¼šç²¾ç¡®æ¢å–æ‰€éœ€ USDTï¼Œé¿å…è®¡ç®—è¯¯å·®
- âœ… SYI æ¥è‡ª Staking åˆçº¦çš„**é¢„å……å€¼å‚¨å¤‡**
- âœ… äº¤æ˜“å Staking çš„ SYI ä½™é¢ä¼šå¤§å¹…å‡å°‘ï¼ˆ200,000 â†’ 37,019ï¼‰

**ä½™é¢å˜åŒ–**ï¼š
```
äº¤æ˜“å‰:
â”œâ”€ Staking: 200,000 SYI + 0 USDT
â””â”€ Pair: 4,000,000 SYI + 40,000 USDT

äº¤æ˜“å:
â”œâ”€ Staking: 37,019 SYI + 1,563.1 USDT  âš ï¸ SYI å‚¨å¤‡å¤§å¹…å‡å°‘
â””â”€ Pair: 4,162,981 SYI + 38,436.9 USDT
```

---

### æ­¥éª¤ 3: åˆ†é…å¥–åŠ±

**ä»£ç ä½ç½®**: `contracts/SYI-Staking/abstract/StakingBase.sol:208-258`

```solidity
function unstake(uint256 stakeIndex) external returns (uint256) {
    // ... å‰é¢è·å¾—äº† usdtReceived = 1,563.1 USDT

    // 1. è®¡ç®—åˆ©æ¯
    uint256 interestEarned = usdtReceived - principalAmount;  // 563.1 USDT

    // 2. Friend å¥–åŠ± (5%)
    uint256 friendReward = _distributeFriendReward(msg.sender, interestEarned);
    // = 563.1 * 5% = 28.155 USDT

    // 3. å›¢é˜Ÿå¥–åŠ± (35%)
    address[] memory referralChain = getReferrals(msg.sender, 30);
    uint256 teamFee = _distributeTeamReward(referralChain, interestEarned);
    // = 563.1 * 35% = 197.085 USDT

    // 4. æ›´æ–°å›¢é˜Ÿ KPI
    _updateTeamInvestmentValues(msg.sender, principalAmount, false);

    // 5. è®¡ç®—ç”¨æˆ·å®é™…æ”¶ç›Š
    uint256 userPayout = usdtReceived - friendReward - teamFee;
    // = 1,563.1 - 28.155 - 197.085 = 1,337.86 USDT

    // 6. èµå›è´¹ (1%)
    uint256 redemptionFee = (userPayout * 100) / 10000;  // 1% = 13.38 USDT

    // 7. è½¬è´¦ç»™ç”¨æˆ·
    IERC20(USDT).transfer(msg.sender, userPayout);

    // ... æ¥ä¸‹æ¥æ˜¯ Recycle
}
```

**åˆ†é…æ˜ç»†**ï¼š
```
æ€»å¥–åŠ±: 1,563.1 USDT
â”œâ”€ æœ¬é‡‘: 1,000 USDT
â”œâ”€ åˆ©æ¯: 563.1 USDT
    â”œâ”€ Friend (5%): 28.155 USDT
    â”œâ”€ å›¢é˜Ÿ (35%): 197.085 USDT
    â””â”€ ç”¨æˆ·å‰©ä½™: 1,337.86 USDT
        â””â”€ èµå›è´¹ (1%): 13.38 USDT (è½¬ç»™ feeRecipient)
```

---

### æ­¥éª¤ 4: Recycle å›æ”¶ SYI

**ä»£ç ä½ç½®**: `contracts/SYI/abstract/SYIBase.sol:405-505`

```solidity
function recycle(uint256 amount) external {
    // ===== 1. æƒé™æ£€æŸ¥ =====
    // åªå…è®¸ Staking åˆçº¦è°ƒç”¨ï¼Œé˜²æ­¢ä»»æ„åœ°å€æŠ½å–æµåŠ¨æ€§
    require(msg.sender == address(staking), "Only staking contract");

    // ===== 2. è·å–æ± å­çš„ SYI å®é™…ä½™é¢ =====
    // æ³¨æ„ï¼šè¿™é‡Œè¯»å–çš„æ˜¯ balance (å®é™…ä½™é¢)ï¼Œä¸æ˜¯ reserve (è´¦é¢å‚¨å¤‡)
    uint256 pairBalance = balanceOf(address(uniswapV2Pair));
    // ä¾‹å¦‚: 4,162,981 SYI

    // ===== 3. è®¡ç®—å®‰å…¨ä¸Šé™ (1/3 è§„åˆ™) =====
    // ä¸ºä»€ä¹ˆæ˜¯ 1/3ï¼Ÿé˜²æ­¢ä¸€æ¬¡æ€§æŠ½ç©ºæ± å­ï¼Œä¿è¯æµåŠ¨æ€§
    uint256 maxRecyclable = pairBalance / 3;
    // ä¾‹å¦‚: 4,162,981 / 3 = 1,387,660 SYI

    // ===== 4. ç¡®å®šå®é™…å›æ”¶æ•°é‡ =====
    uint256 recycleAmount = amount >= maxRecyclable
        ? maxRecyclable   // è¯·æ±‚è¿‡å¤šï¼ŒæŒ‰ä¸Šé™å›æ”¶
        : amount;         // è¯·æ±‚åˆç†ï¼ŒæŒ‰éœ€å›æ”¶
    // ä¾‹å¦‚: è¯·æ±‚ 162,981 < ä¸Šé™ 1,387,660 âœ…ï¼Œå›æ”¶ 162,981

    // ===== 5. æ‰§è¡Œå›æ”¶æ“ä½œ =====
    if (recycleAmount > 0) {
        // 5.1 ç›´æ¥ä¿®æ”¹ä½™é¢ï¼ˆä¸èµ° transferï¼Œé¿å…è§¦å‘ç¨è´¹é€»è¾‘ï¼‰
        _update(
            address(uniswapV2Pair),  // from: Pair åœ°å€
            address(staking),        // to: Staking åœ°å€
            recycleAmount            // amount: 162,981 SYI
        );

        // æ­¤æ—¶ä½™é¢å˜åŒ–:
        // Pair: 4,162,981 - 162,981 = 4,000,000 SYI âœ… æ¢å¤
        // Staking: 37,019 + 162,981 = 200,000 SYI âœ… æ¢å¤

        // 5.2 åŒæ­¥ Pair çš„å‚¨å¤‡é‡ï¼ˆå…³é”®ï¼ï¼‰
        uniswapV2Pair.sync();

        // sync() çš„ä½œç”¨:
        // - å°† reserve (è´¦é¢) æ›´æ–°ä¸º balance (å®é™…)
        // - ç¡®ä¿ AMM ä»·æ ¼è®¡ç®—æ­£ç¡®
        // - é˜²æ­¢å¥—åˆ©æ”»å‡»
    }
}
```

**ä¸ºä»€ä¹ˆå¿…é¡»è°ƒç”¨ sync()ï¼Ÿ**

Uniswap V2 çš„ä»·æ ¼åŸºäº `reserve`ï¼ˆè´¦é¢å‚¨å¤‡é‡ï¼‰ï¼Œè€Œä¸æ˜¯ `balance`ï¼ˆå®é™…ä½™é¢ï¼‰ï¼š

```
é—®é¢˜ï¼šrecycle ç›´æ¥ä¿®æ”¹äº† balanceï¼Œä½† reserve è¿˜æ˜¯æ—§çš„

ä¿®æ”¹å‰:
â”œâ”€ Pair balance: 4,162,981 SYI (å®é™…ä½™é¢)
â””â”€ Pair reserve: 4,162,981 SYI (è´¦é¢å‚¨å¤‡) âœ… ä¸€è‡´

recycle å (æœª sync):
â”œâ”€ Pair balance: 4,000,000 SYI (å®é™…ä½™é¢)
â””â”€ Pair reserve: 4,162,981 SYI (è´¦é¢å‚¨å¤‡) âŒ ä¸ä¸€è‡´

åæœ:
â”œâ”€ AMM ä»·æ ¼è®¡ç®—é”™è¯¯ï¼ˆåŸºäºæ—§çš„ reserveï¼‰
â”œâ”€ K å€¼éªŒè¯å¤±è´¥ï¼ˆreserve0 * reserve1 != kï¼‰
â””â”€ ä¸‹ä¸€ç¬”äº¤æ˜“ä¼š revert

è°ƒç”¨ sync() å:
â”œâ”€ Pair balance: 4,000,000 SYI
â””â”€ Pair reserve: 4,000,000 SYI âœ… é‡æ–°ä¸€è‡´
```

**sync() æºç ** (Uniswap V2):
```solidity
function sync() external {
    _update(
        IERC20(token0).balanceOf(address(this)),
        IERC20(token1).balanceOf(address(this)),
        reserve0,
        reserve1
    );
}
// ä½œç”¨: å¼ºåˆ¶å°† reserve æ›´æ–°ä¸ºå½“å‰ balance
```

---

## Recycle æœºåˆ¶æ·±åº¦è§£æ

### æ ¸å¿ƒé—®é¢˜ï¼šä¸ºä»€ä¹ˆéœ€è¦ Recycleï¼Ÿ

#### åœºæ™¯å¯¹æ¯”

**åœºæ™¯ Aï¼šæ²¡æœ‰ Recycleï¼ˆä¼ ç»Ÿæ¨¡å¼ï¼‰**
```
åˆå§‹çŠ¶æ€:
â””â”€ Staking: 200,000 SYI å‚¨å¤‡

ç¬¬ 1 æ¬¡è§£è´¨æŠ¼:
â”œâ”€ ç”¨æˆ· A æç°ï¼Œå–å‡º 162,981 SYI
â”œâ”€ Staking ä½™é¢: 200,000 - 162,981 = 37,019 SYI âš ï¸
â””â”€ å‰©ä½™å‚¨å¤‡: 37,019 SYI

ç¬¬ 2 æ¬¡è§£è´¨æŠ¼:
â”œâ”€ ç”¨æˆ· B æç°ï¼Œéœ€è¦å–å‡º ~160,000 SYI
â”œâ”€ ä½† Staking åªæœ‰ 37,019 SYIï¼
â””â”€ âŒ äº¤æ˜“å¤±è´¥ï¼Œç³»ç»Ÿå´©æºƒ

è§£å†³æ–¹æ¡ˆ:
â””â”€ éœ€è¦å®šæœŸæ‰‹åŠ¨è¡¥å…… SYI å‚¨å¤‡ï¼ˆè¿è¥æˆæœ¬é«˜ï¼‰
```

**åœºæ™¯ Bï¼šæœ‰ Recycleï¼ˆåˆ›æ–°æ¨¡å¼ï¼‰**
```
åˆå§‹çŠ¶æ€:
â””â”€ Staking: 200,000 SYI å‚¨å¤‡

ç¬¬ 1 æ¬¡è§£è´¨æŠ¼:
â”œâ”€ 1. ç”¨æˆ· A æç°ï¼Œå–å‡º 162,981 SYI
â”‚   Staking ä½™é¢: 37,019 SYI âš ï¸
â”œâ”€ 2. è°ƒç”¨ recycle(162,981)
â”‚   ä» Pair å–å› 162,981 SYI
â””â”€ 3. Staking ä½™é¢: 37,019 + 162,981 = 200,000 SYI âœ…

ç¬¬ 2 æ¬¡è§£è´¨æŠ¼:
â”œâ”€ Staking ä¾ç„¶æœ‰ 200,000 SYI âœ…
â”œâ”€ å¯ä»¥æ­£å¸¸å¤„ç†æç°
â””â”€ å†æ¬¡ recycleï¼Œç»§ç»­å¾ªç¯

ç¬¬ N æ¬¡è§£è´¨æŠ¼:
â””â”€ ç†è®ºä¸Šå¯ä»¥æ— é™å¾ªç¯ â™¾ï¸
```

### Recycle çš„æœ¬è´¨

**Recycle ä¸æ˜¯"åˆ›é€ " SYIï¼Œè€Œæ˜¯"å€Ÿç”¨å¹¶å½’è¿˜"**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Staking éœ€è¦ USDT æ”¯ä»˜å¥–åŠ±              â”‚
â”‚         â†“                               â”‚
â”‚ ä½† Staking åªæœ‰ SYI å‚¨å¤‡                â”‚
â”‚         â†“                               â”‚
â”‚ 1. ç”¨ SYI åœ¨ DEX ä¸Šæ¢ USDT ï¼ˆå–å‡ºï¼‰    â”‚
â”‚         â†“                               â”‚
â”‚ 2. SYI æš‚æ—¶ç•™åœ¨ Pair ä¸­                â”‚
â”‚         â†“                               â”‚
â”‚ 3. Recycle æŠŠ SYI æ‹¿å›æ¥ ï¼ˆå½’è¿˜ï¼‰      â”‚
â”‚         â†“                               â”‚
â”‚ Staking çš„ SYI å‚¨å¤‡æ¢å¤ âœ…              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å…³é”®ç†è§£:
â”œâ”€ SYI åªæ˜¯"åª’ä»‹è´§å¸"ï¼Œä¸æ˜¯å¥–åŠ±æœ¬èº«
â”œâ”€ çœŸæ­£çš„å¥–åŠ±æ˜¯ USDTï¼ˆæ¥è‡ªåç»­ç”¨æˆ·è´¨æŠ¼ï¼‰
â””â”€ Recycle è®© SYI å¾ªç¯ä½¿ç”¨ï¼Œä¸ä¼šæ¶ˆè€—
```

### å®‰å…¨ä¸Šé™ï¼šä¸ºä»€ä¹ˆåªèƒ½å›æ”¶ 1/3ï¼Ÿ

**ä»£ç **: `uint256 maxRecyclable = pairBalance / 3;`

**åŸå› åˆ†æ**:

1. **ä¿æŠ¤æµåŠ¨æ€§æ·±åº¦**
   ```
   å¦‚æœå…è®¸å…¨éƒ¨å›æ”¶:
   â”œâ”€ Pair ä¸­ SYI è¢«æŠ½ç©º
   â”œâ”€ æµåŠ¨æ€§å½’é›¶
   â””â”€ ç”¨æˆ·æ— æ³•äº¤æ˜“ âŒ

   é™åˆ¶ 1/3:
   â”œâ”€ Pair è‡³å°‘ä¿ç•™ 2/3 çš„ SYI
   â”œâ”€ ä¿è¯ç”¨æˆ·å¯ä»¥æ­£å¸¸ä¹°å–
   â””â”€ ä»·æ ¼ä¸ä¼šå‰§çƒˆæ³¢åŠ¨ âœ…
   ```

2. **é˜²æ­¢ä»·æ ¼æ“çºµ**
   ```
   æ¶æ„æ”»å‡»åœºæ™¯:
   â”œâ”€ æ”»å‡»è€…å¤§é‡ä¹°å…¥ SYIï¼ˆæ¨é«˜ä»·æ ¼ï¼‰
   â”œâ”€ Pair ä¸­ SYI ä½™é¢å¢åŠ 
   â”œâ”€ å¦‚æœå…è®¸æ— é™ recycleï¼ŒStaking å¯ä»¥æ‹¿èµ°æ‰€æœ‰
   â””â”€ å¯¼è‡´ Pair æµåŠ¨æ€§å½’é›¶ï¼Œä»·æ ¼å´©ç›˜

   1/3 é™åˆ¶:
   â””â”€ å³ä½¿è¢«æ“çºµï¼Œä¹Ÿåªèƒ½å½±å“ 1/3 çš„æµåŠ¨æ€§
   ```

3. **å¤šäººå¹¶å‘æç°ä¿æŠ¤**
   ```
   æç«¯æƒ…å†µ:
   â”œâ”€ 10 ä¸ªç”¨æˆ·åŒæ—¶è§£è´¨æŠ¼
   â”œâ”€ Staking éœ€è¦è¿ç»­å–å‡º 10 æ¬¡
   â”œâ”€ æ¯æ¬¡å–å‡ºå Pair ä½™é¢å¢åŠ 
   â””â”€ ä½† recycle åªèƒ½æ‹¿å› 1/3ï¼Œé˜²æ­¢è€—å°½æ± å­
   ```

### Recycle çš„é™åˆ¶å’Œé£é™©

#### é£é™© 1: æµåŠ¨æ€§ä¸è¶³

```solidity
// å¦‚æœ Pair ä¸­ SYI å¤ªå°‘
uint256 pairBalance = 100,000 SYI;  // æ± å­å¾ˆæµ…
uint256 maxRecyclable = 100,000 / 3 = 33,333 SYI;  // æœ€å¤šå›æ”¶ 33k

// ä½† Staking éœ€è¦å›æ”¶ 162,981 SYI
recycle(162,981);  // å®é™…åªèƒ½å›æ”¶ 33,333 SYI âš ï¸

// ç»“æœ:
// Staking ä½™é¢: 37,019 + 33,333 = 70,352 SYI
// ä¾ç„¶ä¸å¤Ÿä¸‹æ¬¡è§£è´¨æŠ¼ä½¿ç”¨ âŒ
```

**è§£å†³æ–¹æ¡ˆ**:
- ç¡®ä¿æµåŠ¨æ€§æ± æ·±åº¦è‡³å°‘æ˜¯ Staking å‚¨å¤‡çš„ 10 å€
- ä¾‹å¦‚: Staking 200k SYI â†’ Pair è‡³å°‘ 2M SYI

#### é£é™© 2: å¤§é‡å¹¶å‘æç°

```
10 ä¸ªç”¨æˆ·åŒæ—¶è§£è´¨æŠ¼:
â”œâ”€ Staking åˆå§‹: 200,000 SYI
â”œâ”€ ç¬¬ 1 äºº: å–å‡º 162,981 SYI â†’ recycle â†’ æ¢å¤ 200k âœ…
â”œâ”€ ç¬¬ 2 äºº: å–å‡º 162,981 SYI â†’ recycle â†’ æ¢å¤ 200k âœ…
â”œâ”€ ...
â””â”€ ç¬¬ 10 äºº: å–å‡ºæ—¶ Pair å¯èƒ½å¤ªæµ…ï¼Œrecycle ä¸å¤Ÿ âš ï¸
```

**è§£å†³æ–¹æ¡ˆ**:
- å¢åŠ  Staking åˆå§‹å‚¨å¤‡ï¼ˆä¾‹å¦‚ 500k SYIï¼‰
- å®ç°æç°é˜Ÿåˆ—æœºåˆ¶
- ç›‘æ§ Pair æµåŠ¨æ€§æ·±åº¦

#### é£é™© 3: ä»·æ ¼æš´è·Œ

```
SYI ä»·æ ¼æš´è·Œ 50%:
â”œâ”€ éœ€è¦æ¢å– 1,563 USDT
â”œâ”€ åŸæœ¬éœ€è¦ 162,981 SYI
â””â”€ ç°åœ¨éœ€è¦ 325,962 SYIï¼âŒ

Staking å‚¨å¤‡ä¸å¤Ÿ:
â”œâ”€ åªæœ‰ 200,000 SYI
â””â”€ æ— æ³•å®Œæˆäº¤æ˜“
```

**è§£å†³æ–¹æ¡ˆ**:
- Staking å‚¨å¤‡åº”è¯¥è€ƒè™‘ä»·æ ¼æ³¢åŠ¨ï¼ˆ2-3 å€å®‰å…¨è¾¹é™…ï¼‰
- è®¾ç½®æœ€å¤§å•æ¬¡æç°é™é¢
- ç´§æ€¥æš‚åœæœºåˆ¶

---

## ä¸ä¸»æµ DeFi é¡¹ç›®å¯¹æ¯”

### å¸¸è§çš„è´¨æŠ¼å¥–åŠ±æ¨¡å¼

| æ¨¡å¼ | ä»£è¡¨é¡¹ç›® | ä¼˜ç‚¹ | ç¼ºç‚¹ | SYI é‡‡ç”¨? |
|------|---------|------|------|----------|
| **é¢„é“¸é€ å¥–åŠ±æ± ** | Synthetix, Curve | ç®€å•ï¼Œå¯é¢„æµ‹ | ä¼šè€—å°½ï¼Œéœ€å®šæœŸè¡¥å…… | âŒ |
| **é€šèƒ€é“¸é€ ** | Compound, Aave | ä¸è€—å°½ | æŒç»­é€šèƒ€ï¼Œç¨€é‡ŠæŒå¸è€… | âŒ |
| **äº¤æ˜“è´¹åˆ†çº¢** | PancakeSwap | å¯æŒç»­ | ä¾èµ–äº¤æ˜“é‡ï¼Œä¸ç¨³å®š | âŒ |
| **Rebase æœºåˆ¶** | Ampleforth, OHM | ä¸è€—å°½ | ä»·æ ¼å‰§çƒˆæ³¢åŠ¨ | âŒ |
| **ğŸ”¥ Recycle æœºåˆ¶** | **SYI (åˆ›æ–°)** | ä¸è€—å°½ï¼Œæ— é€šèƒ€ | ä¾èµ–æµåŠ¨æ€§æ·±åº¦ | âœ… |

### è¯¦ç»†å¯¹æ¯”

#### 1. Synthetix (é¢„é“¸é€ å¥–åŠ±æ± )

**æœºåˆ¶**:
```solidity
// éƒ¨ç½²æ—¶é¢„å…ˆé“¸é€  1 äº¿ SNX
uint256 public rewardPool = 100_000_000 ether;

function distributeReward(address user, uint256 amount) external {
    require(rewardPool >= amount, "Reward pool empty");
    rewardPool -= amount;
    SNX.transfer(user, amount);
}
```

**é—®é¢˜**:
- âŒ å¥–åŠ±æ± ä¼šè€—å°½ï¼Œéœ€è¦æ²»ç†æŠ•ç¥¨è¡¥å……
- âŒ åˆæœŸéœ€è¦é”å®šå¤§é‡ä»£å¸ï¼ˆæœºä¼šæˆæœ¬é«˜ï¼‰

---

#### 2. Compound (é€šèƒ€é“¸é€ )

**æœºåˆ¶**:
```solidity
// æ¯ä¸ªåŒºå—åŠ¨æ€é“¸é€ å¥–åŠ±
function distributeReward(address user, uint256 blocks) external {
    uint256 reward = blocks * COMP_PER_BLOCK;
    COMP.mint(user, reward);  // ç›´æ¥é“¸é€ æ–°ä»£å¸
}
```

**é—®é¢˜**:
- âŒ æŒç»­é€šèƒ€ï¼Œç¨€é‡Šæ‰€æœ‰æŒå¸è€…
- âŒ ä»£å¸ä»·æ ¼é•¿æœŸä¸‹è·Œå‹åŠ›

---

#### 3. PancakeSwap (äº¤æ˜“è´¹åˆ†çº¢)

**æœºåˆ¶**:
```solidity
// ä»äº¤æ˜“æ‰‹ç»­è´¹ä¸­åˆ†é…
function distributeReward() external {
    uint256 feeCollected = pair.feeTo();  // ä¾‹å¦‚: 1000 USDT
    uint256 rewardPerShare = feeCollected / totalStaked;
    // åˆ†é…ç»™è´¨æŠ¼è€…
}
```

**é—®é¢˜**:
- âŒ ä¾èµ–äº¤æ˜“é‡ï¼Œç†Šå¸‚æ—¶å¥–åŠ±æä½
- âŒ ä¸é€‚åˆä¿è¯å›ºå®š APY

---

#### 4. SYI (Recycle æœºåˆ¶)

**æœºåˆ¶**:
```solidity
// 1. ç”¨å‚¨å¤‡çš„ SYI æ¢ USDT
swapTokensForExactTokens(...);

// 2. ä»æ± å­å›æ”¶ SYI
recycle(syiTokensUsed);

// 3. å‚¨å¤‡æ¢å¤ï¼Œå¯ä»¥æ— é™å¾ªç¯
```

**ä¼˜åŠ¿**:
- âœ… ä»£å¸å‚¨å¤‡ä¸è€—å°½
- âœ… æ— éœ€æŒç»­å¢å‘ï¼ˆæ— é€šèƒ€ï¼‰
- âœ… ä¸ä¾èµ–äº¤æ˜“è´¹
- âœ… å¯ä»¥ä¿è¯å›ºå®š APY

**åŠ£åŠ¿**:
- âš ï¸ ä¾èµ–æµåŠ¨æ€§æ± æ·±åº¦
- âš ï¸ å¹¶å‘æç°é£é™©
- âš ï¸ ä»·æ ¼æ³¢åŠ¨æ•æ„Ÿ

---

### ç±»ä¼¼è®¾è®¡å‚è€ƒ

è™½ç„¶ Recycle æœºåˆ¶å¾ˆç½•è§ï¼Œä½†æœ‰å‡ ä¸ªé¡¹ç›®æœ‰ç±»ä¼¼æ¦‚å¿µï¼š

#### Liquity - Stability Pool

```solidity
// ç¨³å®šæ± ä»æ¸…ç®—ä¸­è·åˆ©ï¼Œä½†ä¸ç›´æ¥ä» DEX å›æ”¶
function liquidate(address borrower) external {
    uint256 collateral = vault[borrower].collateral;
    stabilityPool.addCollateral(collateral);  // ç±»ä¼¼å›æ”¶æ¦‚å¿µ
}
```

**ç›¸ä¼¼ç‚¹**: ä»å¤–éƒ¨ç³»ç»Ÿå›æ”¶èµ„äº§åˆ°å¥–åŠ±æ± 
**ä¸åŒç‚¹**: ä¸æ¶‰åŠ DEX æµåŠ¨æ€§æ“ä½œ

---

#### Frax Finance - AMO (Algorithmic Market Operations)

```solidity
// AMO å¯ä»¥ä»æ± å­ä¸´æ—¶å–å‡ºèµ„äº§æ“ä½œ
function rebalance() external onlyAMO {
    uint256 excess = pair.reserve0() - targetReserve;
    pair.skim(address(this), excess);  // å–å‡ºå¤šä½™èµ„äº§
    // ... æ“ä½œåå†æ”¾å›å»
}
```

**ç›¸ä¼¼ç‚¹**: ä»æµåŠ¨æ€§æ± å–å‡ºèµ„äº§åå†æ”¾å›
**ä¸åŒç‚¹**: ç”¨äºç¨³å®šå¸é”šå®šï¼Œéè´¨æŠ¼å¥–åŠ±

---

#### Olympus DAO - Bond æœºåˆ¶

```solidity
// é€šè¿‡ LP æ“ä½œæ”¯æŒå¥–åŠ±ï¼Œä½†ä¸æ˜¯ç›´æ¥ recycle
function bond(uint256 lpAmount) external {
    uint256 ohmAmount = calculateBondReward(lpAmount);
    OHM.mint(msg.sender, ohmAmount);  // ä»ç„¶æ˜¯å¢å‘
}
```

**ç›¸ä¼¼ç‚¹**: æ¶‰åŠæµåŠ¨æ€§ç®¡ç†
**ä¸åŒç‚¹**: ä¾ç„¶é€šè¿‡å¢å‘æ”¯ä»˜å¥–åŠ±

---

### ç»“è®º

**SYI çš„ Recycle æœºåˆ¶æ˜¯ä¸€ä¸ªåˆ›æ–°è®¾è®¡**ï¼Œåœ¨ä¸»æµ DeFi ä¸­å¾ˆå°‘è§åˆ°å®Œå…¨ç›¸åŒçš„å®ç°ã€‚å®ƒæ˜¯ä¸€ç§ï¼š

- **é«˜èµ„é‡‘æ•ˆç‡** çš„è´¨æŠ¼å¥–åŠ±æ–¹æ¡ˆ
- **é›¶é€šèƒ€** çš„å¯æŒç»­æ¨¡å¼
- **æµåŠ¨æ€§å‹å¥½** çš„å¾ªç¯ç³»ç»Ÿ

ä½†ä¹Ÿéœ€è¦æ³¨æ„ï¼š
- ä¸æ˜¯è¡Œä¸šæ ‡å‡†åšæ³•
- éœ€è¦ä¸¥æ ¼æµ‹è¯•å’Œç›‘æ§
- éœ€è¦å……è¶³çš„æµåŠ¨æ€§æ”¯æ’‘

---

## å®‰å…¨æ€§åˆ†æ

### å®‰å…¨æœºåˆ¶

#### 1. æƒé™æ§åˆ¶

```solidity
// contracts/SYI/abstract/SYIBase.sol:410
require(msg.sender == address(staking), "Only staking contract");
```

âœ… **é˜²æ­¢**: ä»»æ„åœ°å€è°ƒç”¨ recycle æŠ½å–æµåŠ¨æ€§

---

#### 2. æ•°é‡ä¸Šé™

```solidity
// contracts/SYI/abstract/SYIBase.sol:459
uint256 maxRecyclable = pairBalance / 3;
uint256 recycleAmount = amount >= maxRecyclable ? maxRecyclable : amount;
```

âœ… **é˜²æ­¢**:
- ä¸€æ¬¡æ€§æŠ½ç©ºæµåŠ¨æ€§
- ä»·æ ¼å‰§çƒˆæ³¢åŠ¨
- æ¶æ„æ”»å‡»

---

#### 3. å‚¨å¤‡é‡åŒæ­¥

```solidity
// contracts/SYI/abstract/SYIBase.sol:497
uniswapV2Pair.sync();
```

âœ… **é˜²æ­¢**:
- balance å’Œ reserve ä¸ä¸€è‡´
- AMM ä»·æ ¼è®¡ç®—é”™è¯¯
- å¥—åˆ©æ”»å‡»

---

### é£é™©åœºæ™¯åˆ†æ

#### åœºæ™¯ 1: æµåŠ¨æ€§æ± è¢«æŠ½ç©º

**æ”»å‡»æ­¥éª¤**:
```
1. æ”»å‡»è€…å¤§é‡ä¹°å…¥ SYIï¼ˆæ± å­ SYI å‡å°‘ï¼‰
2. æ­¤æ—¶ Pair ä¸­ SYI ä½™é¢å¾ˆä½
3. æ­£å¸¸ç”¨æˆ·è§£è´¨æŠ¼ï¼Œéœ€è¦ recycle
4. maxRecyclable = pairBalance / 3 â‰ˆ å¾ˆå°‘
5. Staking å‚¨å¤‡æ— æ³•æ¢å¤
```

**é˜²æŠ¤æªæ–½**:
```solidity
// 1. é™åˆ¶ 1/3 ä¸Šé™
uint256 maxRecyclable = pairBalance / 3;

// 2. Staking å¢åŠ åˆå§‹å‚¨å¤‡ï¼ˆä¾‹å¦‚ 500k SYIï¼‰
// 3. ç›‘æ§æµåŠ¨æ€§æ·±åº¦ï¼Œä½äºé˜ˆå€¼æ—¶æš‚åœè§£è´¨æŠ¼
require(pairBalance > MIN_LIQUIDITY, "Insufficient liquidity");
```

---

#### åœºæ™¯ 2: ä»·æ ¼æ“çºµ

**æ”»å‡»æ­¥éª¤**:
```
1. æ”»å‡»è€…é—ªç”µè´·å€Ÿå…¥å¤§é‡ USDT
2. åœ¨ Pair ä¸­ä¹°å…¥ SYIï¼ˆæ¨é«˜ä»·æ ¼ï¼‰
3. å—å®³ç”¨æˆ·è§£è´¨æŠ¼ï¼Œå– SYI æ—¶ä»·æ ¼è™šé«˜
4. recycle æ—¶è·å¾—çš„ SYI å°‘äºé¢„æœŸ
5. æ”»å‡»è€…å½’è¿˜é—ªç”µè´·ï¼Œä»·æ ¼å›è½
```

**é˜²æŠ¤æªæ–½**:
```solidity
// 1. ä½¿ç”¨ TWAP (æ—¶é—´åŠ æƒå¹³å‡ä»·æ ¼)
// 2. é™åˆ¶å•ç¬”äº¤æ˜“æœ€å¤§æ»‘ç‚¹
uint256 slippageTolerance = 15%; // æœ€å¤§ 15% æ»‘ç‚¹

// 3. è®¾ç½®å†·å´æœŸ
require(block.timestamp - lastBuyTime[user] > COOLDOWN, "Too frequent");
```

---

#### åœºæ™¯ 3: é‡å…¥æ”»å‡»

**æ”»å‡»åœºæ™¯**:
```
1. æ¶æ„åˆçº¦è°ƒç”¨ unstake()
2. åœ¨æ¥æ”¶ USDT æ—¶ï¼ˆfallback/receiveï¼‰
3. å†æ¬¡è°ƒç”¨ unstake()
4. å¯èƒ½åœ¨ recycle å‰å¤šæ¬¡å–å‡º SYI
```

**é˜²æŠ¤æªæ–½**:
```solidity
// 1. ä½¿ç”¨ Checks-Effects-Interactions æ¨¡å¼
user_record.status = true;  // å…ˆä¿®æ”¹çŠ¶æ€
_update(sender, address(0), amount);  // å†é”€æ¯ä»£å¸
IERC20(USDT).transfer(msg.sender, userPayout);  // æœ€åè½¬è´¦

// 2. ä½¿ç”¨ ReentrancyGuard
import "@openzeppelin/contracts/security/ReentrancyGuard.sol";
function unstake() external nonReentrant { ... }
```

---

### å»ºè®®çš„ç›‘æ§æŒ‡æ ‡

```javascript
// é“¾ä¸‹ç›‘æ§è„šæœ¬
async function monitorSystem() {
    // 1. Staking SYI å‚¨å¤‡
    const stakingBalance = await syi.balanceOf(staking.address);
    if (stakingBalance < MIN_RESERVE) {
        alert("âš ï¸ Staking reserve too low!");
    }

    // 2. Pair æµåŠ¨æ€§æ·±åº¦
    const [reserve0, reserve1] = await pair.getReserves();
    const syiReserve = reserve0;  // å‡è®¾ token0 æ˜¯ SYI
    if (syiReserve < MIN_LIQUIDITY) {
        alert("âš ï¸ Pair liquidity too low!");
    }

    // 3. å‚¨å¤‡æ¢å¤ç‡
    const recycleSuccessRate = stakingBalance / INITIAL_RESERVE;
    if (recycleSuccessRate < 0.8) {
        alert("âš ï¸ Recycle not working properly!");
    }

    // 4. ä»·æ ¼åç¦»åº¦
    const currentPrice = reserve1 / reserve0;
    const deviation = Math.abs(currentPrice - expectedPrice) / expectedPrice;
    if (deviation > 0.2) {
        alert("âš ï¸ Price deviation too high!");
    }
}

setInterval(monitorSystem, 60000);  // æ¯åˆ†é’Ÿæ£€æŸ¥
```

---

## å…³é”®ä»£ç ç´¢å¼•

### æ ¸å¿ƒåˆçº¦æ–‡ä»¶

```
contracts/
â”œâ”€â”€ SYI/
â”‚   â”œâ”€â”€ abstract/
â”‚   â”‚   â””â”€â”€ SYIBase.sol                    # SYI æ ¸å¿ƒé€»è¾‘
â”‚   â”‚       â”œâ”€â”€ recycle()                  # â­ Recycle æœºåˆ¶ (L405-505)
â”‚   â”‚       â””â”€â”€ _update()                  # ä»£å¸è½¬è´¦é€»è¾‘ (L656-687)
â”‚   â””â”€â”€ mainnet/
â”‚       â””â”€â”€ SYI.sol                        # ä¸»ç½‘é…ç½®
â”‚
â””â”€â”€ SYI-Staking/
    â”œâ”€â”€ abstract/
    â”‚   â””â”€â”€ StakingBase.sol                # Staking æ ¸å¿ƒé€»è¾‘
    â”‚       â”œâ”€â”€ unstake()                  # â­ è§£è´¨æŠ¼å…¥å£ (L200-264)
    â”‚       â”œâ”€â”€ _burn()                    # è®¡ç®—å¥–åŠ± (L897-920)
    â”‚       â”œâ”€â”€ _swapSYIForReward()        # â­ å– SYI æ¢ USDT (L922-950)
    â”‚       â”œâ”€â”€ _distributeFriendReward()  # Friend å¥–åŠ± (L999-1012)
    â”‚       â”œâ”€â”€ _distributeTeamReward()    # å›¢é˜Ÿå¥–åŠ± (L1014-1078)
    â”‚       â””â”€â”€ _recordWithdrawal()        # è®°å½•æç° (L1343-1388)
    â””â”€â”€ mainnet/
        â””â”€â”€ Staking.sol                    # ä¸»ç½‘é…ç½®
```

### å…³é”®å‡½æ•°è°ƒç”¨é“¾

```
ç”¨æˆ·è°ƒç”¨ unstake()
  â””â”€> contracts/SYI-Staking/abstract/StakingBase.sol:200
      â”‚
      â”œâ”€> _burn(stakeIndex)
      â”‚   â””â”€> L897: è®¡ç®—å¥–åŠ±ï¼Œé”€æ¯ sSYI
      â”‚
      â”œâ”€> _swapSYIForReward(calculatedReward)
      â”‚   â””â”€> L922: ç”¨ Staking å‚¨å¤‡çš„ SYI æ¢ USDT
      â”‚       â””â”€> Router.swapTokensForExactTokens(...)
      â”‚
      â”œâ”€> _distributeFriendReward(...)
      â”‚   â””â”€> L999: åˆ†é… 5% ç»™ Friend
      â”‚
      â”œâ”€> _distributeTeamReward(...)
      â”‚   â””â”€> L1014: åˆ†é… 35% ç»™å›¢é˜Ÿ
      â”‚
      â”œâ”€> IERC20(USDT).transfer(msg.sender, userPayout)
      â”‚   â””â”€> L258: è½¬è´¦ USDT ç»™ç”¨æˆ·
      â”‚
      â””â”€> SYI.recycle(syiTokensUsed)
          â””â”€> contracts/SYI/abstract/SYIBase.sol:405
              â”‚
              â”œâ”€> L410: æƒé™æ£€æŸ¥
              â”œâ”€> L448: è·å– Pair çš„ SYI ä½™é¢
              â”œâ”€> L459: è®¡ç®—å®‰å…¨ä¸Šé™ (1/3)
              â”œâ”€> L477: _update(Pair, Staking, recycleAmount)
              â””â”€> L497: Pair.sync() åŒæ­¥å‚¨å¤‡
```

### å…³é”®å˜é‡ä½ç½®

```solidity
// Staking åˆçº¦
contracts/SYI-Staking/abstract/StakingBase.sol
â”œâ”€ L90:  USDT (immutable)
â”œâ”€ L91:  ROUTER (immutable)
â”œâ”€ L98:  SYI (å¯è®¾ç½®)
â”œâ”€ L105: totalSupply (sSYI æ€»é‡)
â”œâ”€ L106: balances (ç”¨æˆ· sSYI ä½™é¢)
â””â”€ L116: userStakeRecord (è´¨æŠ¼è®°å½•)

// SYI åˆçº¦
contracts/SYI/abstract/SYIBase.sol
â”œâ”€ L213: USDT (immutable)
â”œâ”€ L214: uniswapV2Router (immutable)
â”œâ”€ L215: staking (immutable)
â””â”€ L221: uniswapV2Pair (å¯è®¾ç½®)
```

---

## å¸¸è§é—®é¢˜ FAQ

### Q1: Staking åˆçº¦éœ€è¦å¤šå°‘ SYI å‚¨å¤‡ï¼Ÿ

**ç­”**: å–å†³äºä»¥ä¸‹å› ç´ ï¼š

```
æœ€å°å‚¨å¤‡è®¡ç®—å…¬å¼:
minReserve = maxStakeAmount Ã— maxAPY Ã— maxConcurrentUnstakes Ã— safetyMargin

ç¤ºä¾‹:
â”œâ”€ maxStakeAmount: 1,000 USDT (å•æ¬¡æœ€å¤§è´¨æŠ¼)
â”œâ”€ maxAPY: 56.31% (30 å¤©æ¡£æœ€é«˜æ”¶ç›Š)
â”œâ”€ maxConcurrentUnstakes: 5 (å‡è®¾æœ€å¤š 5 äººåŒæ—¶æç°)
â”œâ”€ safetyMargin: 2x (è€ƒè™‘ä»·æ ¼æ³¢åŠ¨)
â””â”€ SYI ä»·æ ¼: 0.01 USDT/SYI

è®¡ç®—:
1. å•æ¬¡æœ€å¤§å¥–åŠ±: 1,000 Ã— 1.5631 = 1,563.1 USDT
2. éœ€è¦ SYI: 1,563.1 / 0.01 = 156,310 SYI
3. å¹¶å‘ 5 äºº: 156,310 Ã— 5 = 781,550 SYI
4. å®‰å…¨è¾¹é™…: 781,550 Ã— 2 = 1,563,100 SYI

å»ºè®®å‚¨å¤‡: 1,500,000 - 2,000,000 SYI
```

ä½†ç”±äº **recycle æœºåˆ¶**ï¼Œå®é™…å¯ä»¥æ›´å°‘ï¼š
- æœ€ä½: 500,000 SYI
- æ¨è: 1,000,000 SYI
- ä¿å®ˆ: 2,000,000 SYI

---

### Q2: å¦‚æœ recycle å¤±è´¥ä¼šæ€æ ·ï¼Ÿ

**å¤±è´¥åœºæ™¯**:
```solidity
// Pair ä¸­ SYI å¤ªå°‘
uint256 pairBalance = 50,000 SYI;
uint256 maxRecyclable = 50,000 / 3 = 16,666 SYI;

// ä½†éœ€è¦å›æ”¶ 162,981 SYI
recycle(162,981);  // å®é™…åªå›æ”¶ 16,666 SYI
```

**åæœ**:
```
Staking ä½™é¢:
â”œâ”€ å–å‡ºå‰: 200,000 SYI
â”œâ”€ å–å‡ºå: 37,019 SYI
â”œâ”€ recycle å: 37,019 + 16,666 = 53,685 SYI âš ï¸
â””â”€ ä¸‹æ¬¡æç°å¯èƒ½ä¸å¤Ÿç”¨

è§£å†³æ–¹æ¡ˆ:
â”œâ”€ 1. å¢åŠ  Staking åˆå§‹å‚¨å¤‡
â”œâ”€ 2. ç¡®ä¿ Pair æµåŠ¨æ€§å……è¶³
â”œâ”€ 3. é™åˆ¶æœ€å¤§è´¨æŠ¼é¢åº¦
â””â”€ 4. å®ç°æç°é˜Ÿåˆ—æœºåˆ¶
```

---

### Q3: Recycle ä¼šå½±å“ SYI ä»·æ ¼å—ï¼Ÿ

**ç­”**: ä¼šï¼Œä½†å½±å“å¾ˆå°ã€‚

```
å‡è®¾åˆå§‹çŠ¶æ€:
â”œâ”€ Pair: 4,000,000 SYI + 40,000 USDT
â””â”€ ä»·æ ¼: 40,000 / 4,000,000 = 0.01 USDT/SYI

æ­¥éª¤ 1: å–å‡º SYI
â”œâ”€ Pair: 4,162,981 SYI + 38,436.9 USDT
â”œâ”€ ä»·æ ¼: 38,436.9 / 4,162,981 = 0.00923 USDT/SYI
â””â”€ ä»·æ ¼ä¸‹è·Œ: -7.7% âš ï¸

æ­¥éª¤ 2: Recycle
â”œâ”€ Pair: 4,000,000 SYI + 38,436.9 USDT
â”œâ”€ ä»·æ ¼: 38,436.9 / 4,000,000 = 0.00961 USDT/SYI
â””â”€ ä»·æ ¼å›å‡: +4.1%

æœ€ç»ˆå½±å“:
â”œâ”€ åˆå§‹ä»·æ ¼: 0.01 USDT/SYI
â”œâ”€ æœ€ç»ˆä»·æ ¼: 0.00961 USDT/SYI
â””â”€ å‡€ä¸‹è·Œ: -3.9% (ä»… USDT è¢«å–èµ°çš„å½±å“)
```

**å…³é”®ç‚¹**:
- âœ… Recycle è®© SYI æ•°é‡æ¢å¤ï¼Œä»·æ ¼éƒ¨åˆ†å›å‡
- âš ï¸ ä½† USDT è¢«å–èµ°äº†ï¼Œæ‰€ä»¥ä»·æ ¼ä»ä¼šç•¥å¾®ä¸‹è·Œ
- âœ… ä¸‹è·Œå¹…åº¦è¿œå°äºæ²¡æœ‰ recycle çš„æƒ…å†µ

---

### Q4: è¿™ä¸ªæœºåˆ¶åˆæ³•/åˆè§„å—ï¼Ÿ

**æŠ€æœ¯è§’åº¦**: å®Œå…¨åˆæ³•ï¼Œè¿™æ˜¯æ™ºèƒ½åˆçº¦çš„æ­£å¸¸é€»è¾‘ã€‚

**é£é™©æç¤º**:
```
âœ… ä¼˜ç‚¹:
â”œâ”€ ä»£ç å¼€æºï¼Œé€»è¾‘é€æ˜
â”œâ”€ æ²¡æœ‰åé—¨æˆ–æ¶æ„ä»£ç 
â””â”€ ç¬¦åˆ DeFi å»ä¸­å¿ƒåŒ–åŸåˆ™

âš ï¸ æ³¨æ„:
â”œâ”€ ä¸æ˜¯è¡Œä¸šæ ‡å‡†åšæ³•ï¼ˆåˆ›æ–°ä½†æœªç»å¤§è§„æ¨¡éªŒè¯ï¼‰
â”œâ”€ ä¾èµ–æµåŠ¨æ€§æ·±åº¦ï¼ˆéœ€è¦å……è¶³çš„ LPï¼‰
â”œâ”€ éœ€è¦å……åˆ†çš„å®¡è®¡å’Œæµ‹è¯•
â””â”€ å‘ç”¨æˆ·æ¸…æ™°æŠ«éœ²æœºåˆ¶åŸç†
```

**å»ºè®®**:
1. è¿›è¡Œä¸“ä¸šçš„æ™ºèƒ½åˆçº¦å®¡è®¡
2. åœ¨æ–‡æ¡£ä¸­æ¸…æ™°è¯´æ˜ recycle æœºåˆ¶
3. è¿›è¡Œå……åˆ†çš„æµ‹è¯•ç½‘æµ‹è¯•
4. é€æ­¥å¢åŠ  TVLï¼Œé¿å…ä¸€æ¬¡æ€§å¤§é‡èµ„é‡‘æ¶Œå…¥

---

### Q5: å¯ä»¥å–æ¶ˆ recycle å—ï¼Ÿ

**å¯ä»¥ï¼Œä½†ä¸æ¨è**:

```solidity
// æ–¹æ¡ˆ A: æ³¨é‡Šæ‰ recycle è°ƒç”¨
function unstake(uint256 stakeIndex) external returns (uint256) {
    // ... å– SYI æ¢ USDT
    // SYI.recycle(syiTokensUsed);  // âŒ ä¸è°ƒç”¨ recycle
}

// åæœ:
// â”œâ”€ Staking å‚¨å¤‡ä¼šé€æ¸è€—å°½
// â””â”€ éœ€è¦å®šæœŸæ‰‹åŠ¨è¡¥å…… SYI
```

**æ›¿ä»£æ–¹æ¡ˆ**:

```solidity
// æ–¹æ¡ˆ B: æ”¹ä¸ºé€šèƒ€æ¨¡å¼
function unstake(uint256 stakeIndex) external returns (uint256) {
    // ... è®¡ç®—å¥–åŠ±

    // ä¸å– SYIï¼Œç›´æ¥é“¸é€  USDTï¼ˆå¦‚æœæ˜¯ç¨³å®šå¸é¡¹ç›®ï¼‰
    USDT.mint(address(this), calculatedReward);

    // æˆ–è€…ä»å¥–åŠ±æ± è½¬è´¦
    USDT.transferFrom(rewardPool, address(this), calculatedReward);
}
```

**ç»“è®º**: Recycle æ˜¯è¿™ä¸ªç³»ç»Ÿçš„æ ¸å¿ƒæœºåˆ¶ï¼Œå–æ¶ˆåéœ€è¦é‡æ–°è®¾è®¡æ•´ä¸ªå¥–åŠ±åˆ†é…é€»è¾‘ã€‚

---

## æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

1. **Staking åˆçº¦æœ‰ SYI å‚¨å¤‡** (å¿…é¡»é¢„å……å€¼)
2. **è§£è´¨æŠ¼æ—¶ç”¨å‚¨å¤‡å– SYI æ¢ USDT** (æ”¯ä»˜å¥–åŠ±)
3. **Recycle ä» Pair å›æ”¶ SYI** (æ¢å¤å‚¨å¤‡)
4. **å‚¨å¤‡å¾ªç¯ä½¿ç”¨ï¼Œç†è®ºä¸Šæ°¸ä¸è€—å°½** â™¾ï¸

### åˆ›æ–°ç‚¹

- âœ… **é›¶é€šèƒ€**: ä¸éœ€è¦å¢å‘ä»£å¸
- âœ… **é«˜æ•ˆç‡**: èµ„é‡‘å¾ªç¯åˆ©ç”¨
- âœ… **å¯æŒç»­**: ä¸ä¾èµ–äº¤æ˜“è´¹æˆ–å¤–éƒ¨æ”¶å…¥

### æ³¨æ„äº‹é¡¹

- âš ï¸ **ä¾èµ–æµåŠ¨æ€§**: éœ€è¦å……è¶³çš„ Pair æ·±åº¦
- âš ï¸ **å¹¶å‘é£é™©**: å¤§é‡åŒæ—¶æç°å¯èƒ½å¯¼è‡´å‚¨å¤‡ä¸è¶³
- âš ï¸ **ä»·æ ¼æ•æ„Ÿ**: ä»·æ ¼æš´è·Œä¼šå¢åŠ  SYI æ¶ˆè€—

### æ¨èé…ç½®

```
æœ€ä½é…ç½®:
â”œâ”€ Staking å‚¨å¤‡: 500,000 SYI
â””â”€ Pair æµåŠ¨æ€§: 5,000,000 SYI + 50,000 USDT

æ¨èé…ç½®:
â”œâ”€ Staking å‚¨å¤‡: 1,000,000 SYI
â””â”€ Pair æµåŠ¨æ€§: 10,000,000 SYI + 100,000 USDT

ä¿å®ˆé…ç½®:
â”œâ”€ Staking å‚¨å¤‡: 2,000,000 SYI
â””â”€ Pair æµåŠ¨æ€§: 20,000,000 SYI + 200,000 USDT
```

---

## é™„å½•

### å®Œæ•´è°ƒç”¨ç¤ºä¾‹

```javascript
// JavaScript æµ‹è¯•è„šæœ¬
const { ethers } = require("hardhat");

async function testUnstakeWithRecycle() {
    const [user] = await ethers.getSigners();

    // 1. æŸ¥è¯¢åˆå§‹çŠ¶æ€
    console.log("=== åˆå§‹çŠ¶æ€ ===");
    const stakingBalance = await syi.balanceOf(staking.address);
    const [reserve0, reserve1] = await pair.getReserves();
    console.log(`Staking SYI: ${ethers.utils.formatEther(stakingBalance)}`);
    console.log(`Pair SYI: ${ethers.utils.formatEther(reserve0)}`);
    console.log(`Pair USDT: ${ethers.utils.formatEther(reserve1)}`);

    // 2. æ‰§è¡Œè§£è´¨æŠ¼
    console.log("\n=== æ‰§è¡Œè§£è´¨æŠ¼ ===");
    const tx = await staking.unstake(0);
    const receipt = await tx.wait();

    // 3. æŸ¥è¯¢æœ€ç»ˆçŠ¶æ€
    console.log("\n=== æœ€ç»ˆçŠ¶æ€ ===");
    const stakingBalanceAfter = await syi.balanceOf(staking.address);
    const [reserve0After, reserve1After] = await pair.getReserves();
    console.log(`Staking SYI: ${ethers.utils.formatEther(stakingBalanceAfter)}`);
    console.log(`Pair SYI: ${ethers.utils.formatEther(reserve0After)}`);
    console.log(`Pair USDT: ${ethers.utils.formatEther(reserve1After)}`);

    // 4. éªŒè¯ recycle æ•ˆæœ
    console.log("\n=== Recycle æ•ˆæœ ===");
    console.log(`Staking å‚¨å¤‡æ¢å¤: ${stakingBalance.eq(stakingBalanceAfter) ? 'âœ…' : 'âŒ'}`);
    console.log(`Pair SYI æ¢å¤: ${reserve0.eq(reserve0After) ? 'âœ…' : 'âš ï¸ æœ‰å·®å¼‚'}`);
}

testUnstakeWithRecycle();
```

### ç›¸å…³æ–‡æ¡£

- [SYI-Recycleæœºåˆ¶æµç¨‹å›¾.md](./SYI-Recycleæœºåˆ¶æµç¨‹å›¾.md) - å›¾å½¢åŒ–æµç¨‹è¯´æ˜
- [åˆçº¦éƒ¨ç½²æŒ‡å—.md](./åˆçº¦éƒ¨ç½²æŒ‡å—.md) - éƒ¨ç½²å’Œé…ç½®è¯´æ˜
- [æµ‹è¯•ç”¨ä¾‹æ–‡æ¡£.md](./æµ‹è¯•ç”¨ä¾‹æ–‡æ¡£.md) - å®Œæ•´æµ‹è¯•åœºæ™¯

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2025-01-XX
**ç»´æŠ¤è€…**: Development Team
