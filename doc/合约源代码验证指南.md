# BSC ä¸»ç½‘åˆçº¦æºä»£ç éªŒè¯æŒ‡å—

æœ¬æ–‡æ¡£è¯´æ˜å¦‚ä½•åœ¨éƒ¨ç½²åˆçº¦åˆ° BSC ä¸»ç½‘åï¼Œå°†æºä»£ç æäº¤åˆ° BscScan è¿›è¡ŒéªŒè¯ã€‚

## ä¸ºä»€ä¹ˆéœ€è¦éªŒè¯åˆçº¦ï¼Ÿ

- **é€æ˜åº¦**ï¼šç”¨æˆ·å¯ä»¥åœ¨ BscScan ä¸ŠæŸ¥çœ‹å’Œå®¡è®¡åˆçº¦æºä»£ç 
- **å¯ä¿¡åº¦**ï¼šéªŒè¯çš„åˆçº¦æ˜¾ç¤ºç»¿è‰²å¯¹å‹¾ï¼Œæå‡é¡¹ç›®å¯ä¿¡åº¦
- **äº¤äº’**ï¼šBscScan æä¾› Read/Write Contract ç•Œé¢ï¼Œæ–¹ä¾¿ç›´æ¥è°ƒç”¨åˆçº¦å‡½æ•°
- **ç”Ÿæ€é›†æˆ**ï¼šè®¸å¤š DeFi å·¥å…·å’Œé’±åŒ…ä¾èµ–éªŒè¯çš„åˆçº¦

## ä¸€ã€å®‰è£…ä¾èµ–

```bash
npm install --save-dev @nomicfoundation/hardhat-verify
```

å¦‚æœä½¿ç”¨ç¯å¢ƒå˜é‡ç®¡ç†æ•æ„Ÿä¿¡æ¯ï¼ˆæ¨èï¼‰ï¼š

```bash
npm install --save-dev dotenv
```

## äºŒã€é…ç½® Hardhat

### 1. è·å– BscScan API Key

1. è®¿é—® [https://bscscan.com/myapikey](https://bscscan.com/myapikey)
2. ç™»å½•æˆ–æ³¨å†Œ BscScan è´¦å·
3. ç‚¹å‡» "Add" åˆ›å»ºæ–°çš„ API Key
4. å¤åˆ¶ç”Ÿæˆçš„ API Key

### 2. é…ç½®ç¯å¢ƒå˜é‡ï¼ˆæ¨èï¼‰

åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `.env` æ–‡ä»¶ï¼š

```env
# BscScan API Key
BSCSCAN_API_KEY=ä½ çš„APIå¯†é’¥

# BSC ä¸»ç½‘ç§é’¥ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰
BSC_PRIVATE_KEY=ä½ çš„é’±åŒ…ç§é’¥
```

**é‡è¦**ï¼šå°† `.env` æ·»åŠ åˆ° `.gitignore`ï¼Œé¿å…æ³„éœ²æ•æ„Ÿä¿¡æ¯ï¼

```bash
echo ".env" >> .gitignore
```

### 3. ä¿®æ”¹ hardhat.config.js

åœ¨ `hardhat.config.js` é¡¶éƒ¨æ·»åŠ ï¼š

```javascript
require("@nomicfoundation/hardhat-verify");
require("dotenv").config();
```

åœ¨é…ç½®å¯¹è±¡ä¸­æ·»åŠ  `etherscan` é…ç½®ï¼š

```javascript
module.exports = {
  solidity: {
    // ... ç°æœ‰é…ç½®
  },

  networks: {
    // ... ç°æœ‰ç½‘ç»œé…ç½®
  },

  // æ·»åŠ éªŒè¯é…ç½®
  etherscan: {
    apiKey: {
      bsc: process.env.BSCSCAN_API_KEY,
      bscTestnet: process.env.BSCSCAN_API_KEY
    }
  },

  sourcify: {
    enabled: false  // å¯é€‰ï¼šåªä½¿ç”¨ BscScan
  }
};
```

## ä¸‰ã€éªŒè¯æ–¹æ³•

### æ–¹æ³• Aï¼šæ‰‹åŠ¨éªŒè¯ï¼ˆæœ€ç®€å•ï¼‰

éƒ¨ç½²å®Œæˆåï¼Œæ‰‹åŠ¨è¿è¡ŒéªŒè¯å‘½ä»¤ï¼š

```bash
npx hardhat verify --network bsc <åˆçº¦åœ°å€> <æ„é€ å‡½æ•°å‚æ•°1> <å‚æ•°2> ...
```

#### ç¤ºä¾‹

**éªŒè¯ Referral åˆçº¦**ï¼š

```bash
# å‡è®¾éƒ¨ç½²åçš„åˆçº¦åœ°å€æ˜¯ 0x1234567890123456789012345678901234567890
npx hardhat verify --network bsc \
  0x1234567890123456789012345678901234567890 \
  "0xF4d1cD67cD570aE5e78ae89Bf664A299DeEdEFC7"
```

**éªŒè¯å¸¦å¤šä¸ªå‚æ•°çš„åˆçº¦**ï¼š

```bash
npx hardhat verify --network bsc \
  <åˆçº¦åœ°å€> \
  "å‚æ•°1" \
  "å‚æ•°2" \
  123
```

**éªŒè¯å¤æ‚æ„é€ å‡½æ•°å‚æ•°**ï¼š

å¦‚æœæ„é€ å‡½æ•°å‚æ•°å¤æ‚ï¼ˆå¦‚æ•°ç»„ã€ç»“æ„ä½“ï¼‰ï¼Œåˆ›å»ºå‚æ•°æ–‡ä»¶ `arguments.js`ï¼š

```javascript
module.exports = [
  "0xF4d1cD67cD570aE5e78ae89Bf664A299DeEdEFC7",
  ["0x123...", "0x456..."],
  { rate: 100, duration: 86400 }
];
```

ç„¶åä½¿ç”¨ï¼š

```bash
npx hardhat verify --network bsc \
  --constructor-args arguments.js \
  <åˆçº¦åœ°å€>
```

### æ–¹æ³• Bï¼šéƒ¨ç½²è„šæœ¬ä¸­è‡ªåŠ¨éªŒè¯ï¼ˆæ¨èï¼‰

ä¿®æ”¹éƒ¨ç½²è„šæœ¬ï¼Œåœ¨éƒ¨ç½²åè‡ªåŠ¨éªŒè¯ã€‚

#### ç¤ºä¾‹ï¼šä¿®æ”¹ `scripts/deployReferral.js`

åœ¨éƒ¨ç½²é€»è¾‘åæ·»åŠ éªŒè¯ä»£ç ï¼š

```javascript
const hre = require("hardhat");
const fs = require("fs");

async function main() {
  const [deployer] = await ethers.getSigners();
  console.log("Deploying contracts with the account:", deployer.address);

  // éƒ¨ç½²å‚æ•°
  const rootAddress = "0xF4d1cD67cD570aE5e78ae89Bf664A299DeEdEFC7";

  // éƒ¨ç½²åˆçº¦
  const Referral = await ethers.getContractFactory("Referral");
  const referral = await Referral.deploy(rootAddress);
  await referral.waitForDeployment();

  const contractAddress = await referral.getAddress();
  console.log("âœ… Referral deployed to:", contractAddress);

  // ä¿å­˜éƒ¨ç½²ä¿¡æ¯
  const deploymentInfo = {
    address: contractAddress,
    rootAddress: rootAddress,
    network: hre.network.name,
    deployer: deployer.address,
    timestamp: new Date().toISOString()
  };

  fs.writeFileSync(
    'syi-referral-deployment.json',
    JSON.stringify(deploymentInfo, null, 2)
  );

  // === è‡ªåŠ¨éªŒè¯éƒ¨åˆ† ===
  if (hre.network.name === "bsc" || hre.network.name === "bscTestnet") {
    console.log("\nâ³ Waiting for block confirmations...");
    await referral.deploymentTransaction().wait(5);  // ç­‰å¾… 5 ä¸ªåŒºå—ç¡®è®¤

    console.log("ğŸ” Verifying contract on BscScan...");
    try {
      await hre.run("verify:verify", {
        address: contractAddress,
        constructorArguments: [rootAddress],
      });
      console.log("âœ… Contract verified successfully!");
    } catch (error) {
      if (error.message.includes("Already Verified")) {
        console.log("â„¹ï¸  Contract already verified");
      } else {
        console.error("âŒ Verification failed:", error.message);
        console.log("\nå¯ä»¥ç¨åæ‰‹åŠ¨éªŒè¯ï¼š");
        console.log(`npx hardhat verify --network ${hre.network.name} ${contractAddress} "${rootAddress}"`);
      }
    }
  }
}

main()
  .then(() => process.exit(0))
  .catch((error) => {
    console.error(error);
    process.exit(1);
  });
```

#### å…³é”®ç‚¹è¯´æ˜

1. **ç­‰å¾…åŒºå—ç¡®è®¤**ï¼š`wait(5)` ç­‰å¾… 5 ä¸ªåŒºå—ï¼Œç¡®ä¿åˆçº¦å·²ä¸Šé“¾
2. **é”™è¯¯å¤„ç†**ï¼šæ•è·"å·²éªŒè¯"å’Œå…¶ä»–é”™è¯¯ï¼Œæä¾›å‹å¥½æç¤º
3. **ç½‘ç»œåˆ¤æ–­**ï¼šåªåœ¨ä¸»ç½‘/æµ‹è¯•ç½‘éªŒè¯ï¼Œæœ¬åœ°ç½‘ç»œè·³è¿‡
4. **æ‰‹åŠ¨å‘½ä»¤æç¤º**ï¼šéªŒè¯å¤±è´¥æ—¶æä¾›æ‰‹åŠ¨éªŒè¯å‘½ä»¤

### æ–¹æ³• Cï¼šç‹¬ç«‹éªŒè¯è„šæœ¬

åˆ›å»º `scripts/verifyReferral.js`ï¼š

```javascript
const hre = require("hardhat");
const fs = require("fs");

async function main() {
  // è¯»å–éƒ¨ç½²ä¿¡æ¯
  const deploymentPath = 'syi-referral-deployment.json';

  if (!fs.existsSync(deploymentPath)) {
    console.error("âŒ æœªæ‰¾åˆ°éƒ¨ç½²æ–‡ä»¶:", deploymentPath);
    console.log("è¯·å…ˆè¿è¡Œéƒ¨ç½²è„šæœ¬ï¼šnpx hardhat run scripts/deployReferral.js --network bsc");
    process.exit(1);
  }

  const deployment = JSON.parse(fs.readFileSync(deploymentPath, 'utf8'));

  const contractAddress = deployment.address;
  const rootAddress = deployment.rootAddress;

  console.log("åˆçº¦åœ°å€:", contractAddress);
  console.log("æ„é€ å‚æ•°:", rootAddress);
  console.log("ç½‘ç»œ:", hre.network.name);
  console.log("\nğŸ” å¼€å§‹éªŒè¯...\n");

  try {
    await hre.run("verify:verify", {
      address: contractAddress,
      constructorArguments: [rootAddress],
    });
    console.log("\nâœ… éªŒè¯æˆåŠŸ!");
    console.log(`æŸ¥çœ‹ï¼šhttps://bscscan.com/address/${contractAddress}#code`);
  } catch (error) {
    if (error.message.includes("Already Verified")) {
      console.log("\nâ„¹ï¸  åˆçº¦å·²ç»éªŒè¯è¿‡äº†");
      console.log(`æŸ¥çœ‹ï¼šhttps://bscscan.com/address/${contractAddress}#code`);
    } else {
      console.error("\nâŒ éªŒè¯å¤±è´¥:", error.message);
      process.exit(1);
    }
  }
}

main()
  .then(() => process.exit(0))
  .catch((error) => {
    console.error(error);
    process.exit(1);
  });
```

ä½¿ç”¨æ–¹æ³•ï¼š

```bash
# å…ˆéƒ¨ç½²
npx hardhat run scripts/deployReferral.js --network bsc

# å†éªŒè¯ï¼ˆå¯ä»¥ç­‰å‡ åˆ†é’Ÿåæ‰§è¡Œï¼‰
npx hardhat run scripts/verifyReferral.js --network bsc
```

## å››ã€å®Œæ•´å·¥ä½œæµç¨‹

### æ¨èæµç¨‹ï¼ˆæ–¹æ³• Bï¼‰

```bash
# 1. ç¼–è¯‘åˆçº¦
npx hardhat compile

# 2. éƒ¨ç½²å¹¶è‡ªåŠ¨éªŒè¯
npx hardhat run scripts/deployReferral.js --network bsc

# 3. æ£€æŸ¥ BscScan
# è®¿é—® https://bscscan.com/address/<åˆçº¦åœ°å€>#code
```

### åˆ†æ­¥æµç¨‹ï¼ˆæ–¹æ³• Aï¼‰

```bash
# 1. ç¼–è¯‘
npx hardhat compile

# 2. éƒ¨ç½²
npx hardhat run scripts/deployReferral.js --network bsc

# 3. è®°å½•åˆçº¦åœ°å€ï¼ˆä»è¾“å‡ºä¸­è·å–ï¼‰
# ä¾‹å¦‚ï¼š0x1234567890123456789012345678901234567890

# 4. ç­‰å¾… 1-2 åˆ†é’Ÿï¼ˆç¡®ä¿åŒºå—ç¡®è®¤ï¼‰

# 5. æ‰‹åŠ¨éªŒè¯
npx hardhat verify --network bsc \
  0x1234567890123456789012345678901234567890 \
  "0xF4d1cD67cD570aE5e78ae89Bf664A299DeEdEFC7"
```

## äº”ã€å¸¸è§é—®é¢˜æ’æŸ¥

### 1. é”™è¯¯ï¼šInvalid API Key

**åŸå› **ï¼š
- API Key æœªé…ç½®æˆ–é…ç½®é”™è¯¯
- ç¯å¢ƒå˜é‡æœªåŠ è½½

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æ£€æŸ¥ .env æ–‡ä»¶æ˜¯å¦å­˜åœ¨
cat .env

# æ£€æŸ¥ hardhat.config.js æ˜¯å¦æ­£ç¡®å¼•å…¥
grep "require.*dotenv" hardhat.config.js

# æµ‹è¯• API Key
curl "https://api.bscscan.com/api?module=contract&action=getabi&address=0x0000000000000000000000000000000000000000&apikey=ä½ çš„APIKEY"
```

### 2. é”™è¯¯ï¼šMore than 20 requests per second

**åŸå› **ï¼šAPI é™æµ

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# ç­‰å¾… 10-30 ç§’åé‡è¯•
sleep 30 && npx hardhat verify --network bsc <åœ°å€> <å‚æ•°>
```

### 3. é”™è¯¯ï¼šConstructor arguments error

**åŸå› **ï¼š
- æ„é€ å‡½æ•°å‚æ•°é”™è¯¯
- å‚æ•°é¡ºåºé”™è¯¯
- å‚æ•°ç±»å‹ä¸åŒ¹é…

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. æ£€æŸ¥åˆçº¦æ„é€ å‡½æ•°ï¼š
```solidity
// contracts/Referral.sol
constructor(address _rootAddress) {
    rootAddress = _rootAddress;
}
```

2. ç¡®ä¿å‚æ•°åŒ¹é…ï¼š
```bash
# æ­£ç¡®ï¼šåœ°å€ç”¨å¼•å·åŒ…è£¹
npx hardhat verify --network bsc <åœ°å€> "0xF4d1cD67cD570aE5e78ae89Bf664A299DeEdEFC7"

# é”™è¯¯ï¼šç¼ºå°‘å¼•å·
npx hardhat verify --network bsc <åœ°å€> 0xF4d1cD67cD570aE5e78ae89Bf664A299DeEdEFC7
```

3. ä½¿ç”¨å‚æ•°æ–‡ä»¶ï¼š
```javascript
// arguments.js
module.exports = [
  "0xF4d1cD67cD570aE5e78ae89Bf664A299DeEdEFC7"
];
```

```bash
npx hardhat verify --network bsc \
  --constructor-args arguments.js \
  <åˆçº¦åœ°å€>
```

### 4. é”™è¯¯ï¼šContract source code already verified

**åŸå› **ï¼šåˆçº¦å·²ç»éªŒè¯è¿‡

**è§£å†³æ–¹æ¡ˆ**ï¼š
- è¿™æ˜¯æ­£å¸¸æƒ…å†µï¼Œæ— éœ€é‡å¤éªŒè¯
- è®¿é—® BscScan æŸ¥çœ‹éªŒè¯ç»“æœ

### 5. é”™è¯¯ï¼šBytecode does not match

**åŸå› **ï¼š
- æœ¬åœ°ç¼–è¯‘çš„å­—èŠ‚ç ä¸é“¾ä¸Šä¸ä¸€è‡´
- Solidity ç‰ˆæœ¬ä¸åŒ¹é…
- ä¼˜åŒ–è®¾ç½®ä¸åŒ

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. æ£€æŸ¥ Solidity ç‰ˆæœ¬ï¼š
```javascript
// hardhat.config.js
module.exports = {
  solidity: {
    version: "0.8.28",  // ç¡®ä¿ä¸åˆçº¦ pragma ä¸€è‡´
    settings: {
      optimizer: {
        enabled: true,
        runs: 200  // ç¡®ä¿ä¸éƒ¨ç½²æ—¶ä¸€è‡´
      }
    }
  }
};
```

2. é‡æ–°ç¼–è¯‘ï¼š
```bash
npx hardhat clean
npx hardhat compile
```

3. é‡æ–°éƒ¨ç½²å’ŒéªŒè¯

### 6. ç½‘ç»œè¿æ¥é—®é¢˜

**ç—‡çŠ¶**ï¼šè¶…æ—¶æˆ–æ— å“åº”

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æ£€æŸ¥ç½‘ç»œé…ç½®
npx hardhat run scripts/checkNetwork.js --network bsc

# ä½¿ç”¨ä»£ç†ï¼ˆå¦‚æœåœ¨å—é™ç½‘ç»œï¼‰
export HTTP_PROXY=http://proxy:port
export HTTPS_PROXY=http://proxy:port
```

## å…­ã€éªŒè¯ç»“æœæ£€æŸ¥

### BscScan ç•Œé¢

éªŒè¯æˆåŠŸåï¼Œè®¿é—® `https://bscscan.com/address/<åˆçº¦åœ°å€>#code`ï¼Œåº”è¯¥çœ‹åˆ°ï¼š

1. âœ… **ç»¿è‰²å¯¹å‹¾**ï¼šContract Source Code Verified
2. **Compiler ä¿¡æ¯**ï¼šæ˜¾ç¤º Solidity ç‰ˆæœ¬å’Œä¼˜åŒ–è®¾ç½®
3. **Contract Source Code**ï¼šå¯ä»¥æŸ¥çœ‹å®Œæ•´æºä»£ç 
4. **Read Contract**ï¼šæŸ¥çœ‹çŠ¶æ€å˜é‡
5. **Write Contract**ï¼šè°ƒç”¨çŠ¶æ€æ”¹å˜å‡½æ•°

### å‘½ä»¤è¡Œç¡®è®¤

```bash
# éªŒè¯æˆåŠŸçš„è¾“å‡ºç¤ºä¾‹
Successfully submitted source code for contract
contracts/Referral.sol:Referral at 0x1234...
for verification on the block explorer. Waiting for verification result...

Successfully verified contract Referral on Etherscan.
https://bscscan.com/address/0x1234567890123456789012345678901234567890#code
```

## ä¸ƒã€æœ€ä½³å®è·µå»ºè®®

### 1. ä½¿ç”¨è‡ªåŠ¨åŒ–éªŒè¯ï¼ˆæ–¹æ³• Bï¼‰

**ä¼˜ç‚¹**ï¼š
- ä¸€æ¬¡æ€§å®Œæˆéƒ¨ç½²å’ŒéªŒè¯
- é¿å…é—å¿˜æˆ–å‚æ•°é”™è¯¯
- ç»Ÿä¸€çš„å·¥ä½œæµç¨‹

**å®ç°**ï¼šåœ¨æ‰€æœ‰éƒ¨ç½²è„šæœ¬ä¸­æ·»åŠ éªŒè¯é€»è¾‘

### 2. ç¯å¢ƒå˜é‡ç®¡ç†

```env
# .env
BSCSCAN_API_KEY=ä½ çš„å¯†é’¥
BSC_PRIVATE_KEY=éƒ¨ç½²é’±åŒ…ç§é’¥
BSC_RPC_URL=https://bsc-dataseed.binance.org/

# æµ‹è¯•ç½‘ï¼ˆå¯é€‰ï¼‰
BSCSCAN_TESTNET_API_KEY=æµ‹è¯•ç½‘å¯†é’¥
BSC_TESTNET_PRIVATE_KEY=æµ‹è¯•ç½‘ç§é’¥
```

### 3. è®°å½•éƒ¨ç½²ä¿¡æ¯

```javascript
// åœ¨éƒ¨ç½²è„šæœ¬ä¸­ä¿å­˜å®Œæ•´ä¿¡æ¯
const deploymentInfo = {
  network: hre.network.name,
  contractName: "Referral",
  address: contractAddress,
  deployer: deployer.address,
  constructorArgs: [rootAddress],
  txHash: referral.deploymentTransaction().hash,
  blockNumber: await ethers.provider.getBlockNumber(),
  timestamp: new Date().toISOString(),
  verified: false  // éªŒè¯æˆåŠŸåæ›´æ–°ä¸º true
};
```

### 4. CI/CD é›†æˆ

åœ¨éƒ¨ç½²æµæ°´çº¿ä¸­æ·»åŠ éªŒè¯æ­¥éª¤ï¼š

```yaml
# .github/workflows/deploy.yml
- name: Deploy to BSC
  run: npx hardhat run scripts/deployReferral.js --network bsc

- name: Verify on BscScan
  run: npx hardhat run scripts/verifyReferral.js --network bsc
  continue-on-error: true  # éªŒè¯å¤±è´¥ä¸ä¸­æ–­æµç¨‹
```

### 5. å¤šåˆçº¦æ‰¹é‡éªŒè¯

åˆ›å»º `scripts/verifyAll.js`ï¼š

```javascript
const contracts = [
  {
    name: "Referral",
    address: "0x123...",
    args: ["0xF4d1cD67cD570aE5e78ae89Bf664A299DeEdEFC7"]
  },
  {
    name: "SYI",
    address: "0x456...",
    args: ["0x789...", "0xabc..."]
  }
  // ... æ›´å¤šåˆçº¦
];

for (const contract of contracts) {
  console.log(`\nVerifying ${contract.name}...`);
  try {
    await hre.run("verify:verify", {
      address: contract.address,
      constructorArguments: contract.args,
    });
    console.log(`âœ… ${contract.name} verified`);
  } catch (error) {
    console.error(`âŒ ${contract.name} failed:`, error.message);
  }
  await new Promise(resolve => setTimeout(resolve, 2000));  // é¿å…é™æµ
}
```

## å…«ã€å‚è€ƒèµ„æº

- [Hardhat Verification Plugin æ–‡æ¡£](https://hardhat.org/hardhat-runner/plugins/nomicfoundation-hardhat-verify)
- [BscScan API æ–‡æ¡£](https://docs.bscscan.com/)
- [Hardhat é…ç½®æŒ‡å—](https://hardhat.org/config/)

## ä¹ã€å¿«é€Ÿå‚è€ƒ

### å¸¸ç”¨å‘½ä»¤

```bash
# éªŒè¯å•ä¸ªåˆçº¦
npx hardhat verify --network bsc <åœ°å€> <å‚æ•°1> <å‚æ•°2>

# ä½¿ç”¨å‚æ•°æ–‡ä»¶éªŒè¯
npx hardhat verify --network bsc --constructor-args args.js <åœ°å€>

# æŸ¥çœ‹ Hardhat ä»»åŠ¡åˆ—è¡¨
npx hardhat help verify

# æµ‹è¯•ç½‘éªŒè¯
npx hardhat verify --network bscTestnet <åœ°å€> <å‚æ•°>
```

### BscScan é“¾æ¥

- ä¸»ç½‘ï¼š`https://bscscan.com/address/<åœ°å€>#code`
- æµ‹è¯•ç½‘ï¼š`https://testnet.bscscan.com/address/<åœ°å€>#code`
